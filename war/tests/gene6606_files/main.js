Ext.namespace("Ext.ux.dd");Ext.ux.dd.GridDragDropRowOrder=Ext.extend(Ext.util.Observable,{copy:false,scrollable:false,constructor:function(b){if(b){Ext.apply(this,b)}this.addEvents({beforerowmove:true,afterrowmove:true,beforerowcopy:true,afterrowcopy:true,startDrag:true,endDrag:true});Ext.ux.dd.GridDragDropRowOrder.superclass.constructor.call(this)},init:function(b){this.grid=b;b.enableDragDrop=true;b.on({render:{fn:this.onGridRender,scope:this,single:true}})},onGridRender:function(c){var b=this;this.target=new Ext.dd.DropTarget(c.getEl(),{ddGroup:c.ddGroup||"GridDD",grid:c,gridDropTarget:this,notifyEnter:function(d,g,f){this.gridDropTarget.fireEvent("startDrag",this.gridDropTarget)},notifyDrop:function(p,n,k){if(this.currentRowEl){this.currentRowEl.removeClass("grid-row-insert-below");this.currentRowEl.removeClass("grid-row-insert-above")}var r=Ext.lib.Event.getTarget(n);var l=this.grid.getView().findRowIndex(r);if(l===false||l==k.rowIndex){this.gridDropTarget.fireEvent("endDrag",this.gridDropTarget);return false}if(this.gridDropTarget.fireEvent(b.copy?"beforerowcopy":"beforerowmove",this.gridDropTarget,k.rowIndex,l,k.selections,123)===false){this.gridDropTarget.fireEvent("endDrag",this.gridDropTarget);return false}var f=this.grid.getStore();var d=new Array();var q=f.data.keys;for(var o in q){for(var h=0;h<k.selections.length;h++){if(q[o]==k.selections[h].id){if(l==o){this.gridDropTarget.fireEvent("endDrag",this.gridDropTarget);return false}d.push(k.selections[h])}}}if(l>k.rowIndex&&this.rowPosition<0){l--}if(l<k.rowIndex&&this.rowPosition>0){l++}if(l>k.rowIndex&&k.selections.length>1){l=l-(k.selections.length-1)}if(l==k.rowIndex){this.gridDropTarget.fireEvent("endDrag",this.gridDropTarget);return false}if(!b.copy){for(var h=0;h<k.selections.length;h++){f.remove(f.getById(k.selections[h].id))}}for(var h=d.length-1;h>=0;h--){var s=l;f.insert(s,d[h])}var g=this.grid.getSelectionModel();if(g){g.selectRecords(k.selections)}this.gridDropTarget.fireEvent(b.copy?"afterrowcopy":"afterrowmove",this.gridDropTarget,k.rowIndex,l,k.selections);this.gridDropTarget.fireEvent("endDrag",this.gridDropTarget);return true},notifyOver:function(r,o,l){var w=Ext.lib.Event.getTarget(o);var n=this.grid.getView().findRowIndex(w);var f=this.grid.getStore();var u=f.data.keys;for(var q in u){for(var k=0;k<l.selections.length;k++){if(u[q]==l.selections[k].id){if(n==q){if(this.currentRowEl){this.currentRowEl.removeClass("grid-row-insert-below");this.currentRowEl.removeClass("grid-row-insert-above")}return this.dropNotAllowed}}}}if(n<0||n===false){this.currentRowEl.removeClass("grid-row-insert-above");return this.dropNotAllowed}try{var p=this.grid.getView().getRow(n);var h=new Ext.Element(p).getY()-this.grid.getView().scroller.dom.scrollTop;var d=p.offsetHeight;this.rowPosition=o.getPageY()-h-(d/2);if(this.currentRowEl){this.currentRowEl.removeClass("grid-row-insert-below");this.currentRowEl.removeClass("grid-row-insert-above")}if(this.rowPosition>0){this.currentRowEl=new Ext.Element(p);this.currentRowEl.addClass("grid-row-insert-below")}else{if(n-1>=0){var s=this.grid.getView().getRow(n-1);this.currentRowEl=new Ext.Element(s);this.currentRowEl.addClass("grid-row-insert-below")}else{this.currentRowEl.addClass("grid-row-insert-above")}}}catch(g){console.warn(g);n=false}return(n===false)?this.dropNotAllowed:this.dropAllowed},notifyOut:function(d,g,f){if(this.currentRowEl){this.currentRowEl.removeClass("grid-row-insert-above");this.currentRowEl.removeClass("grid-row-insert-below")}}});if(this.targetCfg){Ext.apply(this.target,this.targetCfg)}if(this.scrollable){Ext.dd.ScrollManager.register(c.getView().getEditorParent());c.on({beforedestroy:this.onBeforeDestroy,scope:this,single:true})}},getTarget:function(){return this.target},getGrid:function(){return this.grid},getCopy:function(){return this.copy?true:false},setCopy:function(c){this.copy=c?true:false},onBeforeDestroy:function(b){Ext.dd.ScrollManager.unregister(b.getView().getEditorParent())}});Ext.ns("Ext.ux.form");Ext.ux.form.XCheckbox=Ext.extend(Ext.form.Checkbox,{offCls:"xcheckbox-off",onCls:"xcheckbox-on",disabledClass:"xcheckbox-disabled",submitOffValue:"false",submitOnValue:"true",checked:false,onRender:function(d){Ext.ux.form.XCheckbox.superclass.onRender.apply(this,arguments);var b=this.el.dom.tabIndex;var e=this.el.dom.id;this.el.remove();this.el=d.createChild({tag:"input",type:"hidden",name:this.name,id:e});this.updateHidden();this.wrap.replaceClass("x-form-check-wrap","xcheckbox-wrap");this.cbEl=this.wrap.createChild({tag:"a",href:"#",cls:this.checked?this.onCls:this.offCls});var c=this.wrap.down("label");if(c){this.wrap.appendChild(c)}if(this.tooltip){this.cbEl.set({qtip:this.tooltip})}this.wrap.on({click:{scope:this,fn:this.onClick,delegate:"a"}});this.wrap.on({keyup:{scope:this,fn:this.onClick,delegate:"a"}});this.cbEl.dom.tabIndex=b},onClick:function(b){if(this.disabled||this.readOnly){return}if(!b.isNavKeyPress()){this.setValue(!this.checked)}},onDisable:function(){this.cbEl.addClass(this.disabledClass);this.el.dom.disabled=true},onEnable:function(){this.cbEl.removeClass(this.disabledClass);this.el.dom.disabled=false},setValue:function(b){if("string"==typeof b){this.checked=b===this.submitOnValue}else{this.checked=!(!b)}if(this.rendered&&this.cbEl){this.updateHidden();this.cbEl.removeClass([this.offCls,this.onCls]);this.cbEl.addClass(this.checked?this.onCls:this.offCls)}this.fireEvent("check",this,this.checked)},updateHidden:function(){this.el.dom.value=this.checked?this.submitOnValue:this.submitOffValue},getValue:function(){return this.checked}});Ext.reg("xcheckbox",Ext.ux.form.XCheckbox);Ext.ns("Ext.ux.tot2ivn");Ext.ux.tot2ivn.VrTabPanel=Ext.extend(Ext.Panel,{border:true,tabWidth:130,tabMarginTop:15,deferredRender:true,minTabWidth:30,resizeTabs:false,enableTabScroll:false,scrollIncrement:0,scrollRepeatInterval:400,scrollDuration:0.35,animScroll:true,tabPosition:"top",baseCls:"x-tab-panel x-tot2ivn-vr-tab-panel",autoTabs:false,autoTabSelector:"div.x-tab",activeTab:undefined,tabMargin:2,plain:false,wheelIncrement:20,idDelimiter:"__",itemCls:"x-tab-item",elements:"body",headerAsText:false,frame:false,hideBorders:true,initComponent:function(){this.frame=false;Ext.ux.tot2ivn.VrTabPanel.superclass.initComponent.call(this);if(this.border){this.style="border: 1px solid #99BBE8; "+this.style}this.addEvents("beforetabchange","tabchange","contextmenu");this.setLayout(new Ext.layout.CardLayout(Ext.apply({layoutOnCardChange:this.layoutOnTabChange,deferredRender:this.deferredRender},this.layoutConfig)));if(this.tabPosition=="top"){this.elements+=",header";this.stripTarget="header"}else{this.elements+=",footer";this.stripTarget="footer"}if(!this.stack){this.stack=Ext.ux.tot2ivn.VrTabPanel.AccessStack()}this.initItems()},onRender:function(d,b){Ext.ux.tot2ivn.VrTabPanel.superclass.onRender.call(this,d,b);if(this.plain){var g=this.tabPosition=="top"?"header":"footer";this[g].addClass("x-tab-panel-"+g+"-plain")}var c=this[this.stripTarget];this.stripWrap=c.createChild({cls:"x-tab-strip-wrap x-tot2ivn-vr-tab-strip-wrap",cn:{style:"margin-top: "+this.tabMarginTop+"px;",tag:"ul",cls:"x-tab-strip x-tot2ivn-vr-tab-strip x-tab-strip-"+this.tabPosition+" x-tot2ivn-vr-tab-strip-"+this.tabPosition}});var f=(this.tabPosition=="bottom"?this.stripWrap:null);c.createChild({cls:"x-tab-strip-spacer x-tot2ivn-vr-tab-strip-spacer"},f);this.strip=new Ext.Element(this.stripWrap.dom.firstChild);this.strip.createChild({cls:"x-clear"});this.body.addClass("x-tab-panel-body-"+this.tabPosition);if(!this.itemTpl){var e=new Ext.Template('<li class="{cls} x-tot2ivn-vr-tab-strip-title" id="{id}"><a class="x-tab-strip-close"></a>','<a class="x-tab-right" href="#"><em class="x-tab-left">','<span class="x-tab-strip-inner"><span class="x-tab-strip-text x-tot2ivn-vr-tab-strip-text {iconCls}">{text}</span></span>',"</em></a></li>");e.disableFormats=true;e.compile();Ext.ux.tot2ivn.VrTabPanel.prototype.itemTpl=e}this.items.each(this.initTab,this)},afterRender:function(){Ext.ux.tot2ivn.VrTabPanel.superclass.afterRender.call(this);if(this.autoTabs){this.readTabs(false)}if(this.activeTab!==undefined){var b=Ext.isObject(this.activeTab)?this.activeTab:this.items.get(this.activeTab);delete this.activeTab;this.setActiveTab(b)}},initEvents:function(){Ext.ux.tot2ivn.VrTabPanel.superclass.initEvents.call(this);this.mon(this.strip,{scope:this,mousedown:this.onStripMouseDown,contextmenu:this.onStripContextMenu});if(this.enableTabScroll){this.mon(this.strip,"mousewheel",this.onWheel,this)}},findTargets:function(d){var c=null,b=d.getTarget("li:not(.x-tab-edge)",this.strip);if(b){c=this.getComponent(b.id.split(this.idDelimiter)[1]);if(c.disabled){return{close:null,item:null,el:null}}}return{close:d.getTarget(".x-tab-strip-close",this.strip),item:c,el:b}},onStripMouseDown:function(c){if(c.button!==0){return}c.preventDefault();var b=this.findTargets(c);if(b.close){if(b.item.fireEvent("beforeclose",b.item)!==false){b.item.fireEvent("close",b.item);this.remove(b.item)}return}if(b.item&&b.item!=this.activeTab){this.setActiveTab(b.item)}},onStripContextMenu:function(c){c.preventDefault();var b=this.findTargets(c);if(b.item){this.fireEvent("contextmenu",this,b.item,c)}},readTabs:function(e){if(e===true){this.items.each(function(h){this.remove(h)},this)}var d=this.el.query(this.autoTabSelector);for(var c=0,b=d.length;c<b;c++){var f=d[c],g=f.getAttribute("title");f.removeAttribute("title");this.add({title:g,contentEl:f})}},initTab:function(e,c){var f=this.strip.dom.childNodes[c],g=this.getTemplateArgs(e),d=f?this.itemTpl.insertBefore(f,g):this.itemTpl.append(this.strip,g),b="x-tab-strip-over",h=Ext.get(d);h.hover(function(){if(!e.disabled){h.addClass(b)}},function(){h.removeClass(b)});if(e.tabTip){h.child("span.x-tab-strip-text",true).qtip=e.tabTip}e.tabEl=d;h.select("a").on("click",function(i){if(!i.getPageX()){this.onStripMouseDown(i)}},this,{preventDefault:true});e.on({scope:this,disable:this.onItemDisabled,enable:this.onItemEnabled,titlechange:this.onItemTitleChanged,iconchange:this.onItemIconChanged,beforeshow:this.onBeforeShowItem})},getTemplateArgs:function(c){var b=c.closable?"x-tab-strip-closable":"";if(c.disabled){b+=" x-item-disabled"}if(c.iconCls){b+=" x-tab-with-icon"}if(c.tabCls){b+=" "+c.tabCls}return{id:this.id+this.idDelimiter+c.getItemId(),text:c.title,cls:b,iconCls:c.iconCls||""}},onAdd:function(d){Ext.ux.tot2ivn.VrTabPanel.superclass.onAdd.call(this,d);if(this.rendered){var b=this.items;this.initTab(d,b.indexOf(d));if(b.getCount()==1){this.syncSize()}this.delegateUpdates()}},onBeforeAdd:function(c){var b=c.events?(this.items.containsKey(c.getItemId())?c:null):this.items.get(c);if(b){this.setActiveTab(c);return false}Ext.ux.tot2ivn.VrTabPanel.superclass.onBeforeAdd.apply(this,arguments);var d=c.elements;c.elements=d?d.replace(",header",""):d;c.border=(c.border===true)},onRemove:function(e){var d=Ext.get(e.tabEl);if(d){d.select("a").removeAllListeners();Ext.destroy(d)}Ext.ux.tot2ivn.VrTabPanel.superclass.onRemove.call(this,e);this.stack.remove(e);delete e.tabEl;e.un("disable",this.onItemDisabled,this);e.un("enable",this.onItemEnabled,this);e.un("titlechange",this.onItemTitleChanged,this);e.un("iconchange",this.onItemIconChanged,this);e.un("beforeshow",this.onBeforeShowItem,this);if(e==this.activeTab){var b=this.stack.next();if(b){this.setActiveTab(b)}else{if(this.items.getCount()>0){this.setActiveTab(0)}else{this.setActiveTab(null)}}}if(!this.destroying){this.delegateUpdates()}},onBeforeShowItem:function(b){if(b!=this.activeTab){this.setActiveTab(b);return false}},onItemDisabled:function(c){var b=this.getTabEl(c);if(b){Ext.fly(b).addClass("x-item-disabled")}this.stack.remove(c)},onItemEnabled:function(c){var b=this.getTabEl(c);if(b){Ext.fly(b).removeClass("x-item-disabled")}},onItemTitleChanged:function(c){var b=this.getTabEl(c);if(b){Ext.fly(b).child("span.x-tab-strip-text",true).innerHTML=c.title}},onItemIconChanged:function(e,b,d){var c=this.getTabEl(e);if(c){c=Ext.get(c);c.child("span.x-tab-strip-text").replaceClass(d,b);c[Ext.isEmpty(b)?"removeClass":"addClass"]("x-tab-with-icon")}},getTabEl:function(b){var d=this.getComponent(b);return d?d.tabEl:null},onResize:function(){this.header.setStyle("display","none");Ext.ux.tot2ivn.VrTabPanel.superclass.onResize.apply(this,arguments);this.header.setStyle("display","block");this.delegateUpdates()},beginUpdate:function(){this.suspendUpdates=true},endUpdate:function(){this.suspendUpdates=false;this.delegateUpdates()},hideTabStripItem:function(c){c=this.getComponent(c);var b=this.getTabEl(c);if(b){b.style.display="none";this.delegateUpdates()}this.stack.remove(c)},unhideTabStripItem:function(c){c=this.getComponent(c);var b=this.getTabEl(c);if(b){b.style.display="";this.delegateUpdates()}},delegateUpdates:function(){if(this.suspendUpdates){return}if(this.resizeTabs&&this.rendered){}if(this.enableTabScroll&&this.rendered){}this.adjustBodySize()},adjustBodySize:function(){var b=this.tabWidth;if(Ext.isNumber(b)){var d=this.body,e=d.getWidth(),c=e-b;this.adjustBodyWidth(b);if(c){d.setWidth(c)}}this.doLayout()},autoSizeTabs:function(){var h=this.items.length,c=this.tabPosition!="bottom"?"header":"footer",d=this[c].dom.offsetWidth,b=this[c].dom.clientWidth;if(!this.resizeTabs||h<1||!b){return}var l=Math.max(Math.min(Math.floor((b-4)/h)-this.tabMargin,this.tabWidth),this.minTabWidth);this.lastTabWidth=l;var o=this.strip.query("li:not(.x-tab-edge)");for(var f=0,k=o.length;f<k;f++){var n=o[f],p=Ext.fly(n).child(".x-tab-strip-inner",true),g=n.offsetWidth,e=p.offsetWidth;p.style.width=(l-(g-e))+"px"}},adjustBodyWidth:function(b){if(this.header){this.header.setWidth(b)}if(this.footer){this.footer.setWidth(b)}return b},setActiveTab:function(d){d=this.getComponent(d);if(this.fireEvent("beforetabchange",this,d,this.activeTab)===false){return}if(!this.rendered){this.activeTab=d;return}if(this.activeTab!=d){if(this.activeTab){var b=this.getTabEl(this.activeTab);if(b){Ext.fly(b).removeClass("x-tab-strip-active")}}if(d){var c=this.getTabEl(d);Ext.fly(c).addClass("x-tab-strip-active");this.activeTab=d;this.stack.add(d);this.layout.setActiveItem(d);if(this.scrolling){this.scrollToTab(d,this.animScroll)}}this.fireEvent("tabchange",this,d)}},getActiveTab:function(){return this.activeTab||null},getItem:function(b){return this.getComponent(b)},autoScrollTabs:function(){this.pos=this.tabPosition=="bottom"?this.footer:this.header;var h=this.items.length,e=this.pos.dom.offsetHeight,d=this.pos.dom.clientHeight,g=this.stripWrap,f=g.dom,c=f.offsetHeight,i=this.getScrollPos(),b=c+i+10;if(!this.enableTabScroll||h<1||c<20){return}if(b<=d){f.scrollTop=0;g.setHeight(d);if(this.scrolling){this.scrolling=false;this.pos.removeClass("x-tab-scrolling");this.scrollTop.hide();this.scrollBottom.hide();if(Ext.isAir||Ext.isWebKit){}}}else{if(!this.scrolling){this.pos.addClass("x-tab-scrolling");if(Ext.isAir||Ext.isWebKit){}}d-=g.getMargins("tb");g.setHeight(d>20?d:20);if(!this.scrolling){if(!this.scrollTop){this.createScrollers()}else{this.scrollTop.show();this.scrollBottom.show()}}this.scrolling=true;if(i>(b-d)){f.scrollTop=b-d}else{this.scrollToTab(this.activeTab,false)}this.updateScrollButtons()}},createScrollers:function(){this.header.addClass("x-tab-scrolling-"+this.tabPosition);var d=this.tabWidth,c=this.stripWrap;c.setWidth(d);c.applyStyles({margin:"0"});var b=this.header.insertFirst({cls:"x-tab-scroller-top"});b.setWidth(d);b.addClassOnOver("x-tab-scroller-top-over");this.leftRepeater=new Ext.util.ClickRepeater(b,{interval:this.scrollRepeatInterval,handler:this.onscrollTop,scope:this});this.scrollTop=b;var e=this.stripWrap.insertSibling({cls:"x-tab-scroller-bottom"},"after");e.setWidth(d);e.addClassOnOver("x-tab-scroller-bottom-over");this.rightRepeater=new Ext.util.ClickRepeater(e,{interval:this.scrollRepeatInterval,handler:this.onscrollBottom,scope:this});this.scrollBottom=e},getScrollHeight:function(){return this.getScrollPos()},getScrollPos:function(){return parseInt(this.stripWrap.dom.scrollTop,10)||0},getScrollArea:function(){return parseInt(this.stripWrap.dom.clientHeight,10)||0},getScrollAnim:function(){return{duration:this.scrollDuration,callback:this.updateScrollButtons,scope:this}},getScrollIncrement:function(){return this.scrollIncrement||(this.resizeTabs?this.lastTabWidth+2:100)},scrollToTab:function(f,c){if(!f){return}var d=this.getTabEl(f),h=this.getScrollPos(),e=this.getScrollArea(),g=Ext.fly(d).getOffsetsTo(this.stripWrap)[0]+h,b=g+d.offsetHeight;if(g<h){this.scrollTo(g,c)}else{if(b>(h+e)){this.scrollTo(b-e,c)}}},scrollTo:function(c,b){this.stripWrap.scrollTo("top",c,b?this.getScrollAnim():false);if(!b){this.updateScrollButtons()}},onWheel:function(g){var h=g.getWheelDelta()*this.wheelIncrement*-1;g.stopEvent();var i=this.getScrollPos(),f=i+h,b=this.getScrollHeight()-this.getScrollArea();var c=Math.max(0,Math.min(b,f));if(c!=i){this.scrollTo(c,false)}},onscrollBottom:function(){var b=this.getScrollHeight()-this.getScrollArea(),d=this.getScrollPos(),c=Math.min(b,d+this.getScrollIncrement());if(c!=d){this.scrollTo(c,this.animScroll)}},onscrollTop:function(){var c=this.getScrollPos(),b=Math.max(0,c-this.getScrollIncrement());if(b!=c){this.scrollTo(b,this.animScroll)}},updateScrollButtons:function(){var b=this.getScrollPos();this.scrollTop[b===0?"addClass":"removeClass"]("x-tab-scroller-left-disabled");this.scrollBottom[b>=(this.getScrollHeight()-this.getScrollArea())?"addClass":"removeClass"]("x-tab-scroller-right-disabled")},beforeDestroy:function(){Ext.destroy(this.leftRepeater,this.rightRepeater);this.deleteMembers("strip","edge","scrollTop","scrollBottom","stripWrap");this.activeTab=null;Ext.ux.tot2ivn.VrTabPanel.superclass.beforeDestroy.apply(this)}});Ext.reg("vrtabpanel",Ext.ux.tot2ivn.VrTabPanel);Ext.ux.tot2ivn.VrTabPanel.prototype.activate=Ext.ux.tot2ivn.VrTabPanel.prototype.setActiveTab;Ext.ux.tot2ivn.VrTabPanel.AccessStack=function(){var b=[];return{add:function(c){b.push(c);if(b.length>10){b.shift()}},remove:function(f){var e=[];for(var d=0,c=b.length;d<c;d++){if(b[d]!=f){e.push(b[d])}}b=e},next:function(){return b.pop()}}};Number.prototype.commify=function(){nStr=this+"";x=nStr.split(".");x1=x[0];x2=x.length>1?"."+x[1]:"";var b=/(\d+)(\d{3})/;while(b.test(x1)){x1=x1.replace(b,"$1,$2")}return x1+x2};Number.prototype.shorten=function(){var e=this.valueOf();var b=(e<0);if(b){e=-e}var d=["","K","M","G","T","P","E","Z","Y"];var f="";for(var c=0;c<d.length;c++){if(e<1000){f=d[c];break}e/=1000}return(b?"-":"")+Number(e).toFixed(e<10&&f!=""?1:0)+f};if((typeof Range!=="undefined")&&!Range.prototype.createContextualFragment){Range.prototype.createContextualFragment=function(b){var d=document.createDocumentFragment(),c=document.createElement("div");d.appendChild(c);c.outerHTML=b;return d}}var cbSplit;if(!cbSplit){cbSplit=function(k,g,f){if(Object.prototype.toString.call(g)!=="[object RegExp]"){return cbSplit._nativeSplit.call(k,g,f)}var d=[],b=0,e=(g.ignoreCase?"i":"")+(g.multiline?"m":"")+(g.sticky?"y":""),g=RegExp(g.source,e+"g"),c,h,i,l;k=k+"";if(!cbSplit._compliantExecNpcg){c=RegExp("^"+g.source+"$(?!\\s)",e)}if(f===undefined||+f<0){f=Infinity}else{f=Math.floor(+f);if(!f){return[]}}while(h=g.exec(k)){i=h.index+h[0].length;if(i>b){d.push(k.slice(b,h.index));if(!cbSplit._compliantExecNpcg&&h.length>1){h[0].replace(c,function(){for(var n=1;n<arguments.length-2;n++){if(arguments[n]===undefined){h[n]=undefined}}})}if(h.length>1&&h.index<k.length){Array.prototype.push.apply(d,h.slice(1))}l=h[0].length;b=i;if(d.length>=f){break}}if(g.lastIndex===h.index){g.lastIndex++}}if(b===k.length){if(l||!g.test("")){d.push("")}}else{d.push(k.slice(b))}return d.length>f?d.slice(0,f):d};cbSplit._compliantExecNpcg=/()??/.exec("")[1]===undefined;cbSplit._nativeSplit=String.prototype.split}String.prototype.trimToPix=function(c){var b=this;var d=this;if(b.visualLength()>c){d+="...";while(d.visualLength()>c){b=b.substring(0,b.length-1);d=b+"..."}}return d};String.prototype.trim=function(){return this.replace(/^\s*/,"").replace(/\s*$/,"")};Ext.QuickTips.init();Ext.form.Field.prototype.msgTarget="title";Ext.ux.NCBI="http://www.ncbi.nlm.nih.gov";Ext.BLANK_IMAGE_URL="/core/extjs/ext-3.2.1/resources/images/default/s.gif";Ext.SSL_SECURE_URL="/core/extjs/ext-3.2.1/resources/images/default/s.gif";Ext.namespace("Ext.ux");Ext.ux.clone=function(e){if(!e||"object"!==typeof e){return e}if("function"===typeof e.clone){return e.clone()}var f="[object Array]"===Object.prototype.toString.call(e)?[]:{};var d,b;for(d in e){if(e.hasOwnProperty(d)){b=e[d];if(b&&"object"===typeof b){f[d]=Ext.ux.clone(b)}else{f[d]=b}}}return f};Ext.namespace("Ext.ux.layout");Ext.ux.layout.RowFitLayout=Ext.extend(Ext.layout.ContainerLayout,{monitorResize:true,trackChildEvents:["collapse","expand","hide","show"],renderAll:function(b,c){Ext.ux.layout.RowFitLayout.superclass.renderAll.apply(this,arguments);b.on("add",this.containerListener);b.on("remove",this.containerListener)},renderItem:function(g,b,e){Ext.ux.layout.RowFitLayout.superclass.renderItem.apply(this,arguments);for(var d=0,f=this.trackChildEvents.length;d<f;d++){g.on(this.trackChildEvents[d],this.itemListener)}g.animCollapse=false;g.rowFit={hasAbsHeight:false,relHeight:0,calcRelHeight:0,calcAbsHeight:0};if(g.height){if(typeof g.height=="string"&&g.height.indexOf("%")){g.rowFit.relHeight=parseInt(g.height)}else{g.setHeight(g.height);g.rowFit.hasAbsHeight=true}}},onLayout:function(h,k){Ext.ux.layout.RowFitLayout.superclass.onLayout.call(this,h,k);if(this.container.collapsed||!h.items||!h.items.length){return}var d=0,q=0,o=1,l=[],r=0;for(var f=0,b=h.items.length;f<b;f++){var p=h.items.itemAt(f);if(!p.isVisible()){continue}if(p.collapsed){d+=p.getFrameHeight()}else{if(p.rowFit.hasAbsHeight){d+=p.height}else{if(!p.rowFit.relHeight){r++}else{q+=p.rowFit.relHeight}l.push(p)}}}if(r==0&&q!=100){o=100/q}var t=k.getStyleSize().height-d,e=t;while(l.length){var p=l.shift(),g=p.rowFit.relHeight*o,s=0;if(!g){g=(100-q)/r}if(!l.length){s=e}else{s=Math.round(t*g/100)}if(s<0){s=0}p.rowFit.calcAbsHeight=s;p.rowFit.calcRelHeight=g;p.setHeight(s);e-=s}},itemListener:function(b){b.ownerCt.doLayout()},containerListener:function(b){b.doLayout()}});if(Ext.SplitBar.BasicLayoutAdapter){Ext.ux.layout.RowFitLayout.SplitAdapter=function(d){if(d&&d.el.dom.nextSibling){var c=Ext.getCmp(d.el.dom.nextSibling.id),b=Ext.getCmp(d.resizingEl.id);if(c){d.maxSize=(b.height||b.rowFit.calcAbsHeight)+c.getInnerHeight()-1}d.minSize=b.getFrameHeight()+1}};Ext.extend(Ext.ux.layout.RowFitLayout.SplitAdapter,Ext.SplitBar.BasicLayoutAdapter,{setElementSize:function(g,h,c){var f=Ext.getCmp(g.resizingEl.id);if(!f||f.collapsed||!f.isVisible()){return}if(f.rowFit.hasAbsHeight){f.setHeight(h)}else{if(g.el.dom.nextSibling){var e=Ext.getCmp(g.el.dom.nextSibling.id),n=h-f.rowFit.calcAbsHeight,d=e.rowFit,l=f.rowFit,i=l.calcRelHeight/l.calcAbsHeight,k=i*n;l.relHeight=l.calcRelHeight+k;if(d.hasAbsHeight){var b=e.height-n;e.height=b;e.setHeight(b)}else{d.relHeight=d.calcRelHeight-k}}}f.ownerCt.doLayout()}})}Ext.Container.LAYOUTS["row-fit"]=Ext.ux.layout.RowFitLayout;Ext.ux.AreObjectsEqual=function(e,d){var c=Ext.util.JSON.encode(e);var b=Ext.util.JSON.encode(d);return c==b};Ext.lib.Event.resolveTextNode=Ext.isGecko?function(c){if(!c){return}var b=HTMLElement.prototype.toString.call(c);if(b=="[xpconnect wrapped native prototype]"||b=="[object XULElement]"){return}return c.nodeType==3?c.parentNode:c}:function(b){return b&&b.nodeType==3?b.parentNode:b};Ext.namespace("Ext.ux.plugin");Ext.ux.plugin.triggerfieldTooltip=function(b){Ext.apply(this,b)};Ext.extend(Ext.ux.plugin.triggerfieldTooltip,Ext.util.Observable,{init:function(b){this.component=b;this.component.on("render",this.onRender,this);this.component.initList=this.component.initList.createSequence(function(){var c=this.innerList.dom.children;for(var d=0;d<c.length;++d){Ext.QuickTips.register(Ext.apply({target:c[d]},this.getItemToolTip(d)))}},this.component)},onRender:function(){if(this.component.tooltip){if(typeof this.component.tooltip=="object"){Ext.QuickTips.register(Ext.apply({target:this.component.el},this.component.tooltip));if(this.component.label&&this.component.label.dom){Ext.QuickTips.register(Ext.apply({target:this.component.label.dom},this.component.tooltip))}}else{this.component.trigger.dom[this.component.tooltipType]=this.component.tooltip}}}});Ext.ux.StickyToolTipsMgr=function(){var e={};var c=[];var d=null;var b=function(h,g){return(!h._lastAccess||h._lastAccess<g._lastAccess)?-1:1};var f=function(){var k=c,g=k.length;if(g>0){k.sort(b);var h=k[0].manager.zseed;for(var l=0;l<g;l++){var n=k[l];if(n&&!n.hidden){n.getEl().setZIndex(h+(l*10))}}}};return{zseed:7000,register:function(g){e[g.id]=g;c.push(g)},clear:function(){Ext.each(c,function(g){delete e[g.id];g.destroy();g.remove()});c=[];e={};d=null},unregister:function(g){delete e[g.id];c.remove(g)},get:function(g){return typeof g=="object"?g:e[g]},bringToFront:function(g){g=this.get(g);if(g!=d){g._lastAccess=new Date().getTime();f();return true}return false},sendToBack:function(g){g=this.get(g);g._lastAccess=-(new Date().getTime());f();return g},each:function(h,g){for(var i in e){if(e[i]&&typeof e[i]!="function"){if(h.call(g||e[i],e[i])===false){return}}}}}};Ext.ux.StickyToolTip=Ext.extend(Ext.ToolTip,{initComponent:function(){this.autoHide=true;this.closable=false;this.pinned=false;this.draggable=true;Ext.ux.StickyToolTip.superclass.initComponent.call(this);if(!this.title){this.elements+=",header"}this.addEvents({pin:true,unpin:true});if(this.target){this.target.on("click",this.onTargetClick,this)}},afterRender:function(){Ext.ux.StickyToolTip.superclass.afterRender.call(this);this.addTool({id:"pin",handler:this.toggelPin,scope:this,hidden:true},{id:"unpin",handler:this.toggelPin,scope:this});this.standardZIndex=this.getEl().getZIndex();this.getEl().on("click",this.onMouseClick,this);this.getEl().on("click",this.onMouseUp,this)},onTargetClick:function(b){this.dontShow=true},onMouseClick:function(b){if(this.manager){this.manager.bringToFront(this)}},onMouseUp:function(b){},toggelPin:function(d,c,b){if(!this.pinned){b.tools.pin.show();b.tools.unpin.hide();this.fireEvent("pin",this)}else{b.tools.pin.hide();b.tools.unpin.show();this.fireEvent("unpin",this)}this.pinned=!this.pinned},isPinned:function(){return this.pinned},onTargetOut:function(b){if(this.disabled||b.within(this.target.dom,true)){return}this.dontShow=true;(function(c){if(this.isInsideTootTip(c)){this.clearTimer("dismiss");this.autoHide=false;this.getEl().on("mouseout",this.onMouseOut,this);return}if(this.autoHide!==false){this.delayHide()}}).defer(100,this,[b])},onTargetOver:function(b){delete this.dontShow;Ext.ux.StickyToolTip.superclass.onTargetOver.call(this,b)},hide:function(){this.dontShow=true;if(this.getEl().dom){Ext.ux.StickyToolTip.superclass.hide.call(this)}},show:function(){if(!this.dontShow){Ext.ux.StickyToolTip.superclass.show.call(this);this.keepInArea()}},onEnable:function(){if(!this.dontShow){Ext.ux.StickyToolTip.superclass.onEnable.call(this)}},onDocMouseDown:function(b){if(this.pinned){return}if(!this.isInsideTootTip(b)){this.hide()}Ext.ux.StickyToolTip.superclass.onDocMouseDown.call(this,b)},onMouseOut:function(b){if(this.pinned||this.isInsideTootTip(b)){return}this.getEl().un("mouseout",this.onMouseOut,this);this.autoHide=true;this.clearTimer("show");if(this.autoHide!==false){this.delayHide()}},initDraggable:function(){Ext.ux.StickyToolTip.superclass.initDraggable.call(this);if(this.dd){this.dd.startDrag=this.dd.startDrag.createSequence(function(){this.getEl().setZIndex(this.standardZIndex)},this);this.dd.alignElWithMouse=this.dd.alignElWithMouse.createInterceptor(function(b,d,c){return b!==null},this)}},isInsideTootTip:function(f){var c=this.getEl();if(!c||!c.dom){return false}var d=f.getXY();var b=c.getX();var g=c.getY();if((d[0]>b&&d[0]<b+this.getInnerWidth())&&(d[1]>g&&d[1]<g+this.getInnerHeight()+20)){return true}return false},onShow:function(){Ext.ux.StickyToolTip.superclass.onShow.call(this);if(this.manager){this.manager.register(this);this.manager.bringToFront(this)}},onHide:function(){if(this.manager){this.manager.unregister(this)}Ext.ux.StickyToolTip.superclass.onHide.call(this);this.destroy()},onDestroy:function(){if(this.target){this.target.un("click",this.onTargetClick,this)}var b=this.getEl();if(b){b.un("mouseout",this.onMouseOut,this)}Ext.ux.StickyToolTip.superclass.onDestroy.call(this)},doAutoWidth:function(e){e=e||0;var f=this.body.getTextWidth();if(this.title){var c=this.header.child("span").getTextWidth(this.title);var b=0;for(var d in this.tools){b+=1}c+=(b-1)*15;f=Math.max(f,c)}f+=this.getFrameWidth()+this.body.getPadding("lr")+e;this.setWidth(f.constrain(this.minWidth,this.maxWidth));if(Ext.isIE7&&!this.repainted){this.el.repaint();this.repainted=true}},keepInArea:function(){if(this.keepArea){var c=this.getEl().getXY();var b=this.getEl().getWidth();if(c[0]+b>this.keepArea.x+this.keepArea.width){this.setPagePosition(c[0]-(c[0]+b-(this.keepArea.x+this.keepArea.width))-4,c[1])}}},addTool:function(){if(!this.rendered){if(!this.tools){this.tools=[]}Ext.each(arguments,function(i){this.tools.push(i)},this);return}if(!this[this.toolTarget]){return}if(!this.ttoolTemplate){var g=new Ext.Template('<div class="x-tool xsv-left-align x-tool-{id}">&#160;</div>');g.disableFormats=true;g.compile();Ext.ux.StickyToolTip.prototype.ttoolTemplate=g}for(var f=0,d=arguments,c=d.length;f<c;f++){var b=d[f];if(!this.tools[b.id]){var h="x-tool-"+b.id+"-over";var e=this.ttoolTemplate.insertBefore(this[this.toolTarget],b,true);this.tools[b.id]=e;e.enableDisplayMode("block");this.mon(e,"click",this.createToolHandler(e,b,h,this));if(b.on){this.mon(e,b.on)}if(b.hidden){e.hide()}if(b.qtip){if(Ext.isObject(b.qtip)){Ext.QuickTips.register(Ext.apply({target:e.id},b.qtip))}else{e.dom.qtip=b.qtip}}e.addClassOnOver(h)}}}});Ext.namespace("Ext.ux.grid");Ext.ux.grid.ShowColumn=function(b){Ext.apply(this,b);if(!this.id){this.id=Ext.id()}this.renderer=this.renderer.createDelegate(this)};Ext.ux.grid.ShowColumn.prototype={init:function(b){this.grid=b;this.grid.on("render",function(){var c=this.grid.getView();c.mainBody.on("mousedown",this.onMouseDown,this)},this)},onMouseDown:function(f,d){if(d.className&&d.className.indexOf("x-grid3-cc-"+this.id)!=-1){f.stopEvent();var c=this.grid.getView().findRowIndex(d);var b=this.grid.store.getAt(c);b.set(this.dataIndex,!b.data[this.dataIndex]);if(this.grid.updateRealRecord&&typeof(this.grid.updateRealRecord)=="function"){this.grid.updateRealRecord(b.data,c)}this.grid.getSelectionModel().selectRow(c);var f={action:(b.data[this.dataIndex]?"trackadded":"trackremoved"),trackIndex:c};this.grid.fireEvent("trackchanged",f)}},renderer:function(c,d,b){b.dirty=false;d.css+=" x-grid3-check-col-td";return'<div class="x-grid3-check-col'+(c?"-on":"")+" x-grid3-cc-"+this.id+'">&#160;</div>'}};Ext.namespace("SeqView");SeqView.Cookies=function(b){this.path="/";this.expires=new Date(new Date().getTime()+(1000*60*60*24*7));this.domain=null;this.secure=false;Ext.apply(this,b);var c=function(){var g={};var k=document.cookie+";";var f=/\s?(.*?)=(.*?);/g;var i;while((i=f.exec(k))!=null){var e=i[1];var d=e.split(";");e=d[d.length-1].trim();var h=i[2];g[e]=h}return g};this.state=c()};SeqView.Cookies.MaxDate=new Date(new Date("10000/01/01 GMT").getTime()-100);SeqView.Cookies.UserTracksCookieName="sv-usertracks-key";SeqView.Cookies.UserDataCookieName="sv-userdata-key";SeqView.Cookies.AppDataCookieName="sv-data-key";SeqView.Cookies.prototype={get:function(c,b){return typeof this.state[c]=="undefined"?b:this.state[c]},set:function(b,c){if(typeof c=="undefined"||c===null){this.clear(b);return}this.setCookie(b,c);this.state[b]=c},clear:function(b){delete this.state[b];this.clearCookie(b)},setCookie:function(b,c){document.cookie=b+"="+c+((this.expires==null)?"":("; expires="+this.expires.toGMTString()))+((this.path==null)?"":("; path="+this.path))+((this.domain==null)?"":("; domain="+this.domain))+((this.secure==true)?"; secure":"")},clearCookie:function(b){document.cookie=b+"=; expires=Thu, 01-Jan-1970 00:00:01 GMT"+((this.path==null)?"":("; path="+this.path))+((this.domain==null)?"":("; domain="+this.domain))+((this.secure==true)?"; secure":"")}};SeqView.SessionData=new SeqView.Cookies({expires:null,secure:Ext.isSecure});SeqView.UserTracks=new SeqView.Cookies({expires:SeqView.Cookies.MaxDate,secure:Ext.isSecure});SeqView.AreaFlags={Link:(1<<0),CheckBox:(1<<1),NoSelection:(1<<2),ClientSelection:(1<<3),NoHighlight:(1<<4),NoTooltip:(1<<5),TooltipEmbedded:(1<<6),Track:(1<<7),Ruler:(1<<8),Editable:(1<<9),NoPin:(1<<10),IgnoreConflict:(1<<11),Dirty:(1<<16)};SeqView.ClearBrowserSelection=function(){var b;try{if(document.selection&&document.selection.empty){document.selection.empty()}else{if(window.getSelection){b=window.getSelection();if(b&&b.removeAllRanges){b.removeAllRanges()}}}}catch(c){}};SeqView.IsNumeric=function(c){var b=/^-?[0-9]+(\.[0-9]*)?[km]?$/i;return b.test(c)};SeqView.stringToNum=function(c){if(!c){return}c=c.replace(/[, ]/g,"");if(c.length<1){return}var f=1;var b=c.charAt(c.length-1).toUpperCase();if(b=="K"||b=="M"){c=c.substr(0,c.length-1);if(b=="K"){f=1000}else{f=1000000}}var e=0;if(f>1){var d=c.indexOf(".");if(d!=-1){e=Math.floor(parseFloat(c.substr(d))*f);c=c.substr(0,d)}}return f*parseInt(c)+e};SeqView.escapeName=function(f){var e="";var g=cbSplit(f,/([\]\[\\\|\'\"=,:;&#%])/);for(var b=g.length,d=0;d<b;){e+=g[d++];var c=g[d++];if(!c){break}if(/[\]\[\\\|,:]/.test(c)){e+="\\"+c}else{if(c=="'"||c=='"'||c=="="){e+="%"}else{e+="\\"}e+=c.charCodeAt(0).toString(16)}}return e};SeqView.unescapeName=function(f){var g=unescape(f).split("\\");var e=g[0];for(var b=g.length,d=1;d<b;d++){var c=g[d];if(c.length==0){e+="\\"+g[++d]}else{if(/[\]\[\\\|,:]/.test(c.charAt(0))){e+=c}else{if(/^[0-9a-f]{2}.*/.test(c)){e+=String.fromCharCode(parseInt(c.slice(0,2),16))+c.slice(2)}}}}return e};SeqView.sanitize=function(b){return b.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};String.prototype.visualLength=function(){var b=document.getElementById("string_ruler_unit");b.innerHTML=this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");return b.offsetWidth};SeqView.getURLPrefix=function(){var d=document.location.href.split("?")[1];var c="/projects/sviewer/";if(d){d=d.replace(/#/,"");var b=d.split("&");Ext.each(b,function(f){var e=f.split("=")[0].toLowerCase();if(e=="test"){c="";return false}})}return c};SeqView.loadHelpTopic=function(){var b=SeqView.getURLPrefix();return function(f,e){var c=Ext.getCmp("seq-viewer-help-tree");c.getSelectionModel().select(c.getNodeById(f));var d=Ext.getCmp("cur-topic");d.getUpdater().update({url:b+"./help/"+f,callback:function(i,k,h,g){i.update(h.responseText);d.setTitle("Current Topic: "+e)}})}}();SeqView.showHelpDlg=function(){var b=SeqView.getURLPrefix();return function(e){if(e===true||window.sv_external_help===true){var d="http://www.ncbi.nlm.nih.gov/projects/sviewer/help.html";window.open(d);return}if(!SeqView.HelpDlg){SeqView.HelpDlg=new Ext.Window({layout:"border",modal:false,title:"NCBI Sequence Viewer Help",width:900,height:560,constrain:true,resizable:true,bodyStyle:"padding:10px;",closeAction:"hide",items:SeqView.createHelpPanel(b),buttons:[{text:"Close",scope:this,handler:function(){SeqView.HelpDlg.hide()}}]})}SeqView.HelpDlg.isVisible()?SeqView.HelpDlg.hide():SeqView.HelpDlg.show();var c=Ext.getCmp("seq-viewer-help-tree");c.getSelectionModel().select(c.getNodeById("background.html"))}}();SeqView.showHelpPanel=function(){var b=SeqView.getURLPrefix();return function(){new Ext.Panel({layout:"border",header:false,height:700,bodyStyle:"padding:10px;",renderTo:"SeqViewerHelp",items:SeqView.createHelpPanel(b)});var c=Ext.getCmp("seq-viewer-help-tree");c.getSelectionModel().select(c.getNodeById("background.html"))}}();SeqView.createHelpPanel=function(b){return[{xtype:"treepanel",id:"seq-viewer-help-tree",autoScroll:true,defaults:{draggable:false},rootVisible:false,root:{expanded:true,children:[{text:"Background",leaf:true,id:"background.html",listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}},{text:"Quick Start",expanded:true,children:[{text:"Overview",leaf:true,id:"overview.html",listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}},{text:"How-To Videos",id:"videos.html",leaf:true,listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}},{text:"Navigation through sequence",id:"navigation.html",leaf:true,listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}},{text:"Search Panel",leaf:true,id:"search.html",listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}}]},{text:"Description of visual components",expanded:true,children:[{text:"The Overview Panel",id:"overview_panel.html",leaf:true,listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}},{text:"The Graphical Panel",id:"graphical_panel.html",leaf:true,listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}},{text:"The Alignment Panel",id:"alignment_panel.html",leaf:true,listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}},{text:"The Sequence Panel",id:"sequence_panel.html",leaf:true,listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}},{text:"The ToolTip",id:"ToolTips.html",leaf:true,listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}}]},{text:"Sequence Markers",id:"markers.html",leaf:true,listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}},{text:"Launching Tools",id:"tools.html",leaf:true,listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}},{text:"Loading Data",id:"ext_data.html",leaf:true,listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}},{text:"Configure Panel",id:"config_panel.html",leaf:true,listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}},{text:"Embedding/Access by URL",id:"url_access.html",leaf:true,listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}},{text:"Graphical View Legend",id:"graphicalViewLegend.html",leaf:true,listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}},{text:"Frequently Asked Questions",expanded:true,children:[{text:"How do I find HGVS coordinates?",id:"HGVSFeatCoords.html",leaf:true,listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}},{text:"How do I display SNPs?",id:"SNPDisplay.html",leaf:true,listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}},{text:"Why are there two rows in the Sequence View?",id:"twoRows.html",leaf:true,listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}}]},{text:"Compatible Browsers",id:"browsers.html",leaf:true,listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}},{text:"Index",id:"HelpIndex.html",leaf:true,listeners:{click:function(){SeqView.loadHelpTopic(this.id,this.text)}}}]},title:"Table of Contents",region:"west",split:true,width:320,collapsible:true,collapseMode:"mini",margins:"3 0 3 3",cmargins:"3 3 3 3"},{xtype:"panel",region:"center",title:"Current Topic: Background",margins:"3 3 3 0",id:"cur-topic",collapsible:false,autoScroll:true,autoLoad:{url:b+"./help/background.html"}}]};Ext.onReady(function(){if(typeof ncbi==="undefined"||!ncbi.sg){SeqView.ping=function(){}}else{SeqView.ping=ncbi.sg.ping}});SeqView.Locator=function(g,d,c){this.m_View=g;var b='<div id="pan_scroller_{idx}" class="pan-bar" style="background-color:#{color};position:absolute;top:0px;left:0px;"></div>';var f='<div id="seq_g{idx}" style="position:absolute;top:17px;left:0px;width:1px;">';f+='<div class="locator_rect"></div>';if(c){f+='<div id="left_resizer_{idx}" class="left-resizer"></div><div id="right_resizer_{idx}" class="right-resizer"></div>'}f+="</div>";var h=this.m_View.m_Idx;var i=new Ext.Template(b);var e=new Ext.Template(f);var k=this.getPanoramaHeight();this.element_pan=i.insertFirst(Ext.get("panorama_id"),{idx:h,qtip:"View #",color:d,adjheight:k-19},true);this.element=e.insertFirst(Ext.get("panorama_id"),{idx:h,qtip:"View #",color:d,adjheight:k-19},true);this.element.setHeight(k-2);this.element_pan.on({mousedown:this.onMouseDown,contextmenu:this.onContextMenu,scope:this});if(c){Ext.get("left_resizer_"+h).on({mousedown:this.onMouseDown,scope:this});Ext.get("right_resizer_"+h).on({mousedown:this.onMouseDown,scope:this})}};SeqView.Locator.prototype={getElement:function(){return this.element},setColor:function(b){Ext.get("pan_scroller_"+this.m_View.m_Idx).setStyle("background-color","#"+b)},setHeight:function(b){this.element.setHeight(b-17);Ext.util.CSS.updateRule(".SeqViewerApp .locator_rect","height",(b-17)+"px")},getLeft:function(b){return this.element.getLeft(b)},setLeft:function(d){var c=this.getPanoramaWidth();var b=d;if(d+24>c){b=c-24}this.element_pan.setLeft(b);this.element.setLeft(d)},getWidth:function(b){return this.element.getWidth(b)},setWidth:function(b){this.element.setWidth(b)},getRight:function(b){return this.element.getRight(b)},remove:function(){this.element_pan.remove();this.element.remove()},getPanoramaWidth:function(){return this.m_View.m_App.getPanoramaWidth()},getPanoramaHeight:function(){return this.m_View.m_App.getPanoramaHeight()},onMouseDown:function(d){if(d.button==0&&!this.m_View.m_App.m_Panorama.m_Loading){var c=d.getTarget().id;this.m_PrevXY=d.getXY();this.m_ActionNeeded=false;if(c.indexOf("left_resizer")==0){this.m_ResizeLeft=true}else{if(c.indexOf("right_resizer")==0){this.m_ResizeRight=true}else{if(c.indexOf("pan_scroller")==0){this.m_Scroll=true}else{return}}}this.m_DocMouseMove=document.onmousemove;this.m_DocMouseUp=document.onmouseup;var b=this;document.onmousemove=function(f){if(!f){f=window.event}f=Ext.EventObject.setEvent(f);b.onMouseMove(f)};document.onmouseup=function(f){if(!f){f=window.event}f=Ext.EventObject.setEvent(f);b.onMouseUp(f)}}},onMouseUp:function(b){if(this.m_ActionNeeded){this.m_View.syncToLocator()}this.m_ResizeLeft=false;this.m_ResizeRight=false;this.m_Scroll=false;this.m_ActionNeeded=false;this.m_PrevXY=null;document.onmousemove=this.m_DocMouseMove;document.onmouseup=this.m_DocMouseUp;this.m_DocMouseMove=null;this.m_DocMouseUp=null},onMouseMove:function(f){if(!this.m_PrevXY){return}SeqView.ClearBrowserSelection();var g=this.m_PrevXY[0]-f.getXY()[0];if(this.m_Scroll){var b=Math.max(0,this.getLeft(true)-g);b=Math.min(this.getPanoramaWidth()-2-this.getWidth(),b);this.setLeft(b);this.m_ActionNeeded=true}else{if(this.m_ResizeLeft){var d=this.getLeft(true);var b=Math.max(0,d-g);b=Math.min(this.getRight(true)-2,b);var c=this.getWidth()+(d-b);if(this.m_View.checkLocatorWidth(c)){this.setLeft(b);this.setWidth(c);this.m_ActionNeeded=true}}else{if(this.m_ResizeRight){var c=Math.max(2,this.getWidth()-g);c=Math.min(this.getPanoramaWidth()-2-this.getLeft(true),c);if(this.m_View.checkLocatorWidth(c)){this.setWidth(c);this.m_ActionNeeded=true}}}}this.m_PrevXY=f.getXY()},onMouseOut:function(b){},onContextMenu:function(f){f.preventDefault();f.stopPropagation();elem=f.getTarget().id;var d=Ext.get(elem);var b=elem.split("_")[2];var c="seq_g"+b;var g=new Ext.menu.Menu({items:[{text:"Bring to front",handler:function(){var e=Ext.get("pan-holder");var h=Ext.get(c);h.insertBefore(e);d.insertAfter(h)}},{text:"Sent to back",handler:function(){var h=Ext.get("panorama_id");var e="seq_g"+b;var i=Ext.get(e);h.insertFirst(i);d.insertAfter(i)}}]});g.showAt(f.getXY())}};SeqView.Reflection=function(g,c){this.m_PrevXY=[];this.m_View=g;this.m_ShowView=c;var b=this.m_ShowView.m_Color;this.parent_id=this.m_View.m_DivId;this.parent_elem=Ext.get(this.parent_id);var e=this.m_ShowView.toSeq();var f=(e[0]+1)+" : "+(e[1]+1);var d=new Ext.Template('<div id="reflection_id_{idx}_{sidx}" ext:qtip="{qtip}" class="reflection" style="z-index:10;background-color:#{color};"/>');this.element=d.append(this.parent_elem,{idx:this.m_View.m_Idx,sidx:this.m_ShowView.m_Idx,qtip:f,color:b},true);this.element.on({mousedown:this.onMouseDown,scope:this});this.update()};SeqView.Reflection.prototype={update:function(){if(!this.m_View||!this.m_ShowView){return}var d=this.m_ShowView.toSeq();var g=this.m_View.seq2Pix(d[0]);var b=this.m_View.seq2Pix(d[1]);if(this.m_View.getFlip()){this.element.setLeft(Math.round(b+this.m_View.m_ScrollPix));this.element.setWidth(Math.round(g-b))}else{this.element.setLeft(Math.round(g+this.m_View.m_ScrollPix));this.element.setWidth(Math.round(b-g))}var c="reflection_id_"+this.m_View.m_Idx+"_"+this.m_ShowView.m_Idx;var e=Ext.get(c);if(e){var i=(d[0]+1)+"-"+(d[1]+1);var h={};h["ext:qtip"]=i;e.set(h)}},movePix:function(c){var b=this.element.getLeft(true)-c;this.element.setLeft(b)},remove:function(){this.element.remove()},scrollPix:function(c,g){if(this.m_View.m_Idx==c.m_Idx){var b=this.element.getLeft(true)-g;this.element.setLeft(b)}else{if(this.m_ShowView.m_Idx==c.m_Idx){var d=c.toSeq();var e=this.m_View.seq2Pix(d[0]);this.element.setLeft(e+this.m_View.m_ScrollPix)}}},onMouseDown:function(b){if(b.button===0){this.m_PrevXY=b.getXY();this.element.setStyle("cursor","move");this.m_DocMouseMove=document.onmousemove;this.m_DocMouseUp=document.onmouseup;var c=this;document.onmousemove=function(d){if(!d){d=window.event}d=Ext.EventObject.setEvent(d);c.onMouseMove(d)};document.onmouseup=function(d){if(!d){d=window.event}d=Ext.EventObject.setEvent(d);c.onMouseUp(d)}}},onMouseUp:function(g){if(!this.m_PrevXY){return}this.element.setStyle("cursor","pointer");var f=this.m_View.getFlip();var b=Math.abs(this.m_View.m_ScrollPix)+this.element.getLeft(true);var h=b+this.element.getWidth();var d=this.m_View.pix2Seq(f?h:b);var c=this.m_View.pix2Seq(f?b:h);this.m_ShowView.startImageLoading(d,c-d+1);document.onmousemove=this.m_DocMouseMove;document.onmouseup=this.m_DocMouseUp;this.m_DocMouseMove=null;this.m_DocMouseUp=null;this.m_PrevXY=null},onMouseMove:function(d){if(!this.m_PrevXY){return}var c=d.getXY();var f=this.m_PrevXY[0]-c[0];var b=this.element.getLeft(true)-f;this.element.setLeft(b);this.m_PrevXY=c}};SeqView.ReflectionCont=function(b){this.m_App=b;this.m_AllReflections=[]};SeqView.ReflectionCont.prototype={reCreate:function(){this.deleteAll();this.m_App.forEachView(function(b){if(b.isGraphic()){this.m_App.forEachView(function(c){if(c.isGraphic()&&c.m_Idx!=b.m_Idx){this.m_AllReflections.push(new SeqView.Reflection(b,c))}},this);if(this.m_App.m_TextView){this.m_AllReflections.push(new SeqView.Reflection(b,this.m_App.m_TextView))}}},this)},updateAll:function(){for(var b=0;b<this.m_AllReflections.length;b++){this.m_AllReflections[b].update()}},deleteAll:function(){for(var b=0;b!=this.m_AllReflections.length;b++){this.m_AllReflections[b].remove()}this.m_AllReflections=[]},scrollPix:function(b,e){for(var c=0;c!=this.m_AllReflections.length;c++){var d=this.m_AllReflections[c];d.scrollPix(b,e)}}};SeqView.SelectionToolTip=Ext.extend(Ext.ux.StickyToolTip,{dismissDelay:0,hideDelay:50,showDelay:500,quickShowInterval:0,mouseOffset:[7,9],anchorToTarget:false,anchor:false,initComponent:function(){this.target=this.selection.element;this.gview=this.selection.m_View;this.area=this.selection.area;this.tooltip=this.area.tooltip;this.basiclinks=this.area.basiclinks;this.extralinks=this.area.extralinks;this.manager=this.gview.ToolTipsMgr;this.keepArea={x:this.gview.getXY()[0],y:this.gview.getXY()[1],width:this.gview.getScreenWidth(),height:this.gview.getScreenHeight()};this.areaShown=true;if(this.area.range){this.title=(this.area.range[0]+1)+".."+(this.area.range[1]+1)}else{if(this.area.name){this.title=this.area.name}}this.title="&nbsp;&nbsp;&nbsp;"+this.title;SeqView.SelectionToolTip.superclass.initComponent.call(this);this.on({pin:function(b){b.area.qtip=b;b.tools.search.show()},unpin:function(b){delete b.area.qtip;b.tools.search.hide();b.delayHide()}})},updateContent:function(g,d){d=d||this.body;var f=this.tooltip;var b=false;if(this.basiclinks){f+="<br/><b>Links & Tools</b><br/>";f+=this.basiclinks;b=true}try{if(g){if(this.extralinks){if(!b){f+="<br/><b>Links & Tools</b>"}f+="<br/>"+this.extralinks}if(this.tools.down){this.tools.down.hide()}if(this.tools.up){this.tools.up.show()}}else{if(this.tools.down){this.tools.down.show()}if(this.tools.up){this.tools.up.hide()}}if(!this.extralinks||this.extralinks.length==0){if(this.tools.up){this.tools.up.hide()}if(this.tools.down){this.tools.down.hide()}}d.update(f);var h=d.parent("div[id^=svtt-]");var c=Ext.getCmp(h.id);if(c){c.doAutoWidth();c.keepInArea();c.syncShadow()}}catch(e){}},afterRender:function(){SeqView.SelectionToolTip.superclass.afterRender.call(this);if((this.area.type&SeqView.AreaFlags.NoPin)!==0){var c=["pin","unpin"];for(var b=0;b<c.length;++b){this.tools[c[b]].hide()}}else{var c=this.gview.m_App.getCustomToolTipTools(this.selection);if(c&&c.length>0){for(var b=0;b<c.length;b++){this.addTool(c[b])}}this.addTool({id:"search",handler:this.showFeat,hidden:true,scope:this},{id:"magnify",handler:this.loadAreaRange,scope:this},{id:"up",scope:this,hidden:true,handler:function(){this.updateContent(false)}},{id:"down",scope:this,hidden:true,handler:function(){this.updateContent(true)}})}this.getEl().on("click",this.onMouseClick,this);if(this.area.tooltip&&this.area.tooltip.length>0){this.updateContent(false)}},areaVisible:function(b){this.areaShown=b},showFeat:function(f,d,c){if(this.areaShown){var g=-this.gview.m_ScrollPix;if(this.area.bounds.r-10<g){this.gview.scrollViewTo(-(this.area.bounds.l-10),SeqView.PAN_RIGHT)}else{if(this.area.bounds.l+10>this.gview.getScreenWidth()+g){var b=g+(this.area.bounds.r-(g+this.gview.getScreenWidth()));this.gview.scrollViewTo(-(b+10),SeqView.PAN_LEFT)}}this.highlightFeat()}else{this.loadAreaRange()}},highlightFeat:function(){var b=new SeqView.SelectionHighlighter(this.gview,this.area);b.remove.defer(900,b)},loadAreaRange:function(){var d=this.area.range[0];var b=this.area.range[1]-this.area.range[0]+1;var c=Math.floor(b/10);d-=c;if(d-c<0){d=0}b+=2*c;if(d+b-1>this.gview.m_App.m_SeqLen){b-=this.gview.m_App.m_SeqLen-(d+b-1)}if(this.gview.m_VisFromSeq!=d||this.gview.m_VisLenSeq!=b){this.gview.startImageLoading(d,b);this.delayedHighlight=true}else{this.highlightFeat()}},getMouseOffset:function(){return this.mouseOffset},highlightToolTip:function(){this.getEl().addClass("tooltip_highlight")},unHighlightToolTip:function(){this.getEl().removeClass("tooltip_highlight")}});SeqView.SelectionHighlighter=function(o,d,i){this.m_View=o;this.area=d;this.parent_id=this.m_View.m_DivId;this.parent_elem=Ext.get(this.parent_id);var h='<div id="selection_id_{idx}" class="sv-drag ';h+=i?" sv-highlight selection_highlight-edit":" selection_highlight";h+='"/>';var l=new Ext.Template(h);this.element=l.append(this.parent_elem,{idx:Ext.id()},true);var c=this.area.bounds;var e=i?6:3;var f=(this.m_View.getFlip()?c.r:c.l)+1;var p=(this.m_View.getFlip()?c.l:c.r)+1;var b=c.t-6;var k=f+this.m_View.m_ScrollPix-4;var g=p-f+6;var q=c.b-c.t+5;if(k<-200){var n=-200-k;k=-200;g=g-n}if(g-k>2000){g=2000}this.element.setLeft(k);this.element.setTop(b);this.element.setHeight(q);this.element.setWidth(g)};SeqView.SelectionHighlighter.prototype={movePix:function(c){var b=this.element.getLeft(true)-c;this.element.setLeft(b)},remove:function(){this.element.remove()}};SeqView.Selection=function(t,e){this.m_View=t;this.delayTimeout=null;this.saved_event=null;this.areas=e;this.area=e[e.length-1];var r=[];for(var l=0;l!=e.length;l++){r.push(e[l].signature)}this.parent_id=this.m_View.m_DivId;this.parent_elem=Ext.get(this.parent_id);var p=(this.area.type&SeqView.AreaFlags.NoHighlight)!==0?new Ext.Template('<div id="selection_id_{idx}" class="over_noselection sv-drag"/>'):new Ext.Template('<div id="selection_id_{idx}" class="over_selection sv-drag"/>');this.element=p.append(this.parent_elem,{idx:Ext.id()},true);var d=this.area.bounds;var h=(this.m_View.getFlip()?d.r:d.l)+1;var u=(this.m_View.getFlip()?d.l:d.r)+1;var c=d.t-3;var o=h+this.m_View.m_ScrollPix-2;var n=u-h+3;if(o<-200){var s=-200-o;o=-200;n=n-s}if(n-o>2000){n=2000}this.element.setLeft(o);this.element.setTop(c);this.element.setHeight(d.b-d.t);this.element.setWidth(n);var b={click:this.clickTest,contextmenu:this.onContextMenu,scope:this};if(Ext.isIE){b.dblclick=this.interOnDblClick}this.element.on(b);var f=this.area;var g=this.element;if(f.qtip){f.qtip.highlightToolTip();return}if(!this.m_View.ToolTipsMgr){this.m_View.ToolTipsMgr=new Ext.ux.StickyToolTipsMgr()}if((f.type&SeqView.AreaFlags.TooltipEmbedded)!==0&&!f.tooltip){f.tooltip="Not provided"}if((f.type&SeqView.AreaFlags.Track)!==0&&!f.tooltip){f.tooltip=this.m_View.m_App.getToolTipForTrack(f.signature)}if(f.tooltip){new SeqView.SelectionToolTip({selection:this,id:"svtt-"+Ext.id()})}else{var k={id:r.join(",")};if(this.m_View.m_App.m_Key){k.key=this.m_View.m_App.m_Key}if(this.m_View.m_App.m_DepthLimit){k.depthlimit=this.m_View.m_App.m_DepthLimit}if(this.m_View.m_App.m_BamPath){k.bam_path=this.m_View.m_App.m_BamPath}var q=new SeqView.SelectionToolTip({selection:this,id:"svtt-"+Ext.id(),autoLoad:{url:this.m_View.m_App.m_CGIs.ObjInfo,params:k,scope:this,callback:function(z,D,X,C){var K="";var F=Ext.decode(X.responseText);var A=[];if(F.length>1){var U=F[0];var T=F[1];var I=(U.text?U.text:U.error);var G=(T.text?T.text:T.error);K=I+"<br>"+G;if(U.links&&U.links.length>0){A.push(U.links)}if(T.links&&T.links.length>0){A.push(T.links)}}else{var J=F[0];K=(J.text?J.text:J.error);if(J.links&&J.links.length>0){A.push(J.links)}}this.area.tooltip=K;q.tooltip=K;if(F[0].exts){this.area.exts=F[0].exts}var M="";var w="";for(var S=0,H=A.length;S<H;S++){var B=A[S];for(var R=0,L=B.length;R<L;R++){var W=B[R];var N=(W.name&&W.name.length>0)?W.name+": ":"";N=N.replace(/ /g,"&nbsp;");for(var Q=0,P=W.links.length;Q<P;Q++){var O=W.links[Q];if(Q>0){N+=",&nbsp;"}var E=O.label.replace(/ /g,"&nbsp;");var V=O.link.match(/^https?:/i);if(this.m_View.m_App.m_Embedded===false||V){N+='<a href="'+O.link+'" target="_blank">'+E+"</a>"}else{N+='<a href="http://www.ncbi.nlm.nih.gov'+(O.link.charAt(0)=="/"?"":"/")+O.link+'" target="_blank">'+E+"</a>"}}if(W.type=="Basic"){if(M.length>0){M+="<br/>"}M+=N}else{if(W.type=="Extra"){if(w.length>0){w+="<br/>"}w+=N}}}}if(M.length>0){this.area.basiclinks=M;q.basiclinks=M}if(w.length>0){this.area.extralinks=w;q.extralinks=w}q.updateContent(false,z)}}})}};SeqView.Selection.prototype={movePix:function(c){var b=this.element.getLeft(true)-c;this.element.setLeft(b)},remove:function(){if(this.area&&this.area.qtip){this.area.qtip.unHighlightToolTip()}this.element.remove()},onClick:function(b){this.m_View.changeSelectedSig(this.area,b.ctrlKey)},onDblClick:function(h){var d=this.area.range;var f=(d[0]<d[1])?d[0]:d[1];var c=(d[0]<d[1])?d[1]:d[0];var b=c-f+1;var g=b/100*6;f-=g;c+=g;b=c-f+1;this.m_View.startImageLoading(f,b)},fireClick:function(b){clearTimeout(this.delayTimeout);this.delayTimeout=null;if(!this.DblClickHit){this.onClick(this.saved_event)}this.DblClickHit=false;this.saved_event=null},clickTest:function(c){if(this.delayTimeout){if(c.type=="click"){this.DblClickHit=false;clearTimeout(this.delayTimeout);this.delayTimeout=null;this.saved_event.type="dblclick";this.saved_event.browserEvent="Event dblclick";this.onDblClick(this.saved_event);this.saved_event=null}}else{if(c.type=="click"){this.saved_event=new Ext.EventObjectImpl(c);var b=this;this.delayTimeout=setTimeout(function(){b.fireClick(c)},200)}}},interOnDblClick:function(b){this.DblClickHit=true;this.onDblClick(b)},onContextMenu:function(g){g.stopEvent();var d=this.area.range;if(d===undefined){return}var b=this.area.strand==1?d[0]:d[1];var f=this;var c;if(this.area.signature.indexOf("fake|")==-1){c=this.areas}this.m_View.showContextMenu(g,function(e){f.addSelectionLinks(e,b,c)})},addSelectionLinks:function(e,c,d){e.add("-");e.add({text:"Set Sequence Origin At Feature",iconCls:"xsv-origin",scope:this,handler:function(){this.m_View.m_App.showOriginDlg(c)}});if(d){if(d.length==2){e.add("-");var b=new Ext.menu.Menu();this.addFeatureLinks(b,"Views & Tools: mRNA",d[1],"link_menu_mrna");this.addFeatureLinks(b,"Views & Tools: CDS",d[0],"link_menu_cds");e.add({text:"Views & Tools",iconCls:"xsv-views_tools",menu:b})}else{this.addFeatureLinks(e,"Views & Tools",d[0],"link_menu",true)}}},createCGIParams:function(b){var c={id:b};if(this.m_View.m_App.m_ViewerContext){c.viewer_context=this.m_View.m_App.m_ViewerContext}if(this.m_View.m_App.m_Key){c.key=this.m_View.m_App.m_Key}if(this.m_View.m_App.m_DepthLimit){c.depthlimit=this.m_View.m_App.m_DepthLimit}if(this.m_View.m_App.m_SRZ){c.srz=this.m_View.m_App.m_SRZ}if(this.m_View.m_App.m_BamPath){c.bam_path=this.m_View.m_App.m_BamPath}return c},addFeatureLinks:function(e,d,c,b,f){if(c[b]){if(f){e.add("-")}e.add({text:d,iconCls:"xsv-views_tools",menu:c[b]})}else{this.m_View.m_App.AjaxRequest({url:this.m_View.m_App.m_CGIs.Link,scope:this,params:this.createCGIParams(c.signature),success:function(l){var g=Ext.decode(l.responseText);if(g.length>0){var n=new Ext.menu.Menu();for(var k=0;k!=g.length;k++){var h=g[k].link;if(this.m_View.m_App.m_Embedded!==false){h="http://www.ncbi.nlm.nih.gov/"+h}n.add({text:g[k].label,url:h,scope:this,handler:function(i){window.open(i.url)}})}c[b]=n;if(f){e.add("-")}e.add({text:d,iconCls:"xsv-views_tools",menu:n})}}})}}};SeqView.SelectedRangeToolTip=Ext.extend(Ext.ToolTip,{dismissDelay:0,hideDelay:50,showDelay:100,quickShowInterval:0,trackMouse:false,anchor:"top",anchorToTarget:true,mouseOffset:[-13,-10],header:true,title:"&nbsp;&nbsp;&nbsp;Range ToolTip",draggable:true,initComponent:function(){this.autoHide=false;this.pinned=false;this.draggable=true;this.gview=this.selection.m_View;this.target=this.selection.m_tt_TargetDiv;this.id=this.selection.m_tt_Div;this.SharedSelectedRangeAndToolTipId=null;this.tooltipTitle=this.selection.m_tooltipTitle;this.textId=this.selection.ToolTipTextId;this.manager=this.gview.SelectedRangeToolTipsMgr;this.range=this.selection.range;this.rangeText=this.selection.range_text;SeqView.SelectedRangeToolTip.superclass.initComponent.call(this);this.addEvents({pin:true,unpin:true});this.toolbar=new Ext.Toolbar({layout:"vbox",items:[{xtype:"tbtext",text:this.rangeText,id:this.textId,textStyle:"font-weight:bold;",scope:this},{text:"Zoom On Range",iconCls:"xsv-zoom_range",handler:function(){if(!this.isPinned()){this.hide()}this.gview.removeSelectionsWithNoPinnedToolTips();this.gview.startImageLoading(this.range[0],this.range[1]-this.range[0]+1)},scope:this},{text:"Add New Panel On Range",iconCls:"xsv-new_view",handler:function(){var b=new SeqView.Graphic(this.gview.m_App);this.gview.m_App.registerView(b);from=this.range[0];to=this.range[1];this.gview.removeSelectionsWithNoPinnedToolTips();b.startImageLoading(from,to-from+1);if(!this.isPinned()){this.hide()}this.removehighlightSelectedTopRectangle()},scope:this},{text:"Set New Marker For Selection",iconCls:"xsv-markers",handler:function(){if(!this.isPinned()){this.hide()}this.removehighlightSelectedTopRectangle();var b=this.gview.m_SelectedRangeSet.length;for(x=0;x<b;x++){var c=this.gview.m_SelectedRangeSet[x];if(c[0]==this.range[0]&&c[1]==this.range[1]){this.gview.m_App.addMarker(this.gview.m_SelectedRangeSet[x])}}this.makeUnPinned();this.hide();this.gview.removeSelectionsWithNoPinnedToolTips()},scope:this},{text:"BLAST Search (Selection)",iconCls:"xsv-blast",handler:function(){this.gview.blastSelection();if(!this.isPinned()){this.hide();this.removehighlightSelectedTopRectangle()}},scope:this},{text:"Primer BLAST (Selection)",iconCls:"xsv-primer",handler:function(){this.gview.primerBlast();if(!this.isPinned()){this.hide();this.removehighlightSelectedTopRectangle()}},scope:this}]});this.toolbar.width="170";this.toolbar.height="130";if(Ext.isGecko){this.toolbar.width="200";this.toolbar.height="140"}this.add(this.toolbar)},afterRender:function(){SeqView.SelectedRangeToolTip.superclass.afterRender.call(this);this.addTool({id:"pin",handler:this.toggelPin,scope:this,hidden:true},{id:"unpin",handler:this.toggelPin,scope:this});this.standardZIndex=this.getEl().getZIndex();this.getEl().on("click",this.onMouseClick,this);this.getEl().on("click",this.onMouseUp,this)},toggelPin:function(d,c,b){if(!this.pinned){b.tools.pin.show();b.tools.unpin.hide();this.fireEvent("pin",this)}else{b.tools.pin.hide();b.tools.unpin.show();this.fireEvent("unpin",this);if(!this.selection){this.hide();this.destroy()}}this.pinned=!this.pinned},makePinned:function(){this.tools.pin.show();this.tools.unpin.hide();this.pinned=true},makeUnPinned:function(){this.tools.unpin.show();this.tools.pin.hide();this.pinned=false},isPinned:function(){return this.pinned},onTargetOut:function(b){console.log("Range: onTargetOut");if(this.disabled||b.within(this.target.dom,true)){return}this.dontShow=true;(function(c){if(this.isInsideTootTip(c)){this.clearTimer("dismiss");this.autoHide=false;this.getEl().on("mouseout",this.onMouseOut,this);return}if(this.autoHide!==false){this.delayHide()}}).defer(100,this,[b])},onTargetOver:function(g){console.log("Range: onTargetOver");delete this.dontShow;SeqView.SelectedRangeToolTip.superclass.onTargetOver.call(this,g);var d=Ext.get(this.target);if(d||d.dom){var b=g.getPageX();var c=d.getLeft();var f=b-c-15;this.mouseOffset=[f,-10]}this.removehighlightSelectedTopRectangle();this.highlightSelectedTopRectangleMouseOver()},hide:function(){this.dontShow=true;if(this.getEl()&&this.getEl().dom){SeqView.SelectedRangeToolTip.superclass.hide.call(this)}},show:function(){if(!this.dontShow){SeqView.SelectedRangeToolTip.superclass.show.call(this)}},onEnable:function(){if(!this.dontShow){SeqView.SelectedRangeToolTip.superclass.onEnable.call(this)}},areaVisible:function(b){this.areaShown=b},onDocMouseDown:function(b){if(this.pinned){return}if(!this.isInsideTootTip(b)){this.hide()}SeqView.SelectedRangeToolTip.superclass.onDocMouseDown.call(this,b)},onMouseOut:function(b){if(this.pinned||this.isInsideTootTip(b)){return}this.getEl().un("mouseout",this.onMouseOut,this);this.autoHide=true;this.clearTimer("show");if(this.autoHide!==false){this.delayHide()}},onMouseClick:function(b){if(this.manager){this.manager.bringToFront(this)}},onMouseUp:function(b){},onShow:function(){SeqView.SelectedRangeToolTip.superclass.onShow.call(this);if(this.manager){this.manager.register(this);this.manager.bringToFront(this)}},onHide:function(){if(this.manager){this.manager.unregister(this)}SeqView.SelectedRangeToolTip.superclass.onHide.call(this)},onDestroy:function(){if(this.target){this.target.un("click",this.onTargetClick,this)}var b=this.getEl();if(b){b.un("mouseout",this.onMouseOut,this)}SeqView.SelectedRangeToolTip.superclass.onDestroy.call(this)},onTargetClick:function(b){this.dontShow=true},doAutoWidth:function(e){e=e||0;var f=this.body.getTextWidth();if(this.title){var c=this.header.child("span").getTextWidth(this.title);var b=0;for(var d in this.tools){b+=1}c+=(b-1)*15;f=Math.max(f,c)}f+=this.getFrameWidth()+this.body.getPadding("lr")+e;this.setWidth(f.constrain(this.minWidth,this.maxWidth));if(Ext.isIE7&&!this.repainted){this.el.repaint();this.repainted=true}},keepInArea:function(){if(this.keepArea){var c=this.getEl().getXY();var b=this.getEl().getWidth();if(c[0]+b>this.keepArea.x+this.keepArea.width){this.setPagePosition(c[0]-(c[0]+b-(this.keepArea.x+this.keepArea.width))-4,c[1])}}},addTool:function(){if(!this.rendered){if(!this.tools){this.tools=[]}Ext.each(arguments,function(i){this.tools.push(i)},this);return}if(!this[this.toolTarget]){return}if(!this.ttoolTemplate){var g=new Ext.Template('<div class="x-tool xsv-left-align x-tool-{id}">&#160;</div>');g.disableFormats=true;g.compile();SeqView.SelectedRangeToolTip.prototype.ttoolTemplate=g}for(var f=0,d=arguments,c=d.length;f<c;f++){var b=d[f];if(!this.tools[b.id]){var h="x-tool-"+b.id+"-over";var e=this.ttoolTemplate.insertBefore(this[this.toolTarget],b,true);this.tools[b.id]=e;e.enableDisplayMode("block");this.mon(e,"click",this.createToolHandler(e,b,h,this));if(b.on){this.mon(e,b.on)}if(b.hidden){e.hide()}if(b.qtip){if(Ext.isObject(b.qtip)){Ext.QuickTips.register(Ext.apply({target:e.id},b.qtip))}else{e.dom.qtip=b.qtip}}e.addClassOnOver(h)}}},isInsideTootTip:function(h){if(this.isVisible()){var g=Ext.get(this.id);if(!g||!g.dom){return false}var b=h.getPageX();var k=h.getPageY();var c=g.getLeft();var i=g.getRight();var d=g.getTop();var f=g.getBottom();if(b>c&&b<i&&k<f&&k>d){return true}return false}return false},isInsideSelectedTopRectangle:function(h){var g=Ext.get(this.target);if(!g||!g.dom){return false}var b=h.getPageX();var k=h.getPageY();var c=g.getLeft();var i=g.getRight();var d=g.getTop();var f=g.getBottom();if(b>c&&b<i&&k<f&&k>d){return true}return false},highlightSelectedTopRectangleMouseOver:function(){var b=Ext.get(this.target);if(b){b.show();b.animate({color:{to:"#254117"},backgroundColor:{to:"#254117"}},0.35,null,"easeOut","color")}},highlightSelectedTopRectangle:function(){var b=Ext.get(this.target);if(b){b.show();b.animate({color:{to:"#95B9C7"},backgroundColor:{to:"#95B9C7"}},0.1,null,"easeOut","color")}},removehighlightSelectedTopRectangle:function(){var b=Ext.get(this.target);if(b&&b.isVisible){b.hide()}}});SeqView.SelectedRangeToolTipsMgr=function(){var e={};var c=[];var d=null;var b=function(h,g){return(!h._lastAccess||h._lastAccess<g._lastAccess)?-1:1};var f=function(){var k=c,g=k.length;if(g>0){k.sort(b);var h=k[0].manager.zseed;for(var l=0;l<g;l++){var n=k[l];if(n&&!n.hidden){n.getEl().setZIndex(h+(l*10))}}}};return{zseed:15000,register:function(g){e[g.id]=g;c.push(g)},clear:function(){Ext.each(c,function(g){delete e[g.id];g.destroy();g.remove()});c=[];e={};d=null},unregister:function(g){delete e[g.id];c.remove(g)},get:function(g){return typeof g=="object"?g:e[g]},bringToFront:function(g){g=this.get(g);if(g!=d){g._lastAccess=new Date().getTime();f();return true}return false},sendToBack:function(g){g=this.get(g);g._lastAccess=-(new Date().getTime());f();return g},each:function(h,g){for(var i in e){if(e[i]&&typeof e[i]!="function"){if(h.call(g||e[i],e[i])===false){return}}}}}};SeqView.RangeSelection=function(k,e,h,b){this.m_View=k;this.m_Resizing=false;if(!h){this.range=e}this.m_ReplaceSelection=!b;var p=Ext.fly(k.m_DivId);this.m_tt_TargetDiv="svtt-"+Ext.id();this.m_tt_Div="svtt-"+Ext.id();this.ToolTipTextId=Ext.id();var i='<div id="'+this.m_tt_TargetDiv+'" style="height: 20px;" />';i="";var f='<div class="range_selection sv-drag sv-highlight">'+i+"</div>";var g=new Ext.Template(f);this.element=g.append(p,{},true);this.m_tooltipTitle=null;this.m_ToolTip=null;this.element.on({mousedown:this.onMouseDown,mousemove:this.onMouseMove,click:this.onClick,scope:this});if(h){var n=this.pageToViewX(e[0]);this.range=[n,n];this.mouse_offset=0;this.setElementPixRange(this.range);this.startResizing()}else{this.updateCoords()}if(!this.m_View.SelectedRangeToolTipsMgr){this.m_View.SelectedRangeToolTipsMgr=new SeqView.SelectedRangeToolTipsMgr()}this.range_text="<b>Range: "+this.range[0]+" .. "+this.range[1]+"</b>";var d=this.m_View.m_OrphanRangeToolTips.length;for(n=0;n<d;n++){if(this.m_View.m_OrphanRangeToolTips[n].range[0]==this.range[0]&&this.m_View.m_OrphanRangeToolTips[n].range[1]==this.range[1]){this.m_ToolTip=new SeqView.SelectedRangeToolTip({selection:this});var o=this.m_View.m_OrphanRangeToolTips[n].pageX;var c=this.m_View.m_OrphanRangeToolTips[n].pageY;this.m_View.m_OrphanRangeToolTips[n].makeUnPinned();if(this.m_View.m_OrphanRangeToolTips[n].isVisible()){this.m_View.m_OrphanRangeToolTips[n].hide()}this.m_View.m_OrphanRangeToolTips[n].destroy();this.m_View.m_OrphanRangeToolTips.splice(n,1);this.m_ToolTip.showAt([o,c]);this.m_ToolTip.makePinned();break}}if(!this.m_ToolTip){this.m_ToolTip=new SeqView.SelectedRangeToolTip({selection:this})}};SeqView.RangeSelection.prototype={pageToViewX:function(b){var c=Ext.fly(this.m_View.m_DivId).getXY();return b-c[0]},movePix:function(c){var b=this.element.getLeft(true)-c;this.element.setLeft(b)},remove:function(){this.element.remove()},rangePixToSeq:function(c){var b=this.m_View;var g=b.m_ScrollPix;var f=b.getFlip()?-0.5:0.5;var e=Math.round(b.pix2Seq(c[0]-g,f));var d=Math.round(b.pix2Seq(c[1]-g,-f));if(!b.getFlip()){return[e,d]}else{return[d,e]}},rangeSeqToPix:function(c){var b=this.m_View;var f,d,e;if(!b.getFlip()){e=0.5;f=c[0];d=c[1]}else{e=-0.5;f=c[1];d=c[0]}f=b.seq2PixScrolled(f-e);d=b.seq2PixScrolled(d+e);return[f,d]},updateCoords:function(){var b=this.rangeSeqToPix(this.range);this.setElementPixRange(b)},setElementPixRange:function(c){var b=this.m_View;var h=Math.max(-10000,Math.min(10000,c[0]));var e=Math.max(-10000,Math.min(10000,c[1]));var g=e-h;if(g>4000){var d=Math.round(b.getScreenWidth()/2);if(Math.abs(h-d)<Math.abs(e-d)){e=Math.max(d+2000,Math.min(e,h+4000));h=Math.max(h,e-4000)}else{h=Math.min(d-2000,Math.max(h,e-4000));e=Math.min(e,h+4000)}g=e-h}var f=this.element;f.setLeft(h);f.setWidth(g);f.setTop(b.getSelectionTop());f.setHeight(b.getSelectionHeight())},startResizing:function(){this.m_Resizing=true;this.m_DocMouseMove=document.onmousemove;this.m_DocMouseUp=document.onmouseup;var b=this;document.onmousemove=function(c){if(!c){c=window.event}c=Ext.EventObject.setEvent(c);b.onMouseMove(c)};document.onmouseup=function(c){if(!c){c=window.event}c=Ext.EventObject.setEvent(c);b.onMouseUp(c)}},onClick:function(b){if(b.ctrlKey){b.stopEvent();this.m_View.removeRangeSelection(true,this)}},onMouseDown:function(i){console.log("selection.js: Range onMouseDown");var h=i.getXY();var b=this.pageToViewX(h[0]);var g=this.element.getLeft(true);var c=g+this.element.getWidth(true);var d=Math.abs(b-g);var f=Math.abs(b-c);if(d<5||f<5){i.stopEvent();var k=this.rangeSeqToPix(this.range);if(d<f){this.range=[k[1],k[0]]}else{this.range=k}this.mouse_offset=b-this.range[1];this.m_View.popRangeElement(this,true);this.startResizing()}},onMouseUp:function(c){var b;if(this.range[0]>this.range[1]){b=[this.range[1],this.range[0]]}else{b=this.range}this.range=this.rangePixToSeq(b);this.updateCoords();this.m_View.addRangeSelection(this,this.range,b[1]-b[0]);if(this.m_Resizing){Ext.fly(this.m_View.m_DivId).setStyle("cursor","default");Ext.fly(c.getTarget()).setStyle("cursor","default")}this.m_Resizing=false;document.onmousemove=this.m_DocMouseMove;document.onmouseup=this.m_DocMouseUp;this.m_DocMouseMove=null;this.m_DocMouseUp=null;if(this.m_ReplaceSelection&&!this.m_View.m_App.m_TestRangeSelNoRemove){this.m_View.clearSelectedSig();this.m_ReplaceSelection=false}var d=this.rangeSeqToPix(this.range);if((d[1]-d[0])>5){if(this.m_ToolTip){if(this.m_ToolTip.isVisible()){this.m_ToolTip.hide()}this.m_ToolTip.destroy()}this.range_text="<b>Range: "+this.range[0]+" .. "+this.range[1]+"</b>";this.m_ToolTip=new SeqView.SelectedRangeToolTip({selection:this});this.m_ToolTip.removehighlightSelectedTopRectangle();this.m_ToolTip.highlightSelectedTopRectangleMouseOver()}},onMouseMove:function(k){var i=k.getXY();var b=this.pageToViewX(i[0]);if(!this.m_Resizing){var h=this.element.getLeft(true);var c=h+this.element.getWidth(true);var f=Math.abs(b-h);var g=Math.abs(b-c);if(f<5||g<5){Ext.fly(k.getTarget()).setStyle("cursor","e-resize")}else{Ext.fly(k.getTarget()).setStyle("cursor","default")}if(!this.m_ToolTip.isVisible()){this.m_ToolTip.removehighlightSelectedTopRectangle();this.m_ToolTip.highlightSelectedTopRectangle()}return}b-=this.mouse_offset;k.stopEvent();if(b==this.range[1]){return}this.range[1]=b;var h,d;if(this.range[0]<this.range[1]){this.setElementPixRange(this.range)}else{this.setElementPixRange([this.range[1],this.range[0]])}}};SeqView.MarkerFlags={UserLock:(1<<0),SystemLock:(1<<1),Hollow:(1<<2)};SeqView.Marker=(function(){var d=8;function b(k,i,l,g,h){this.m_MInfo=k;this.obj_coords=null;this.deleted=false;this.flags=g;this.color=h?h:k.getNextColor();this.assignName(l?l:k.suggestNextName());this.marker_num=k.m_NextMarkerNum++;this.span=0;this.seq_pos=i[0];if(i[1]){this.span=i[1]-i[0]+1}this.marker_in_views=[];this.lines_in_views=[];this.addToAllViews()}b.getWidth=function(){return d};var c=new Ext.Template('<div id="{id}" ext:qtip="{qtip}" class="sv-marker sv-marker_base sv-opaque67">','<div style="position:absolute;top:7px;left:0px;width:16px;height:2px;clip:rect(0 16px 2px 0);background-color:{color};"></div>','<div style="position:absolute;top:4px;left:1px;width:14px;height:8px;clip:rect(0 14px 8px 0);background-color:{color};"></div>','<div style="position:absolute;top:3px;left:2px;width:12px;height:10px;clip:rect(0 12px 10px 0);background-color:{color};"></div>','<div style="position:absolute;top:2px;left:3px;width:10px;height:12px;clip:rect(0 10px 12px 0);background-color:{color};"></div>','<div style="position:absolute;top:1px;left:4px;width:8px;height:14px;clip:rect(0 8px 14px 0);background-color:{color};"></div>','<div style="position:absolute;top:0px;left:7px;width:2px;height:16px;clip:rect(0 2px 16px 0);background-color:{color};"></div>','<div id="{id}_line" class="marker_line sv-opaque5" style="width:1px;border-left:1px solid {color};">','<div id="{id}_body" class="sv-opaque3 sv-drag sv-highlight" style="background-color:{color};position:absolute;width:100%;height:100%"></div>',"</div>",'<div ext:qtip="Locked" id="the_{id}_lock" style="display:{lock};" class="marker_locked_ov"></div></div>');var e=new Ext.Template('<div id="{id}" class="sv-marker sv-marker_half_base" style="top:0px;">','<div style="position:absolute;top:7px;left:0px;width:8px;height:2px;clip:rect(0 8px 2px 0);background-color:{color};"></div>','<div style="position:absolute;top:4px;left:1px;width:7px;height:8px;clip:rect(0 7px 8px 0);background-color:{color};"></div>','<div style="position:absolute;top:3px;left:2px;width:6px;height:10px;clip:rect(0 6px 10px 0);background-color:{color};"></div>','<div style="position:absolute;top:2px;left:3px;width:5px;height:12px;clip:rect(0 5px 12px 0);background-color:{color};"></div>','<div style="position:absolute;top:1px;left:4px;width:4px;height:14px;clip:rect(0 4px 14px 0);background-color:{color};"></div>','<div style="position:absolute;top:0px;left:7px;width:1px;height:16px;clip:rect(0 1px 16px 0);background-color:{color};"></div>','<div id="{id}_line" class="marker_line sv-opaque5" style="width:0px;border-left:1px solid {color};border-right:1px solid {color};">','<div id="{id}_body" class="sv-opaque3 sv-drag sv-highlight" style="background-color:{color};position:absolute;width:100%;height:100%"></div>',"</div>",'<div id="the_{id}_back" class="marker_label_back sv-opaque67" style="{font_size}background-color:{color};width:{label_length}px;"></div>','<div id="{id}_label" ext:qtip="{qtip}" class="marker_label">{trimmed_label}',' <img id="the_{id}_lock" style="margin-top:1px;display:{lock};" ext:qtip="Locked" src="{prefix}images/lock.png"></div></div>');var f=new Ext.Template('<div id="{id}" class="sv-marker sv-marker_half_base" style="top:0px;">','<div style="position:absolute;top:7px;left:0px;width:8px;height:2px;clip:rect(0 8px 2px 0);background-color:{color};"></div>','<div style="position:absolute;top:4px;left:1px;width:7px;height:8px;clip:rect(0 7px 8px 0);background-color:{color};"></div>','<div style="position:absolute;top:3px;left:2px;width:6px;height:10px;clip:rect(0 6px 10px 0);background-color:{color};"></div>','<div style="position:absolute;top:2px;left:3px;width:5px;height:12px;clip:rect(0 5px 12px 0);background-color:{color};"></div>','<div style="position:absolute;top:1px;left:4px;width:4px;height:14px;clip:rect(0 4px 14px 0);background-color:{color};"></div>','<div style="position:absolute;top:0px;left:7px;width:1px;height:16px;clip:rect(0 1px 16px 0);background-color:{color};"></div>','<div id="{id}_line" class="marker_line sv-opaque5" style="width:0px;border-top:5px solid {color};border-left:1px solid {color};border-right:1px solid {color};">','<div id="{id}_body" class="sv-transparent sv-drag sv-highlight" style="background-color:{color};position:absolute;width:100%;height:100%"></div>',"</div>",'<div id="the_{id}_back" class="marker_label_back sv-opaque67" style="{font_size}background-color:{color};width:{label_length}px;"></div>','<div id="{id}_label" ext:qtip="{qtip}" class="marker_label">{trimmed_label}',' <img id="the_{id}_lock" style="margin-top:1px;display:{lock};" ext:qtip="Locked" src="{prefix}images/lock.png"></div></div>');b.getPanoramaTmpl=function(g){return c};b.getGraphicTmpl=function(g){return g?e:f};return b})();SeqView.Marker.prototype={displayPos:function(){var b=this.seq_pos+1;if(this.span){b+=":"+(this.seq_pos+this.span)}return b},displayLocalPos:function(){var b=this.m_MInfo.m_App;var c=b.posToLocal(this.seq_pos);if(this.span){c+=":"+b.posToLocal(this.seq_pos+this.span-1)}return c},addToAllViews:function(){var b=this.m_MInfo.m_App;b.forEachView(function(c){this.addToView(c)},this);if(b.m_TextView){b.m_TextView.AddOrUpdateMarker(this)}b.fireEvent("marker_created",this)},getCreateParams:function(f,b){var d="marker_"+b+"_"+this.marker_num;var c=!(this.flags&SeqView.MarkerFlags.Hollow);var e=this.flags&SeqView.MarkerFlags.UserLock;return{template:(f?SeqView.Marker.getPanoramaTmpl(c):SeqView.Marker.getGraphicTmpl(c)),options:{id:d,qtip:this.visible_name,color:this.color,num:this.marker_num,trimmed_label:this.marker_name_trimmed,label_length:e?this.marker_name_back_lock:this.marker_name_back,font_size:this.m_MInfo.m_App.m_Portal?"font-size:0.85em;":"",lock:e?"inline":"none",prefix:this.m_MInfo.m_App.m_CGIs.html_prefix}}},addToView:function(d){if(d.isAlignment()){return}var c="marker_"+d.m_Idx+"_"+this.marker_num;var b=d.createMarkerElem(this);this.m_MInfo.m_AllMarkers[c]=this;var e=Ext.get(c+"_line");var f=d.m_Height;if(d.m_FromCgi){f=d.m_FromCgi.img_height}e.setHeight(f-18);b.setHeight(f);this.lines_in_views[d.m_Idx]=e;this.marker_in_views[d.m_Idx]=b;this.updateMarkerPos(d);b.on({mousedown:this.onMouseDown,contextmenu:this.onContextMenu,scope:this})},removeFromView:function(c){var b="marker_"+c.m_Idx+"_"+this.marker_num;if(this.marker_in_views[c.m_Idx]){this.marker_in_views[c.m_Idx].remove();delete this.m_MInfo.m_AllMarkers[b]}},lockMarker:function(){if(this.flags&SeqView.MarkerFlags.SystemLock){return}this.flags=this.flags^SeqView.MarkerFlags.UserLock;this.m_MInfo.m_App.forEachView(function(d){var c="the_marker_"+d.m_Idx+"_"+this.marker_num+"_lock";var f="the_marker_"+d.m_Idx+"_"+this.marker_num+"_back";var e=Ext.get(c);var g=Ext.get(f);if(e){var b=e.getStyle("display");e.setStyle("display",b=="none"?"inline":"none");if(!d.isPanorama()){g.setStyle("width",""+((this.flags&SeqView.MarkerFlags.UserLock)?this.marker_name_back_lock:this.marker_name_back)+"px")}}},this);if(this.m_MInfo.m_App.m_TextView){this.m_MInfo.m_App.m_TextView.UpdateLockMarker(this)}},deleteMarker:function(){this.m_MInfo.m_App.forEachView(function(b){this.removeFromView(b)},this);if(this.m_MInfo.m_App.m_TextView){this.m_MInfo.m_App.m_TextView.RemoveMarker(this)}this.deleted=true;this.m_MInfo.m_App.fireEvent("marker_deleted",this)},getMarker:function(b){var c=b.split("_");view=this.m_MInfo.m_App.findView(c[1]);marker=this.marker_in_views[c[1]];return{view:view,marker:marker}},setCursor:function(b,c){this.getMarker(b).marker.setStyle("cursor",c)},getSeqPos:function(c,f){var e=c.split("_");var b=this.m_MInfo.m_App.findView(e[1]);if(b){var d=f-b.m_ScrollPix;return b.pix2Seq(d)}return 0},assignName:function(c){var b=c.trimToPix(100);this.marker_name=c;this.visible_name=SeqView.sanitize(c);this.marker_name_trimmed=SeqView.sanitize(b);this.marker_name_back=b.visualLength()+2;this.marker_name_back_lock=this.marker_name_back+16},setName:function(c){this.assignName(c);this.m_MInfo.m_App.forEachView(function(e){if(e.isAlignment()){return}var d="marker_"+e.m_Idx+"_"+this.marker_num;var i="the_marker_"+e.m_Idx+"_"+this.marker_num+"_back";var f="marker_"+e.m_Idx+"_"+this.marker_num+"_label";var l=Ext.get(d);var k=Ext.get(i);var h=Ext.get(f);l.dom.setAttribute("ext:qtip",this.visible_name);if(h){var g=h.dom.innerHTML;g=g.slice(g.indexOf("<"),g.length);h.update(this.marker_name_trimmed+" "+g);h.dom.setAttribute("ext:qtip",this.visible_name);k.setStyle("width",""+((this.flags&SeqView.MarkerFlags.UserLock)?this.marker_name_back_lock:this.marker_name_back)+"px")}},this);var b=Ext.get("seqtext-marker_"+this.m_MInfo.m_App.m_Idx+"_"+this.marker_num);if(b){b.dom.setAttribute("ext:qtip",this.visible_name)}},setSeqPos:function(c,b){this.seq_pos=c;this.m_MInfo.m_App.forEachView(function(d){if(d.isAlignment()){return}this.updateMarkerPos(d)},this);if(b){this.m_MInfo.updateInfo()}if(b&&this.m_MInfo.m_App.m_TextView){this.m_MInfo.m_App.m_TextView.SetSeqPos(this)}},setSeqRange:function(b,c){var d=b[0];if(b[1]&&b[1]>d){this.span=b[1]-d+1}else{this.span=0}this.setSeqPos(d,c)},setTop:function(b){this.marker.setTop(b)},movePix:function(d,i,h){var f=this.getMarker(d);var c=f.marker.getLeft(true)-i;var g=SeqView.Marker.getWidth();if(h){c=Math.max(-g,c);var b=f.view.getMostRightPix();c=Math.min(b-2-f.marker.getWidth()+g,c)}var e=c+g-f.view.m_ScrollPix;this.seq_pos=f.view.pix2Seq(e);marker.setLeft(c);if(h){this.m_MInfo.m_App.forEachView(function(k){if(k.isAlignment()||k.m_Idx==f.view.m_Idx){return}this.updateMarkerPos(k)},this);if(this.m_MInfo.m_App.m_TextView){this.m_MInfo.m_App.m_TextView.AddOrUpdateMarker(this)}}},scrollPix:function(d,e){if(d.isAlignment()){return}var c=this.marker_in_views[d.m_Idx];var b=c.getLeft(true)-e;c.setLeft(b)},updateMarkerSize:function(c){if(c.isAlignment()){return}var b=c.m_Idx;var d;if(this.lines_in_views[b]!=null){d=this.lines_in_views[b]}else{this.addToView(c);d=this.lines_in_views[b]}d.setHeight(c.m_FromCgi.img_height-18)},updateMarkerPos:function(i){if(i.isAlignment()){return}var d=i.m_Idx;var f=this.marker_in_views[d];var c=this.seq_pos-(this.span?0.5:0);var e=i.seq2PixScrolled(c);var l=1;var k;if(this.span){k=i.seq2PixScrolled(this.span+c);if(k<e){var h=k;k=e;e=h}l=k-e;var b=this.lines_in_views[d];b.setStyle("border-right","1px solid "+this.color);e+=1;k+=1}else{var b=this.lines_in_views[d];b.setStyle("border-right","none")}e=Math.max(-10000,Math.min(10000,e-SeqView.Marker.getWidth()));if(l>1){k=Math.max(-10000,Math.min(10000,k-SeqView.Marker.getWidth()));if(k-e>4000){var g=Math.round(i.getScreenWidth()/2);if(Math.abs(e-g)<Math.abs(k-g)){k=Math.max(g+2000,Math.min(k,e+4000));e=Math.max(e,k-4000)}else{e=Math.min(g-2000,Math.max(e,k-4000));k=Math.min(k,e+4000)}}l=k-e}f.setLeft(e);b.setWidth(l);if(l>1){f.setWidth(l+16)}},onMouseDown:function(d){if(d.button!==0){return}if((this.flags&(SeqView.MarkerFlags.SystemLock|SeqView.MarkerFlags.UserLock))||Ext.fly(d.getTarget()).hasClass("sv-drag")){this.m_PrevXY=null;this.m_CurMarker=null;return}var c=Ext.fly(d.getTarget()).findParent("div.sv-marker");if(!c){return}d.stopEvent();this.m_CurMarker=c.id;this.m_PrevXY=d.getXY();this.setCursor(this.m_CurMarker,"move");this.m_DocMouseMove=document.onmousemove;this.m_DocMouseUp=document.onmouseup;var b=this;document.onmousemove=function(f){if(!f){f=window.event}f=Ext.EventObject.setEvent(f);b.onMouseMove(f)};document.onmouseup=function(f){if(!f){f=window.event}f=Ext.EventObject.setEvent(f);b.onMouseUp(f)}},onMouseUp:function(b){if(!this.m_PrevXY||!this.m_CurMarker){return}b.stopEvent();this.setCursor(this.m_CurMarker,"pointer");this.m_PrevXY=null;this.m_CurMarker=null;document.onmousemove=this.m_DocMouseMove;document.onmouseup=this.m_DocMouseUp;this.m_DocMouseMove=null;this.m_DocMouseUp=null;this.m_MInfo.updateInfo()},onMouseMove:function(b){if(!this.m_PrevXY||!this.m_CurMarker){return}SeqView.ClearBrowserSelection();this.movePix(this.m_CurMarker,this.m_PrevXY[0]-b.getXY()[0],true);this.m_PrevXY=b.getXY()},onMouseOut:function(b){this.onMouseUp(b)},onContextMenu:function(g){g.preventDefault();g.stopPropagation();var h=new Ext.menu.Menu();h.add(this.visible_name);h.add("-");if(!(this.flags&(SeqView.MarkerFlags.UserLock|SeqView.MarkerFlags.SystemLock))){h.add({text:"Set Position/Range...",scope:this,handler:function(){this.m_MInfo.setMarkerPosition(this.marker_num)}})}h.add({text:"Rename...",scope:this,handler:function(){this.m_MInfo.renameMarker(this.marker_num)}});if(this.m_MInfo.m_App.m_Embedded===false){var d=new Ext.menu.Menu();this.m_MInfo.m_App.forEachView(function(e){if(e.isGraphic()){var l=e.toSeq();var n=(l[0]+1)+"&nbsp;-&nbsp;"+(l[1]+1);var o="Graphical View ("+n+")";var k=e.m_Color.toUpperCase();d.add({text:o,scope:this,iconCls:"color_rect_"+k,handler:function(){this.centerInView(e)}})}},this);d.add("-");d.add({iconCls:"xsv-new_fasta",text:"Sequence View",scope:this,handler:function(){this.showSequence()}});h.add({text:"Reveal Marker in...",menu:d});h.add("-")}if(!(this.flags&SeqView.MarkerFlags.SystemLock)){h.add({text:(this.flags&SeqView.MarkerFlags.UserLock)?"Unlock Marker":"Lock Marker",scope:this,handler:function(){this.lockMarker()}});h.add("-")}h.add({iconCls:"xsv-marker-remove",text:"Remove Marker",scope:this,handler:function(){this.deleteMarker();this.m_MInfo.updateInfo()}});var f=Ext.fly(g.getTarget()).findParent("div.sv-marker");var c=f.id;var i=c.split("_")[1];var b=this.m_MInfo.m_App.findView(i);if(b&&b.isGraphic()){h.add("-");h.add({iconCls:"xsv-zoom_seq",text:"Zoom To Sequence At Marker",scope:this,handler:function(){this.zoomSeqMarker(b)}})}h.add("-");h.add({iconCls:"xsv-markers",text:"Marker Details",scope:this,handler:function(){this.m_MInfo.showDlg()}});if(h.items.length>0){h.showAt(g.getXY())}},showSequence:function(){this.m_MInfo.m_App.createTextView(this.seq_pos)},centerInView:function(b){var c=b.m_VisLenSeq;var d=this.seq_pos-b.m_VisLenSeq/2;if(this.span){if(this.span<c){d+=Math.floor(this.span/2)}else{d+=b.m_VisLenSeq/3}}if(d<0){d=0}if(d+c>b.m_App.m_SeqLength){c=b.m_App.m_SeqLength-d}if(d===b.m_VisFromSeq&&c===b.m_VisLenSeq){return}b.startImageLoading(d,c)},zoomSeqMarker:function(b){var c=100;var d=this.seq_pos-c/2;b.startImageLoading(d,c)}};SeqView.MarkersInfo=(function(){function b(c){this.m_App=c;this.m_Dlg=null;this.m_AllMarkers={};this.m_AllMarkersRefs=[];this.m_MarkerColorIdx=0;this.m_NextMarkerNum=1}b.deleteMarker=function(c,d){var e=SeqView.App.findAppByIndex(c);if(e&&e.m_MarkersInfo){e.m_MarkersInfo.deleteMarker(d)}};b.setMarkerPosition=function(c,d){var e=SeqView.App.findAppByIndex(c);if(e&&e.m_MarkersInfo){e.m_MarkersInfo.setMarkerPosition(d)}};b.renameMarker=function(c,d){var e=SeqView.App.findAppByIndex(c);if(e&&e.m_MarkersInfo){e.m_MarkersInfo.renameMarker(d)}};return b})();SeqView.MarkersInfo.prototype={getNextColor:function(){var c=["green","cyan","#FF00FF","blue","red","black"];var b=c[this.m_MarkerColorIdx++];if(this.m_MarkerColorIdx>c.length-1){this.m_MarkerColorIdx=0}return b},suggestNextName:function(){return"Marker "+(this.m_NextMarkerNum)},showDlg:function(){var b=0;this.forEachMarker(function(){b++});if(b==0){this.newMarkerDlg();return}this.m_Dlg=new Ext.Window({layout:"fit",title:"Markers",minWidth:480,width:600,height:350,constrain:true,collapsible:true,listeners:{close:{scope:this,fn:function(){this.m_App.un("origin_changed",this.onOriginChanged,this);this.m_App.un("strand_changed",this.onStrandChanged,this)}}},tbar:[{text:"Add Marker",iconCls:"xsv-marker-add",tooltip:"Add New Marker",scope:this,handler:function(){this.newMarkerDlg()}},"->",{text:"Remove all markers",iconCls:"xsv-clear_markers",scope:this,handler:function(){Ext.MessageBox.confirm("Confirm","Clear all markers?",function(c){if(c!="yes"){return}this.reset()},this)}}],closeAction:"close",items:[{xtype:"panel",autoScroll:true,id:"marker-info-panel_"+this.m_App.m_Idx,layout:"fit",autoLoad:{url:this.getMarkerInfoURL(),scope:this,callback:this.loadCallback}}],buttons:[{text:"Download",scope:this,handler:function(c){var d=this.getMarkerInfoFormParams(true);c.el.insertHtml("beforeBegin",'<form action="'+this.m_App.m_CGIs.ObjCoords+'" method="get" style="display:none">'+d+"</form>").submit()}},{text:"Close",scope:this,handler:function(){this.m_Dlg.close();this.m_Dlg=null}}]});this.m_App.on("origin_changed",this.onOriginChanged,this);this.m_App.on("strand_changed",this.onStrandChanged,this);this.m_Dlg.show(this)},onOriginChanged:function(b){this.updateInfo()},onStrandChanged:function(b){if(b.getOrigin()!=0){this.updateInfo()}},addMarker:function(d,e,f,c,b){this.m_AllMarkersRefs.push(new SeqView.Marker(this,d,e,f,c,b));this.updateInfo()},addMarkerByData:function(b){this.addMarker(b[0],b[1],b[2],b[3],b[4])},newMarkerDlg:function(c,f){var c,f,b;if(arguments.length<2){b=this.m_App.m_SeqLength/2}else{var e=f-c.m_ScrollPix;b=this.m_App.posToLocal(c.pix2Seq(e))}var d=new Ext.Window({layout:"form",modal:true,title:"Set New Marker",width:270,autoHeight:true,collapsible:false,constrain:true,resizable:false,closeAction:"close",iconCls:"xsv-markers",items:[{xtype:"form",bodyStyle:"padding:5px;",labelWidth:70,frame:true,labelAlign:"right",items:[{xtype:"textfield",name:"name",width:"90%",fieldLabel:"Name",value:this.suggestNextName()},{xtype:"textfield",name:"position",width:"90%",fieldLabel:"Pos/Range",value:b},{xtype:"checkbox",name:"lock",height:24,labelSeparator:"",boxLabel:"Lock Marker",checked:false}]}],buttons:[{text:"Ok",scope:this,handler:function(){values=d.items.items[0].getForm().getValues();name=values.name;var g=this.m_App.parsePosOrRange(values.position);if(typeof g==="undefined"){Ext.MessageBox.show({title:"Set New Marker",msg:"Invalid sequence position.",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}else{if(name.length==0||name.length>50){Ext.MessageBox.show({title:"Set New Marker",msg:"Invalid marker name.",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}else{d.close();this.addMarker(g,name,values.lock=="on")}}}},{text:"Cancel",handler:function(){d.close()}}]});d.show()},getMarkerInfoURL:function(f,h){var d=this.m_App.m_CGIs.ObjCoords+"?id="+this.m_App.GI;if(f){d+="&download=true";if(h){d+="&format="+h}else{d+="&format=tsv"}}var b=[];this.forEachMarker(function(i){b.push(i.seq_pos);if(i.span){b.push(i.seq_pos+i.span-1)}});var c=b.sort(function(l,i){return l-i});var k=[c[0]];for(var e=1,g=c[0];e<c.length;e++){if(c[e]!=g){k.push(c[e])}g=c[e]}for(var e=0;e<k.length;e++){d+="&pos="+k[e]}return d},getMarkerInfoFormParams:function(d,f){var g='<input type="hidden" name="id" value="'+this.m_App.GI+'">';if(d){g+='<input type="hidden" name="download" value="true">';if(f){g+='<input type="hidden" name="fmt" value="'+f+'">'}else{g+='<input type="hidden" name="fmt" value="csv">'}}var b=[];var e=[];this.forEachMarker(function(h){b.push(h.seq_pos);e.push(h.visible_name);if(h.span){b.push(h.seq_pos+h.span-1);e.push(h.visible_name)}});for(var c=0;c<b.length;c++){g+='<input type="hidden" name="pos" value="'+b[c]+'">';g+='<input type="hidden" name="name" value="'+e[c]+'">'}return g},loadCallback:function(d,g,c,b){var e=Ext.decode(c.responseText);var f="";this.forEachMarker(function(h){f+=this.parseObjCoords(e,h)},this);if(f.length==0){f='<div style="color:gray;margin-top:10px;" align="center">No Markers To Display</div>'}d.update(f)},parseObjCoords:function(n,e){var d=n;var k=e.seq_pos;var l;if(e.span){l=k+e.span-1}var f="";var o=this.m_App.m_ViewParams.organism=="Homo sapiens";var h=-1;for(var c=0;c!=d.length;c++){var g=d[c];var b=g.marker_pos;if(b!=k&&b!=l){continue}if(f.length==0){f+='<table class="xsv-markerinfo" width="98%">';f+="<tr><th><b>Name:</b> "+e.visible_name;f+=' (<a href="#" onClick="SeqView.MarkersInfo.renameMarker('+this.m_App.m_Idx+","+e.marker_num+');">Edit</a>)</th>';f+='<th width="75%" colspan='+(o?4:3)+">Position: "+e.displayPos();f+=' (<a href="#" onClick="SeqView.MarkersInfo.setMarkerPosition('+this.m_App.m_Idx+","+e.marker_num+');">Edit</a>)';f+='<a href="#" onClick="SeqView.MarkersInfo.deleteMarker('+this.m_App.m_Idx+","+e.marker_num+');" class="xsv-marker_remove_link">Remove</a>';f+="</th></tr>";if(o){f+='<tr><th width="25%">Accession/Locus tag</th><th width="10%">Location</th><th width="10%">Relative to</th><th width="30%"><a href="http://www.hgvs.org/mutnomen" target="_blank">HGVS Name</a></th><th width="25%">Sequence</th></tr>'}else{f+='<tr><th width="25%">Accession/Locus tag</th><th width="20%">Location</th><th width="10%">Relative to</th><th width="45%">Sequence</th></tr>'}}f+=this.addMarkersRow(g,o,false,h!=b);if(h!=b&&this.m_App.m_Origin){f+=this.addMarkersRow(g,o,true)}h=b}f+="</table>";return f},addMarkersRow:function(h,f,g,c){var b="";if(typeof(h.pos_mapped)!="undefined"){b=h.pos_mapped;if(g){b=this.m_App.posToLocal(b)}else{if(b>=0){b+=1}}}if(!f&&b.length==0){return""}var e=c?'<tr class="sv-rowgroup">':"<tr>";e+="<td>"+h.title+"</td>";e+="<td>"+b+"</td>";var d=h.hgvs_position;var i="Seq start";if(g){i="Current origin"}else{if(d&&d[0]=="c"){i="CDS start"}}e+="<td>"+i+"</td>";if(f){if(d&&h.title){d=h.title+":"+d}e+="<td>"+d+"</td>"}e+='<td><span style="font-family:monospace">'+h.sequence+"</span></td>";e+="</tr>";return e},updateInfo:function(){var b=Ext.getCmp("marker-info-panel_"+this.m_App.m_Idx);if(b){b.getUpdater().update({url:this.getMarkerInfoURL(),scope:this,callback:this.loadCallback})}},deleteMarker:function(b){var c=this.forEachMarker(function(d){if(d.marker_num==b){d.deleteMarker();return false}});if(c){this.updateInfo()}},setMarkerPosition:function(c){var b=null;this.forEachMarker(function(e){if(e.marker_num==c){b=e}});if(!b){return}var d=b.displayLocalPos();Ext.MessageBox.prompt(b.visible_name,"New sequence position/range:",function(f,g){if(f!="ok"||g.length==0){return}var e=this.m_App.parsePosOrRange(g,true);if(typeof e==="undefined"){Ext.MessageBox.show({title:b.visible_name,msg:"Invalid sequence position/range.",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});return}b.setSeqRange(e,true)},this,false,d)},renameMarker:function(c){var b=null;this.forEachMarker(function(d){if(d.marker_num==c){b=d}});if(!b){return}Ext.MessageBox.prompt("Marker","Please enter new marker name:",function(d,e){if(d!="ok"||e.length==0){return}b.setName(e);this.updateInfo()},this,false,b.marker_name)},reset:function(){for(var b in this.m_AllMarkers){if(this.m_AllMarkers[b]){this.m_AllMarkers[b].deleteMarker()}}this.updateInfo();this.m_AllMarkersRefs=[];this.m_MarkerColorIdx=0;this.m_NextMarkerNum=1},updateMarkersSize:function(b){this.forEachMarker(function(c){c.updateMarkerSize(b)})},updateMarkersPos:function(b){this.forEachMarker(function(c){c.updateMarkerPos(b)})},scrollMarkers:function(b,c){this.forEachMarker(function(d){d.scrollPix(b,c)})},forEachMarker:function(f,e){var g=this.m_AllMarkersRefs;for(var d=0,c=g.length;d<c;d++){var b=g[d];if(!b.deleted){if(f.call(e||b,b,d,g)===false){return(d+1)}}}return 0},findMarker:function(b){return this.m_AllMarkers[b]},hasMarkers:function(){return this.m_AllMarkersRefs.length>0},parseMarkersURL:function(k,f){var l=cbSplit(f,",");while(l.length){var d=l.splice(0,1)[0];while(l.length&&d.charAt(d.length-1)=="\\"){d=d.substr(0,d.length-1)+","+l.splice(0,1)[0]}var p=false;var q=d.charAt(d.length-1);if(q==="!"){p=true;d=d.substr(0,d.length-1)}var g=d.split("|");var o=g.splice(0,1)[0].split(":");var c=g.splice(0,1)[0];while(g.length&&c.charAt(c.length-1)=="\\"){c=c.substr(0,c.length-1)+"|"+g.splice(0,1)[0]}c=SeqView.unescapeName(c);var i=g.splice(0,1)[0];var e=g.length>0?parseInt(g.splice(0,1)[0]):0;if(p){e=e|SeqView.MarkerFlags.UserLock}var n;var h=SeqView.stringToNum(o[0])-1;if(o.length>1){n=[h,SeqView.stringToNum(o[1])-1]}else{n=[h]}var b={red:"ff0000",green:"008000",blue:"0000ff",black:"000000",cyan:"00ffff"};if(i&&i[0]!="#"){if(/^[0-9a-fA-F]+$/.test(i)){i="#"+i}else{i="#"+b[i]}}k.push([n,c,e,i])}},parseMarkersOldStyle:function(g,b,k){for(var e=0;e<b.length;e++){var c=b[e];var d=0;if(c.indexOf("!")!=-1){d=d|SeqView.MarkerFlags.UserLock;c=c.replace(/!/,"")}var h=c.split(":");var f=SeqView.stringToNum(h[0])-1;var i;if(h.length>1){i=[f,SeqView.stringToNum(h[1])-1]}else{i=[f]}g.push([i,k[e],d])}},getMarkersURL:function(){var c="";this.forEachMarker(function(d){if(c.length>0){c+=","}else{c="&mk="}c+=d.displayPos();c+="|"+SeqView.escapeName(d.marker_name);var e=d.color.charAt(0)==="#"?d.color.slice(1):d.color;c+="|"+e;if(d.flags){c+="|"+d.flags}});var b="";if(this.m_Dlg&&this.m_Dlg.isVisible()){b="&vm=true"}return c+b}};SeqView.colorBarTPL=new Ext.Template('<div id="view_color_{idx}" style="width:15px;height:15px;background-color:#{color};border:1px black solid;">&nbsp;</div>');SeqView.View=(function(){var b=0;var d=4;function c(e,f){this.clear();this.m_Type=e;this.m_App=f;this.m_Idx=b++}c.getSpacerHeight=function(){return d};return c})();SeqView.View.prototype={getWidth:function(){return this.m_Width},getHeight:function(){return this.m_Height},isPanorama:function(){return false},isGraphic:function(){return false},isAlignment:function(){return false},getMostRightPix:function(){return 0},getScreenWidth:function(){return this.m_View.getInnerWidth()-2},getXY:function(){return this.m_View.getEl().getXY()},createChooseColorBtn:function(){var c;if(!this.m_Color||this.m_Color.length==0){var b=new Ext.ColorPalette();c=b.colors[Math.round(Math.random()*b.colors.length)];this.m_Color=c}else{c=this.m_Color}return{text:SeqView.colorBarTPL.apply({idx:this.m_Idx,color:c}),tooltip:"View Color",menu:new Ext.menu.ColorMenu({listeners:{select:function(d,e){Ext.get("view_color_"+this.m_Idx).setStyle("background-color","#"+e);this.m_Color=e;if(this.m_Locator){this.m_Locator.setColor(e)}this.m_App.reCreateReflections()},scope:this}})}},createCloseTBar:function(){return{id:"close",qtip:"Close View",scope:this,handler:function(f,d,c){this.m_App.viewIsClosing(this);var b=c.view;if(b){b.remove()}}}},clear:function(){this.m_Loading=false;this.m_Theme=null;this.m_TopOffset=0;this.m_ScrollPix=0;this.m_DivId=null;this.m_FromCgi=null;this.m_View=null;this.m_ReqNum=0;this.m_Width=0;this.m_Height=0;this.m_Color=null,this.m_Spacer=null,this.m_Locator=null},destroy:function(){if(this.m_Locator){this.m_Locator.remove()}if(this.m_View){if(this.m_Spacer){this.m_View.ownerCt.remove(this.m_Spacer,true)}this.m_View.ownerCt.remove(this.m_View,true)}this.clear()},remove:function(){this.destroy();this.m_App.removeView(this)},updateTitle:function(){},refresh:function(){},addURLParams:function(){return this.m_App.addURLParams(this)},isLoading:function(){return this.m_Loading},moveTo:function(b,c){}};SeqView.Panorama=(function(){var b=18;return Ext.extend(SeqView.View,{m_PrevXY:null,m_CurLocator:null,m_ResizeLeft:false,m_ResizeRight:false,m_ActionNeeded:false,m_Scroll:false,constructor:function(c){SeqView.Panorama.superclass.constructor.apply(this,["panorama",c]);this.m_TopOffset=b;this.m_DivId="panorama_id";this.m_View=this.m_App.addView({html:'<div id="'+this.m_DivId+'" class="panorama_div"><div id="pan-holder" class="pan-holder"/>'});Ext.get(this.m_DivId).on({mousedown:this.onMouseDown,contextmenu:this.onContextMenu,scope:this})},isPanorama:function(){return true},loadImage:function(){this.m_Width=this.getScreenWidth();if(this.m_Width==-2){return}this.m_Loading=true;var d=this.m_App.m_CGIs.Panorama;var e={theme:"NCBI Overview",id:this.m_App.GI,width:this.m_Width};Ext.apply(e,this.addURLParams());var c=this.m_ReqNum+1;this.m_ReqNum=c;this.m_App.AjaxRequest({url:d,scope:this,opts:{req_num:c},params:e,method:"POST",success:this.checkJobStatus,failure:this.loadFailure})},checkJobStatus:function(f,h){var g=Ext.decode(f.responseText);if(g.job_status){if(g.job_status=="failed"){this.loadFailure(g.error_message)}else{if(g.job_status=="canceled"){this.loadFailure("Job canceled")}else{var e=this.m_App.m_CGIs.Panorama+"?job_key="+g.job_id;this.m_App.AjaxRequest.defer(2000,this,[{url:e,scope:this,opts:h.opts,success:this.checkJobStatus,failure:this.loadFailure}])}}}else{if(this.m_ReqNum>h.opts.req_num){return}if(g.success===false){this.loadFailure(g.msg)}else{this.m_FromCgi=g;this.m_Height=this.m_FromCgi.img_height+b+1;var i=Ext.get(this.m_DivId);var l=i.first("img");if(l){var k=Ext.getDom(l);k.src=g.img_url}else{var c=new Ext.Template('<img src="{img_url}">'),l=c.append(i,g,true)}i.setStyle("height",this.m_Height+"px");this.m_View.setHeight(this.m_Height+2);this.m_App.updateMarkersSize(this);this.m_App.updateMarkersPos(this);this.m_Loading=false;this.m_App.notifyViewLoaded(this)}}},loadFailure:function(c,e){if(typeof c=="string"){Ext.MessageBox.show({title:"Image loading error",msg:c,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO})}else{var d=Ext.decode(c.responseText)}},toPix:function(c){return c*this.m_Width/this.m_App.m_SeqLength},toSeq:function(c){return Math.round(this.m_App.m_SeqLength*c/this.m_Width)},seq2Pix:function(c){return this.toPix(c)},seq2PixScrolled:function(c){return this.seq2Pix(c)+this.m_ScrollPix},pix2Seq:function(c){return this.toSeq(c)},refresh:function(){this.loadImage()},getMostRightPix:function(){return this.getWidth()},onMouseDown:function(c){},onMouseUp:function(c){},onMouseMove:function(c){},onMouseOut:function(c){},onContextMenu:function(d){d.preventDefault();d.stopPropagation();var f=new Ext.menu.Menu();var c=d.getPageX()-Ext.get(this.m_DivId).getX();f.add({text:"Set New Marker At Position",iconCls:"xsv-markers",scope:this,handler:function(){this.m_App.newMarkerDlg(this,c)}});f.add("-");if(this.m_App.m_Origin){f.add({text:"Reset Sequence Origin",iconCls:"xsv-origin",scope:this,handler:function(){this.m_App.clearOrigin()}})}else{f.add({text:"Set Sequence Origin At Position",iconCls:"xsv-origin",scope:this,handler:function(){this.m_App.setOrigin(this,c)}})}if(f.items.length>0){f.showAt(d.getXY())}},onResize:function(c){},createMarkerElem:function(c){var d=Ext.get(this.m_DivId);var f=c.getCreateParams(true,this.m_Idx);var e=f.template.append(d,f.options,true);e.setTop(b+3);return e}})})();SeqView.TextView=(function(){var d=100;var c=new Ext.Template('<table width="{width}" class="xsv-fasta-table" style="border-style:solid;border-width:{border}px;" >','<tbody><tr bordercolor="#ffffff"><td id="left_sequence_{id}" width=50 valign="top" align="right"><br><NOBR><em>{left_nums}</em></NOBR></td>','<td valign="top"><span id="top_sequence_{id}"><em>{top_nums}</em></span><br/><div id="text_sequence_{id}">{sequence}</div></td>',"</tr></tbody></table>");function b(f){var e="seq-dlg_"+f.m_Idx;if(Ext.get(e)){return}this.m_App=f;this.m_Idx="S"+this.m_App.m_Idx;this.m_DivId=e;this.m_Color="000000";this.m_FromSeq=0;this.m_LenSeq=0;this.m_ShowTranslation=true;this.m_SequenceCols=Ext.isWindows?90:100;this.m_SeqStarts=[];this.m_Locator=null;this.m_PrevXY=[];this.m_Flip=false;this.m_TextViewSize=this.m_SequenceCols*d;this.m_SelectedFeat="";this.m_HideTrans=1}b.getViewTmpl=function(){return c};b.getTextViewRows=function(){return d};return b})();SeqView.TextView.prototype={canFlip:function(){return this.m_App.m_ViewParams.acc_type=="DNA"},getTitle:function(){var b="Sequence View";if(this.canFlip()){b+=(this.m_Flip?" (negative":" (positive")+" strand)"}return b},openDlg:function(c){if(this.m_SeqDlg){return}var e,b;if(typeof c=="number"){e=Math.max(0,c-949)}else{if(Ext.isArray(c)){e=c[0];b=c[1];this.m_Flip=c[2]}else{if(c.isPanorama()){e=Math.max(0,this.m_App.m_SeqLength/2-this.m_TextViewSize/2)}else{this.m_Flip=c.getFlip();var d=c.toSeq();e=Math.max(0,d[0]+d[2]/2-this.m_TextViewSize/2)}e=Math.round(e/10)*10}}b=Math.min(e+this.m_TextViewSize,this.m_App.m_SeqLength)-e;this.displaySequenceTextDlg(e,b)},displaySequenceTextDlg:function(c,b){this.m_FromSeq=c;this.m_LenSeq=b;this.m_Locator=new SeqView.Locator(this,this.m_Color,false);this.m_SeqDlg=new Ext.Window({layout:"fit",title:this.getTitle(),minWidth:480,width:850,height:450,minHeight:200,constrain:false,collapsible:true,maximizable:true,hideAction:"close",onEsc:function(){this.m_SeqDlg.close()},listeners:{resize:function(k,d,n){var h="top_sequence_"+this.m_App.m_Idx;var g="left_sequence_"+this.m_App.m_Idx;var l=document.getElementById(h);if(!l){return}var i=Ext.get(g).getWidth()+40;var f=l.offsetWidth;var e=f/this.m_SequenceCols;this.m_SequenceCols=Math.floor((d-i)/e/10)*10;this.m_TextViewSize=this.m_SequenceCols*SeqView.TextView.getTextViewRows();this.m_LenSeq=Math.min(this.m_TextViewSize,this.m_App.m_SeqLength);Ext.getCmp("seq-panel_"+this.m_App.m_Idx).getUpdater().update({url:this.getSeqTextURL(),scope:this,callback:this.seqLoadCallback})},move:function(e,d,f){if(f<0){this.m_SeqDlg.setPagePosition(d,0)}},close:function(){if(this.m_Locator){this.m_Locator.remove()}this.m_Locator=null;this.m_App.un("origin_changed",this.onOriginChanged,this);this.m_App.un("strand_changed",this.flipSeqPanelStrand,this);this.m_App.m_TextView=null;this.m_App.reCreateReflections();this.m_SeqDlg=null},scope:this},id:this.m_DivId,tbar:[{text:"Prev Page",scope:this,iconCls:"xsv-prev",handler:this.gotoSequencePrev},"-",{text:"Next Page",scope:this,iconCls:"xsv-next",handler:this.gotoSequenceNext},"->",{xtype:"combo",id:"triplets_combo_"+this.m_App.m_Idx,name:"triplets",fieldLabel:"triplets",mode:"local",forceSelection:"true",valueField:"object_id",hidden:true,triggerAction:"all",store:new Ext.data.JsonStore({fields:["object_id","name"],root:"triplets",data:{triplets:[]}}),displayField:"name",width:250,listeners:{select:function(g,f,e){var d=g.getStore();if(e!=d.active){this.m_SelectedFeat=f.data.object_id;Ext.getCmp("seq-panel_"+this.m_App.m_Idx).getUpdater().update({url:this.getSeqTextURL(),scope:this,callback:this.seqLoadCallback})}},scope:this}}," ",{tooltip:"Printer-Friendly Page",iconCls:"printer",scope:this,handler:function(){SeqView.App.showPrintPageDlg(this.m_App.m_Idx)}},"-",{text:"Flip Strands",id:"seq-flip-button",tooltip:"Flip Sequence Strands",iconCls:"xsv-flip-strands",pressed:this.m_Flip,enableToggle:true,hidden:!this.canFlip(),scope:this,handler:function(){this.m_App.setFlip(!this.m_Flip)}},this.m_App.m_ViewParams.acc_type!="DNA"?{hidden:true}:"-",{text:this.translationName(),id:"seq_trans_btn",tooltip:"Flip Translation",iconCls:"xsv-show_translation",hidden:this.m_App.m_ViewParams.acc_type!="DNA",menuAlign:"tr-br?",menu:new Ext.menu.Menu({items:[{text:"Annotated",checked:this.m_HideTrans===1,group:true,scope:this,handler:function(){this.m_HideTrans=1;this.flipSeqTranslation()}},{text:"Conceptual",checked:this.m_HideTrans===2,group:true,scope:this,handler:function(){this.m_HideTrans=2;this.flipSeqTranslation()}},{text:"Both",checked:this.m_HideTrans===0,group:true,scope:this,handler:function(){this.m_HideTrans=0;this.flipSeqTranslation()}},{text:"None",checked:this.m_HideTrans===3,group:true,scope:this,handler:function(){this.m_HideTrans=3;this.flipSeqTranslation()}}]})},this.m_App.m_ViewParams.acc_type!="DNA"?{hidden:true}:"-",{text:"Go To Position",iconCls:"xsv-goto_position",scope:this,handler:this.gotoSeqPositionDlg}],modal:false,items:[{xtype:"panel",autoScroll:true,id:"seq-panel_"+this.m_App.m_Idx,layout:"fit",autoLoad:{url:this.getSeqTextURL(),scope:this,callback:this.seqLoadCallback}}],buttons:[{text:"Close",scope:this,handler:function(){this.m_SeqDlg.close()}}]});this.m_App.on("origin_changed",this.onOriginChanged,this);this.m_App.on("strand_changed",this.flipSeqPanelStrand,this);this.m_SeqDlg.show(this)},onOriginChanged:function(b){this.startImageLoading(this.m_FromSeq,this.m_LenSeq)},startImageLoading:function(c,b){this.m_FromSeq=c;this.m_LenSeq=b;Ext.getCmp("seq-panel_"+this.m_App.m_Idx).getUpdater().update({url:this.getSeqTextURL(),scope:this,callback:this.seqLoadCallback})},getSeqTextURL:function(){var b=this.m_FromSeq+this.m_LenSeq;return this.m_App.m_CGIs.Sequenc+"?opts=seq&id="+this.m_App.GI+"&from="+this.m_FromSeq+"&to="+b+"&col="+this.m_SequenceCols+"&translation="+(this.m_ShowTranslation?"true":"false")+"&reverse="+(this.m_Flip?"true":"false")+"&selected="+this.m_SelectedFeat},genTopNumbers:function(){var b="";for(var c=0;c!=this.m_SequenceCols/10;c++){if(this.m_Flip){b+="<span>0</span>987654321"}else{b+="123456789<span>0</span>"}}return b},seqLoadCallback:function(d,p,E,g){var h=Ext.decode(E.responseText);var i=h.starts;var C=0;this.m_SeqStarts=[];while(true){var A=i.indexOf("<",C);if(A==-1){break}var l=i.substr(A+1,1);if(l=="d"){var n=i.substr(A+16,13);if(n=="seqtrans_prot"){this.m_SeqStarts.push(-2)}else{this.m_SeqStarts.push(-1)}C=A+6}else{if(l=="b"){var r=parseInt(i.substr(C,A-C));this.m_SeqStarts.push(r);C=A+4}else{if(l=="/"){C=A+6}else{break}}}}if(this.m_App.getOrigin()!=0||this.m_App.getFlip()){var z="";re=/([^0-9]*)([0-9]+)(<br>)/ig;var c;while((c=re.exec(i))!=null){z+=(c[1]+this.m_App.posToLocal(c[2])+c[3])}i=z}var B=this.genTopNumbers();var s=SeqView.TextView.getViewTmpl().apply({border:0,width:"95%",left_nums:i,top_nums:B,id:this.m_App.m_Idx,sequence:h.sequence});d.update(s);var u=1;var D=h.app_id?"ttl-"+h.app_id+"-":"ttl-id";while(true){var o=Ext.get(D+u);if(!o){break}var e=o.dom.getAttribute("rel").split(",");var t=e[e.length-1];var f="";for(j=0;j!=h.features.length;j++){var w=h.features[j];if(w.id==t){f=w.object_id;break}}if(f.length>0){var q=new Ext.ToolTip({target:o,trackMouse:false,autoWidth:true,autoHide:true,autoLoad:{url:this.m_App.m_CGIs.ObjInfo+"?id="+f,callback:function(H,K,G,F){var J=Ext.decode(G.responseText);var I=J[0];H.update(I.text)}},dismissDelay:5000})}u++}this.m_App.reCreateReflections();this.m_App.forEachMarker(function(F){this.AddOrUpdateMarker(F)},this);this.flipSeqTranslation();var b=Ext.getCmp("triplets_combo_"+this.m_App.m_Idx);if(h.triplets){var k=b.getStore();k.loadData(h.triplets);k.active=h.triplets.selected||0;this.m_SelectedFeat=k.getAt(k.active).data.object_id;b.setValue(this.m_SelectedFeat);b.show();b.collapse()}else{b.hide();this.m_SelectedFeat=""}Ext.get(this.m_DivId).on({mousedown:this.onMouseDown,mouseup:this.onMouseUp,mousemove:this.onMouseMove,contextmenu:this.onContextMenu,scope:this});this.m_App.updateLocator(this)},AddOrUpdateMarker:function(e){var f=Ext.get("text_sequence_"+this.m_App.m_Idx);if(f){var d=this.getLineHeight();var g=this.getCharWidth();if(e.span){var b=Ext.get("seqtext-marker_"+this.m_App.m_Idx+"_"+e.marker_num+"_b");if(!b){var c=new Ext.Template('<div orig_id="marker_0_{num}" id="seqtext-marker_{aidx}_{num}_b" ext:qtip="start of {name}" class="xsv-text_marker" style="border-color:{color};border-{side}: none; height:{height}; width:{width};"><div ext:qtip="Locked" id="seqtext-marker_{aidx}_{num}_lock_b" style="display:{lock};" class="marker_locked_ov"></div> </div>');b=c.append(f,{num:e.marker_num,aidx:this.m_App.m_Idx,color:e.color,name:e.marker_name,lock:e.lock?"inline":"none",side:this.m_App.getFlip()?"left":"right",height:d-2,width:g-2},true)}this.setTextMarker(b,e.seq_pos);b=Ext.get("seqtext-marker_"+this.m_App.m_Idx+"_"+e.marker_num+"_e");if(!b){var c=new Ext.Template('<div orig_id="marker_0_{num}" id="seqtext-marker_{aidx}_{num}_e" ext:qtip="end of {name}" class="xsv-text_marker" style="border-color:{color};border-{side}: none;height:{height}; width:{width};"><div ext:qtip="Locked" id="seqtext-marker_{aidx}_{num}_lock_e" style="display:{lock};" class="marker_locked_ov"></div> </div>');b=c.append(f,{num:e.marker_num,aidx:this.m_App.m_Idx,color:e.color,name:e.marker_name,lock:e.lock?"inline":"none",side:this.m_App.getFlip()?"right":"left",height:d-2,width:g},true)}this.setTextMarker(b,e.seq_pos+e.span-1)}else{var b=Ext.get("seqtext-marker_"+this.m_App.m_Idx+"_"+e.marker_num);if(!b){var c=new Ext.Template('<div orig_id="marker_0_{num}" id="seqtext-marker_{aidx}_{num}" ext:qtip="{name}" class="xsv-text_marker" style="border-color:{color};height:{height}; width:{width};"><div ext:qtip="Locked" id="seqtext-marker_{aidx}_{num}_lock" style="display:{lock};" class="marker_locked_ov"></div> </div>');b=c.append(f,{num:e.marker_num,aidx:this.m_App.m_Idx,color:e.color,name:e.marker_name,lock:e.lock?"inline":"none",height:d-2,width:g-2},true)}this.setTextMarker(b,e.seq_pos)}}},UpdateLockMarker:function(b){if(b.span){var c=Ext.get("seqtext-marker_"+this.m_App.m_Idx+"_"+b.marker_num+"_lock_b");if(c){c.setStyle("display",b.lock?"inline":"none")}c=Ext.get("seqtext-marker_"+this.m_App.m_Idx+"_"+b.marker_num+"_lock_e");if(c){c.setStyle("display",b.lock?"inline":"none")}}else{var c=Ext.get("seqtext-marker_"+this.m_App.m_Idx+"_"+b.marker_num+"_lock");if(c){c.setStyle("display",b.lock?"inline":"none")}}},RemoveMarker:function(b){if(b.span){var c=Ext.get("seqtext-marker_"+this.m_App.m_Idx+"_"+b.marker_num+"_b");if(c){c.remove()}c=Ext.get("seqtext-marker_"+this.m_App.m_Idx+"_"+b.marker_num+"_e");if(c){c.remove()}}else{var c=Ext.get("seqtext-marker_"+this.m_App.m_Idx+"_"+b.marker_num);if(c){c.remove()}}},SetSeqPos:function(b){if(b.span){var c=Ext.get("seqtext-marker_"+this.m_App.m_Idx+"_"+b.marker_num);if(c){c.remove()}}else{var c=Ext.get("seqtext-marker_"+this.m_App.m_Idx+"_"+b.marker_num+"_b");if(c){c.remove()}c=Ext.get("seqtext-marker_"+this.m_App.m_Idx+"_"+b.marker_num+"_e");if(c){c.remove()}}this.AddOrUpdateMarker(b)},getLineHeight:function(){var b=Ext.util.TextMetrics.createInstance(Ext.get("top_sequence_"+this.m_App.m_Idx));return b.getHeight("A")},getCharWidth:function(){var b=Ext.util.TextMetrics.createInstance(Ext.get("top_sequence_"+this.m_App.m_Idx));return b.getWidth("A")},setTextMarker:function(e,f){if(f<this.m_FromSeq||f>=this.m_FromSeq+this.m_LenSeq-1){e.setVisible(false);return}else{e.setVisible(true)}var k=Ext.get("left_sequence_"+this.m_App.m_Idx).getWidth()+2;var c=document.getElementById("top_sequence_"+this.m_App.m_Idx).offsetWidth;var d=c/this.m_SequenceCols;var n=this.getLineHeight();var l=n+1;var o=2;var b=0;var g;if(this.m_Flip){for(g=0;g!=this.m_SeqStarts.length;g++){b=this.m_SeqStarts[g];if(b<0){if((b!=-this.m_HideTrans||this.m_HideTrans==0)&&this.m_HideTrans!=3){o+=l}}else{o+=n}if(b<0){continue}if(f>=b-this.m_SequenceCols&&f<b){break}}pos_h=b-f-1;var h=k+d*pos_h-1;if(Ext.isIE){h+=2}e.setLeft(h)}else{for(g=0;g!=this.m_SeqStarts.length;g++){b=this.m_SeqStarts[g];if(b<0){if((b!=-this.m_HideTrans||this.m_HideTrans===0)&&this.m_HideTrans!==3){o+=l}}else{o+=n}if(b<0){continue}if(f>=b&&f<b+this.m_SequenceCols){break}}var h=k+d*(f-b)-1;if(Ext.isIE){h+=2}e.setLeft(h)}e.setTop(o-2)},SeqText2SeqPos:function(d,k){var l=Ext.get("left_sequence_"+this.m_App.m_Idx).getWidth()+2;var e=document.getElementById("top_sequence_"+this.m_App.m_Idx).offsetWidth;var f=e/this.m_SequenceCols;var q=this.getLineHeight();var n=q+1;var g=0;var p=0;var o=0;var c=0;d=d-(q+2);var b=-1;var r=q/2;for(var h=0;h!=this.m_SeqStarts.length;h++){c=this.m_SeqStarts[h];if(c<0){if((c!=-this.m_HideTrans||this.m_HideTrans==0)&&this.m_HideTrans!=3){o+=n}if(d<=o-r){break}else{continue}}b=c;if(d>=o-r&&d<o+q-r){break}o+=q}p=Math.ceil((k-l)/f);if(this.m_Flip){return b-p-1}else{return b+p}},onMouseDown:function(f){if(f.button===0){var d=f.getTarget().id;if(d.indexOf("seqtext-marker_")!=0){return}var b=d.split("_")[2];var c=this.m_App.findMarker("marker_0_"+b);if(!c||c.lock){return}this.m_PrevXY=f.getXY();this.m_CurMarker=Ext.get(d);this.m_CurMarker.setStyle("cursor","move")}},onMouseUp:function(g){if(!this.m_PrevXY||!this.m_CurMarker){return}var i=this.m_CurMarker.dom.getAttribute("orig_id");var d=this.m_App.findMarker(i);var c=this.SeqText2SeqPos(this.m_CurMarker.getTop(true),this.m_CurMarker.getLeft(true));if(d){if(d.span){var f=this.m_CurMarker.id;if(f.indexOf("_b")!=-1){var b=Ext.get("seqtext-marker_"+this.m_App.m_Idx+"_"+d.marker_num+"_e");if(b){this.setTextMarker(b,c+d.span-1)}d.setSeqPos(c,false)}else{var b=Ext.get("seqtext-marker_"+this.m_App.m_Idx+"_"+d.marker_num+"_b");var h=c-d.span+1;if(b){this.setTextMarker(b,h)}d.setSeqPos(h,false)}}else{d.setSeqPos(c,false)}this.setTextMarker(this.m_CurMarker,c)}this.m_PrevXY=null;this.m_CurMarker=null},onContextMenu:function(f){f.preventDefault();f.stopPropagation();var d=f.getTarget().id;if(d.indexOf("seqtext-marker")==0){var g=new Ext.menu.Menu();var b=d.split("_")[2];var c=this.m_App.findMarker("marker_0_"+b);if(c){g.add(c.marker_name);g.add("-");g.add({text:"Set To Position...",scope:this,handler:function(){var e=c.seq_pos-this.m_App.getOrigin();if(e>=0){e++}Ext.MessageBox.prompt("Marker","Please enter new sequence position:",function(i,k){if(i!="ok"||k.length==0){return}var h=this.m_App.convertRelativePosition(k);if(isNaN(h)||h<0||h>=this.m_App.m_SeqLength){Ext.MessageBox.show({title:m.marker_name,msg:"Invalid sequence position.",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});return}c.setSeqPos(h,true)},this,false,e)}});g.add("-");g.add({iconCls:"xsv-marker-remove",scope:this,text:"Remove Marker",handler:function(){c.deleteMarker()}});g.add({iconCls:"xsv-markers",text:"Marker Details",scope:this,handler:function(){this.m_App.showMarkersDlg()}});g.showAt(f.getXY())}}},onMouseMove:function(o){if(!this.m_PrevXY||!this.m_CurMarker){return}var g=this.m_PrevXY[0]-o.getXY()[0];var f=this.m_PrevXY[1]-o.getXY()[1];this.m_PrevXY=o.getXY();SeqView.ClearBrowserSelection();var l=Ext.get("left_sequence_"+this.m_App.m_Idx).getWidth()+2;var d=document.getElementById("top_sequence_"+this.m_App.m_Idx).offsetWidth;var k=this.m_CurMarker.getLeft(true)-g;var c=this.m_CurMarker.getTop(true)-f;k=Math.min(k,l+d-7);k=Math.max(k,l);c=Math.min(c,Ext.get("text_sequence_"+this.m_App.m_Idx).getHeight());c=Math.max(c,Ext.get("top_sequence_"+this.m_App.m_Idx).getHeight()+1);var h=this.SeqText2SeqPos(c,k);this.m_CurMarker.setLeft(k);this.m_CurMarker.setTop(c);var q=this.m_CurMarker.dom.getAttribute("orig_id");var i=this.m_App.findMarker(q);if(i){if(i.span){var b=this.m_CurMarker.id;if(b.indexOf("_b")!=-1){var n=Ext.get("seqtext-marker_"+this.m_App.m_Idx+"_"+i.marker_num+"_e");if(n){this.setTextMarker(n,h+i.span-1)}i.setSeqPos(h,false)}else{var n=Ext.get("seqtext-marker_"+this.m_App.m_Idx+"_"+i.marker_num+"_b");var p=h-i.span+1;if(n){this.setTextMarker(n,p)}i.setSeqPos(p,false)}}else{i.setSeqPos(h,false)}}},gotoSequenceNext:function(){var b=Math.min(this.m_FromSeq+this.m_TextViewSize,this.m_App.m_SeqLength-this.m_TextViewSize);b=Math.max(0,b);this.startImageLoading(b,this.m_LenSeq)},gotoSequencePrev:function(){var b=Math.max(0,this.m_FromSeq-this.m_TextViewSize);this.startImageLoading(b,this.m_LenSeq)},translationName:function(){if(this.m_HideTrans==1){return"Annotated"}else{if(this.m_HideTrans==2){return"Conceptual"}else{if(this.m_HideTrans==3){return"None"}else{return"Both"}}}},flipSeqPanelStrand:function(){this.m_Flip=!this.m_Flip;this.startImageLoading(this.m_FromSeq,this.m_LenSeq);Ext.getCmp("seq-flip-button").toggle(this.m_Flip);if(this.m_SeqDlg){this.m_SeqDlg.setTitle(this.getTitle())}},flipSeqTranslation:function(){var b,c,d;if(this.m_HideTrans==0||this.m_HideTrans==3){b=Ext.query("div[class^=xsv-seqtrans_]");for(c=0;c<b.length;c++){d=Ext.get(b[c]);d.setStyle("display",(this.m_HideTrans==0?"block":"none"));if(this.m_HideTrans==0){Ext.util.CSS.updateRule(".xsv-ttu3","border-top-width","0px");Ext.util.CSS.updateRule(".xsv-ttu7","border-top-width","0px")}}}else{Ext.util.CSS.updateRule(".xsv-ttu3","border-top-width","2px");Ext.util.CSS.updateRule(".xsv-ttu7","border-top-width","2px");b=Ext.query("div[class^=xsv-seqtrans_prot]");for(c=0;c<b.length;c++){d=Ext.get(b[c]);d.setStyle("display",(this.m_HideTrans==1?"block":"none"))}b=Ext.query("div[class^=xsv-seqtrans_trans]");for(c=0;c<b.length;c++){d=Ext.get(b[c]);d.setStyle("display",(this.m_HideTrans==2?"block":"none"))}}this.m_App.forEachMarker(function(e){if(e.span){var f=Ext.get("seqtext-marker_"+this.m_App.m_Idx+"_"+e.marker_num+"_b");this.setTextMarker(f,e.seq_pos);f=Ext.get("seqtext-marker_"+this.m_App.m_Idx+"_"+e.marker_num+"_e");this.setTextMarker(f,e.seq_pos+e.span-1)}else{var f=Ext.get("seqtext-marker_"+this.m_App.m_Idx+"_"+e.marker_num);this.setTextMarker(f,e.seq_pos)}},this);d=Ext.getCmp("seq_trans_btn");d.setText(this.translationName())},gotoSeqPositionDlg:function(){Ext.MessageBox.prompt("Go to position","Please enter sequence position<br />(possible&nbsp;value&nbsp;formats&nbsp;are&nbsp;10k,&nbsp;-20,&nbsp;1m):",function(d,f){if(d!="ok"||f.length===0){return}var c=0;var b=!SeqView.IsNumeric(f);if(!b){c=SeqView.stringToNum(f);c=this.m_App.posToGlobal(c);if(c>=this.m_App.m_SeqLength){b=true}}if(b){Ext.MessageBox.alert("Go to position","Invalid position.")}else{var e=Math.min(c,this.m_App.m_SeqLength-this.m_TextViewSize);e=Math.max(0,e);this.startImageLoading(e,this.m_LenSeq)}},this,false)},syncToLocator:function(){if(!this.m_Locator){return}var b=this.m_App.m_Panorama.toSeq(this.m_Locator.getLeft(true));this.startImageLoading(b,this.m_LenSeq)},toSeq:function(){return[this.m_FromSeq,this.m_FromSeq+this.m_LenSeq-1,this.m_LenSeq]},isPanorama:function(){return false},getURL:function(){return"&seq="+(this.m_FromSeq+1)+":"+(this.m_FromSeq+this.m_LenSeq)},isPanorama:function(){return false},isLoading:function(){return this.m_Loading}};SeqView.AlignSelection=function(b,d){this.area=d;this.m_View=b;this.parent_elem=Ext.get(this.m_View.m_DivId);var c=new Ext.Template('<div id="align_selection_id_{idx}" class="over_selection"/>');this.element=c.append(this.parent_elem,{idx:this.m_View.m_Idx},true);this.element.setLeft(d.x);this.element.setTop(d.y);this.element.setHeight(d.h);this.element.setWidth(d.w);this.element.on({click:this.m_View.onClick,mousemove:function(f){f.stopPropagation()},scope:this.m_View});this.qtip=new Ext.ToolTip({target:this.element,trackMouse:false,autoWidth:true,autoHide:true,html:d.descr,dismissDelay:5000})};SeqView.AlignSelection.prototype={movePix:function(b){new_left=this.element.getLeft(true)-b;this.element.setLeft(new_left)},remove:function(){if(this.qtip){this.qtip.destroy()}this.element.remove()}};SeqView.Alignment=(function(){return Ext.extend(SeqView.View,{m_PrevXY:null,m_FromSeq:0,m_LenSeq:0,m_ViewPageSize:500,m_Expand:"",constructor:function(b){SeqView.Alignment.superclass.constructor.apply(this,["alignment",b])},isAlignment:function(){return true},createPanel:function(){this.m_DivId="alignment_id"+this.m_Idx;var c=[];if(this.m_App.m_Embedded===false){this.m_Spacer=this.m_App.addView({border:false,height:SeqView.View.getSpacerHeight()});c.push(this.createChooseColorBtn(),"-")}c.push({iconCls:"xsv-zoom_plus",tooltip:"Zoom In",scope:this,handler:function(){this.zoomIn()}},{iconCls:"xsv-zoom_minus",tooltip:"Zoom Out",scope:this,handler:function(){this.zoomOut()}},{iconCls:"xsv-zoom_seq",tooltip:"Zoom To Sequence",scope:this,handler:function(){this.zoomSeq()}},"-",{iconCls:"xsv-prev",tooltip:"Prev Page",scope:this,handler:function(){this.gotoPrev()}},"-",{iconCls:"xsv-next",tooltip:"Next Page",scope:this,handler:function(){this.gotoNext()}},"->",{iconCls:"x-tbar-loading",id:"seq-view-loading-"+this.m_Idx,tooltip:"Reload View",scope:this,handler:function(){this.refresh()}});var b=[];if(this.m_App.m_Embedded===false){b.push(this.createCloseTBar())}else{b.push({id:"help",qtip:"Help",handler:function(){SeqView.showHelpDlg()}})}this.m_View=this.m_App.addView({collapsible:true,title:"Loading...",tools:b,view:this,tbar:c,html:'<div class="alignment_div" id="'+this.m_DivId+'"/>'});Ext.get(this.m_DivId).on({mousemove:this.onMouseMove,contextmenu:this.onContextMenu,scope:this});if(this.m_App.m_Embedded===false){this.m_Locator=new SeqView.Locator(this,this.m_Color,true)}this.loadImage(this.m_FromSeq,this.m_LenSeq)},loadImage:function(f,b){this.m_Loading=true;this.m_Width=this.getScreenWidth();var e={id:this.m_App.GI,view:"aln",client:"assmviewer",width:this.m_Width,from:f,len:b};if(this.m_App.m_AppName&&this.m_App.m_AppName.length>0){e.appname=this.m_App.m_AppName}var d=this.m_App.m_CGIs.Alignment;if(this.m_Expand&&this.m_Expand.length>0){e.expand=this.m_Expand}Ext.apply(e,this.addURLParams());Ext.getCmp("seq-view-loading-"+this.m_Idx).disable();var c=this.m_ReqNum+1;this.m_ReqNum=c;this.m_App.AjaxRequest({url:d,scope:this,opts:{req_num:c},params:e,method:"POST",success:this.checkJobStatus,failure:this.loadFailure})},checkJobStatus:function(e,g){if(!this.m_Loading||this.m_ReqNum>g.opts.req_num){return}var f=Ext.decode(e.responseText);if(f.job_status){if(f.job_status=="failed"){this.loadFailure(f.error_message)}else{if(f.job_status=="canceled"){this.loadFailure("Job canceled")}else{var c=this.m_App.m_CGIs.Alignment+"?job_key="+f.job_id;this.m_App.AjaxRequest.defer(2000,this,[{url:c,scope:this,opts:g.opts,success:this.checkJobStatus,failure:this.loadFailure}])}}}else{Ext.getCmp("seq-view-loading-"+this.m_Idx).enable();if(f.error){this.loadFailure(f.error)}else{if(f.success===false){this.loadFailure(f.msg)}else{this.m_FromCgi=f;this.m_FromSeq=this.m_FromCgi.from;this.m_LenSeq=this.m_FromCgi.len;this.m_AlgnLen=this.m_FromCgi.seq_length;this.m_ViewPageSize=this.m_LenSeq;this.m_Width=this.m_FromCgi.img_width;this.m_Height=this.m_FromCgi.img_height;this.m_Loading=false;var h=Ext.get(this.m_DivId);var k=h.first("img");if(k){var i=Ext.getDom(k);i.src=f.img_url}else{var b=new Ext.Template('<img class="sv-drag sv-highlight sv-dblclick" src="{img_url}">'),k=b.append(h,f,true)}h.setStyle("height",this.m_Height+"px");this.updateTitle();this.m_App.notifyViewLoaded(this)}}}},loadFailure:function(b,d){if(typeof b=="string"){Ext.MessageBox.show({title:"Image loading error",msg:b,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO});var e=Ext.get(this.m_DivId);e.setStyle("background-image","none");this.m_View.setTitle("Not available")}else{var c=Ext.decode(b.responseText)}},onMouseDown:function(b){},onMouseUp:function(b){},onMouseMove:function(d){var c=this.hitTest(d.getXY());var b=Ext.get(this.m_DivId);if(c&&!this.m_Selection){b.setStyle("cursor","pointer");this.m_Selection=new SeqView.AlignSelection(this,c)}else{if(this.m_Selection){b.setStyle("cursor","default");this.m_Selection.remove();this.m_Selection=null}}},onClick:function(k){var g=this.hitTest(k.getXY());if(g){var h=g.name;var b=this.m_Expand;var f=b.length>0?b.split(","):[];var c=false;for(var d=0;d!=f.length;d++){if(f[d]==h){c=true;delete f[d];break}}if(!c){f.push(h)}this.m_Expand=f.join(",");this.loadImage(this.m_FromSeq,this.m_LenSeq)}},onMouseOut:function(b){},onContextMenu:function(b){b.preventDefault();b.stopPropagation();menu=new Ext.menu.Menu();menu.add({iconCls:"xsv-zoom_plus",text:"Zoom In",scope:this,handler:function(){this.zoomIn()}});menu.add({iconCls:"xsv-zoom_minus",text:"Zoom Out",scope:this,handler:function(){this.zoomOut()}});menu.add("-");menu.add({iconCls:"xsv-zoom_seq",text:"Zoom To Sequence",scope:this,handler:function(){this.zoomSeq()}});menu.add("-");menu.add({iconCls:"expand_all",text:"Expand All",scope:this,handler:function(){this.expandAll()}});menu.add({iconCls:"collapse_all",text:"Collapse All",scope:this,handler:function(){this.collapseAll()}});menu.add("-");menu.add({iconCls:"prev",text:"Prev Page",scope:this,handler:function(){this.gotoPrev()}});menu.add({iconCls:"next",text:"Next Page",scope:this,handler:function(){this.gotoNext()}});menu.showAt(b.getXY())},toSeq:function(){return[this.m_FromSeq,this.m_FromSeq+this.m_LenSeq-1,this.m_LenSeq]},updateTitle:function(){var c=this.toSeq();var d=c[0]+1;var e=c[1]+1;var f=this.m_App.m_Embedded!==false?"<a href='#' class='hidden_for_print' id='new_view_link_al"+this.m_App.m_Idx+"' style='float:right;padding-right:7px;'>Open Full View</a>":"Alignment View: ";f+=d.commify()+" - "+e.commify()+" ("+c[2].commify()+" bases shown)";this.m_View.setTitle(f);var b=Ext.get("new_view_link_al"+this.m_App.m_Idx);if(b){b.on({click:this.openFullView,scope:this})}this.m_App.updateLocator(this)},hitTest:function(k){var e=Ext.get(this.m_DivId).getXY();var b=k[0]-e[0];var i=k[1]-e[1];for(a in this.m_FromCgi.checkboxes){var c=this.m_FromCgi.checkboxes[a];var g=c.x;var f=c.y;var h=c.w;var d=c.h;if(b>=g-1&&b<=g+h&&i>=f-1&&i<=f+d){return c}}return null},zoomIn:function(){var b=this.m_LenSeq/2;var c=this.m_FromSeq+b/2;this.loadImage(c,b)},zoomSeq:function(c,f){var d=Math.floor(this.getScreenWidth()*SeqView.MinBpp);var b=c?c:this.m_FromSeq+d;var e=Math.max(0,b-d/2);if(e+d>this.m_App.m_SeqLength){d=this.m_App.m_SeqLength-e}this.loadImage(e,d)},zoomOut:function(){var b=this.m_LenSeq*2;var c=this.m_FromSeq-this.m_LenSeq/2;c=Math.max(0,c);if(c+b>this.m_AlgnLen){b=this.m_AlgnLen-c}this.loadImage(c,b)},gotoPrev:function(){var b=Math.max(0,this.m_FromSeq-this.m_ViewPageSize);this.loadImage(b,this.m_LenSeq)},gotoNext:function(){var b=Math.min(this.m_FromSeq+this.m_ViewPageSize-1,this.m_AlgnLen-this.m_ViewPageSize);b=Math.max(0,b);this.loadImage(b,this.m_LenSeq)},expandAll:function(){var c=[];for(var b in this.m_FromCgi.checkboxes){c.push(this.m_FromCgi.checkboxes[b].name)}this.m_Expand=c.join(",");this.loadImage(this.m_FromSeq,this.m_LenSeq)},collapseAll:function(){this.m_Expand="";this.loadImage(this.m_FromSeq,this.m_LenSeq)},refresh:function(b){if(this.m_VisLenSeq==0){return}this.loadImage(this.m_FromSeq,this.m_LenSeq)},syncToLocator:function(){if(!this.m_Locator){return}var b,c;if(this.m_Locator.m_ResizeRight){b=this.m_FromSeq}else{b=this.m_App.m_Panorama.toSeq(this.m_Locator.getLeft(true))}if(this.m_Locator.m_Scroll){c=b+this.m_LenSeq-1}else{c=this.m_App.m_Panorama.toSeq(this.m_Locator.getLeft(true)+this.m_Locator.getWidth()+3)}this.loadImage(b,c-b+1)},checkLocatorWidth:function(b){return true},openFullView:function(){var e=this.m_App.m_Config.SeqInfo;var d="http://www.ncbi.nlm.nih.gov/";if(e.gi){var c=e.acc_type=="DNA"?"nuccore":"protein";d+=c+"/"+e.gi+"?report=graph"}else{d+="projects/sviewer/?id="+this.m_App.GI}if(this.m_App.m_Origin!=0){d+="&origin="+this.m_App.m_Origin}d+="&v="+(this.m_FromSeq+1)+":"+(this.m_FromSeq+this.m_LenSeq);if(this.m_App.m_Key){d+="&key="+this.m_App.m_Key}var b=this.m_App.m_Tracks||this.m_App.m_TracksFromURL;if(b){d+="&tracks="+b}if(this.m_App.m_ViewerContext){d+="&viewer_context="+this.m_App.m_ViewerContext}if(this.m_App.m_AppName){d+="&appname="+this.m_App.m_AppName}window.open(d)}})})();SeqView.Slider=(function(){sm_SliderMin=43;sm_SliderMax=135;sm_Tmpl=new Ext.Template('<div class="the_map_control hidden_for_print" />','<div id="left_ctrl_{idx}" class="map_ctrl_left" ext:qtip="Pan left"></div>','<div id="drag_ctrl_{idx}" class="map_ctrl_drag" ext:qtip="Move Map Control"></div>','<div id="right_ctrl_{idx}" class="map_ctrl_right" ext:qtip="Pan right"></div>','<div id="zoomin_ctrl_{idx}" class="map_ctrl_zoomin" ext:qtip="Zoom In"></div>','<div id="zoomout_ctrl_{idx}" class="map_ctrl_zoomout" ext:qtip="Zoom Out"></div>','<div id="map_bar_{idx}" class="map_ctrl_bar" ext:qtip="Click To Zoom"></div>','<div id="map_slider_{idx}" class="map_ctrl_slider" ext:qtip="Zoom Level"></div>');function b(c){this.m_View=c;this.m_Slider=sm_Tmpl.append(Ext.get(this.m_View.m_DivId),{idx:this.m_View.m_Idx},true);var d=new Ext.dd.DD(this.m_Slider);d.setOuterHandleElId(Ext.get("drag_ctrl_"+this.m_View.m_Idx));Ext.get("left_ctrl_"+this.m_View.m_Idx).on({mousedown:function(f){f.stopEvent()}});Ext.get("right_ctrl_"+this.m_View.m_Idx).on({mousedown:function(f){f.stopEvent()}});Ext.get("zoomin_ctrl_"+this.m_View.m_Idx).on({mousedown:function(f){f.stopEvent()}});Ext.get("zoomout_ctrl_"+this.m_View.m_Idx).on({mousedown:function(f){f.stopEvent()}});Ext.get("left_ctrl_"+this.m_View.m_Idx).on({click:this.onLeftCtrl,scope:this});Ext.get("right_ctrl_"+this.m_View.m_Idx).on({click:this.onRightCtrl,scope:this});Ext.get("zoomin_ctrl_"+this.m_View.m_Idx).on({click:this.onZoomInCtrl,scope:this});Ext.get("zoomout_ctrl_"+this.m_View.m_Idx).on({click:this.onZoomOutCtrl,scope:this});Ext.get("map_bar_"+this.m_View.m_Idx).on({click:this.onSetZoomCtrl,scope:this});Ext.get("map_slider_"+this.m_View.m_Idx).on({mousedown:this.onMouseDown,scope:this})}b.getSliderMin=function(){return sm_SliderMin};b.getSliderMax=function(){return sm_SliderMax};return b})();SeqView.Slider.prototype={onMouseDown:function(c){if(c.button!==0){return}c.stopEvent();this.m_PrevXY=c.getXY();this.m_CurElem=Ext.get("map_slider_"+this.m_View.m_Idx);this.m_CurElem.setStyle("cursor","n-resize");this.m_DocMouseMove=document.onmousemove;this.m_DocMouseUp=document.onmouseup;var b=this;document.onmousemove=function(d){if(!d){d=window.event}d=Ext.EventObject.setEvent(d);b.onMouseMove(d)};document.onmouseup=function(d){if(!d){d=window.event}d=Ext.EventObject.setEvent(d);b.onMouseUp(d)}},hide:function(){this.m_Slider.hide()},show:function(){this.m_Slider.show()},onMouseUp:function(l){if(!this.m_PrevXY){return}this.m_CurElem.setStyle("cursor","pointer");var h=SeqView.Slider.getSliderMax()-SeqView.Slider.getSliderMin();var o=this.m_CurElem.getTop(true)-SeqView.Slider.getSliderMin();var d=this.m_View.toSeq();var f=d[0]+d[2]/2;var c=this.m_View.m_App.m_SeqLength;var b=this.m_View.getMostRightPix()/10;var i=Math.log(c/b);var o=Math.min(h,Math.max(0,o));var k=b*Math.exp(i*o/h);var n=f-k/2;k=Math.min(this.m_View.m_App.m_SeqLength,Math.round(k));n=Math.round(Math.max(0,n));if(n+k>this.m_View.m_App.m_SeqLength){var g=n+k-this.m_View.m_App.m_SeqLength;n-=g}this.m_View.m_ZoomOP="slider";this.m_View.startImageLoading(n,k);document.onmousemove=this.m_DocMouseMove;document.onmouseup=this.m_DocMouseUp;this.m_DocMouseMove=null;this.m_DocMouseUp=null;this.m_PrevXY=null;this.m_CurElem=null},onMouseMove:function(c){if(!this.m_PrevXY){return}var b=c.getXY();var d=this.m_PrevXY[1]-b[1];var f=this.m_CurElem.getTop(true)-d;f=Math.min(f,SeqView.Slider.getSliderMax());f=Math.max(f,SeqView.Slider.getSliderMin());this.m_CurElem.setTop(f);this.m_PrevXY=b},onLeftCtrl:function(b){b.stopEvent();this.m_View.scrollViewTo(this.m_View.m_ScrollPix+100,SeqView.PAN_LEFT)},onRightCtrl:function(b){b.stopEvent();this.m_View.scrollViewTo(this.m_View.m_ScrollPix-100,SeqView.PAN_RIGHT)},onZoomInCtrl:function(b){b.stopEvent();this.m_View.m_ZoomOP="slider";this.m_View.zoomIn()},onZoomOutCtrl:function(b){b.stopEvent();this.m_View.m_ZoomOP="slider";this.m_View.zoomOut()},onSetZoomCtrl:function(n){var i=Ext.get("map_bar_"+this.m_View.m_Idx).getXY();var h=SeqView.Slider.getSliderMax()-SeqView.Slider.getSliderMin();var p=n.getXY()[1]-i[1];var p=Math.min(h,Math.max(0,p));var d=this.m_View.toSeq();var f=d[0]+d[2]/2;var c=this.m_View.m_App.m_SeqLength;var b=this.m_View.getMostRightPix()/10;var k=Math.log(c/b);var l=b*Math.exp(k*p/h);var o=f-l/2;l=Math.min(this.m_View.m_App.m_SeqLength,Math.round(l));o=Math.round(Math.max(0,o));if(o+l>this.m_View.m_App.m_SeqLength){var g=o+l-this.m_View.m_App.m_SeqLength;o-=g}this.m_View.m_ZoomOP="slider";this.m_View.startImageLoading(o,l)},updateZoomIndicator:function(){var f=Ext.get("map_slider_"+this.m_View.m_Idx);var i=SeqView.Slider.getSliderMax()-SeqView.Slider.getSliderMin();var d=this.m_View.toSeq();var h=d[2];var e=this.m_View.m_App.m_SeqLength;var g=this.m_View.getMostRightPix()/10;var c=Math.log(e/g);var b=i*Math.log(h/g)/c;f.setTop(SeqView.Slider.getSliderMin()+b)}};SeqView.ChunkWidth=4000;SeqView.MinBpp=1/12;SeqView.PreloadMargin=SeqView.ChunkWidth/10;SeqView.PAN_RIGHT=1;SeqView.PAN_LEFT=-1;SeqView.Graphic=(function(){return Ext.extend(SeqView.View,{m_PrevCgi:null,m_NextCgi:null,m_FromSeq:0,m_LenSeq:0,m_VisFromSeq:0,m_VisLenSeq:0,m_ScrollPix:0,m_Flip:false,m_Selection:null,m_RangeSelectionSet:[],m_OrphanRangeToolTips:[],m_Reflections:null,m_SelectedSig:null,m_SelectedRangeSet:[],m_ScrollPixBeforeLoad:null,m_Slider:null,m_TbSlider:null,m_DocMouseMove:null,m_DocMouseUp:null,m_DocMouseSaved:false,constructor:function(b){this.clear();SeqView.Graphic.superclass.constructor.apply(this,["graphical",b]);this.m_LenSeq=this.m_App.m_SeqLength;this.m_Flip=b.getFlip()},isGraphic:function(){return true},canFlip:function(){return this.m_App.m_ViewParams.acc_type=="DNA"},getFlip:function(){return this.m_Flip},getSelectionTop:function(){return 0},getSelectionHeight:function(){return this.m_FromCgi.img_height},setFlip:function(b){if(b!=this.m_Flip){this.setFlipNoReload(b);this.refresh()}},setFlipLocal:function(c){if(c!=this.m_Flip){this.m_Flip=c;var b=Ext.getCmp("flip-button-"+this.m_Idx);if(b){b.toggle(c)}this.refresh()}},setFlipNoReload:function(d,b){this.m_Flip=d;var c=Ext.getCmp("flip-button-"+this.m_Idx);if(c){c.toggle(d)}if(typeof b=="undefined"||!b){var e=this;this.m_App.setFlip(d,e)}},getMostRightPix:function(){return this.m_View.getInnerWidth()-2},seq2Pix:function(c){var b=this.m_FromCgi?this.m_FromCgi.img_width:SeqView.ChunkWidth;var d=0;if(this.getFlip()){d=(this.m_LenSeq-(c-this.m_FromSeq)-1+0.5)*b/this.m_LenSeq}else{d=(c-this.m_FromSeq+0.5)*b/this.m_LenSeq}return Math.round(d)},seq2PixScrolled:function(b){return this.seq2Pix(b)+this.m_ScrollPix},pix2Seq:function(d,c){if(c===undefined){c=0}var b=this.m_FromCgi?this.m_FromCgi.img_width:SeqView.ChunkWidth;if(this.getFlip()){d=b-d}var e=this.m_FromSeq+Math.floor(d*this.m_LenSeq/b+c);return e},getScreenWidth:function(){return this.m_App.m_Embedded?this.m_View.getInnerWidth():this.m_View.getInnerWidth()-2},getScreenHeight:function(){return this.m_App.m_Embedded?this.m_View.getInnerHeight():this.m_View.getInnerHeight()-2},toSeq:function(){if(!this.m_FromCgi){return[this.m_FromSeq,this.m_FromSeq+this.m_LenSeq-1,this.m_LenSeq]}var d=this.getScreenWidth();var b=this.m_FromCgi.img_width;var e=Math.max(SeqView.MinBpp,this.m_LenSeq/b);var c=Math.round(d*e);var h,g;if(this.getFlip()){var f=this.m_FromSeq+this.m_LenSeq-1;g=f-Math.round(-this.m_ScrollPix*e-0.5);h=g-c+1}else{h=this.m_FromSeq+Math.round(-this.m_ScrollPix*e-0.5);g=h+c-1}if(g>=this.m_App.m_SeqLength){g=this.m_App.m_SeqLength-1}return[h,g,g-h+1]},createPanel:function(){this.m_DivId="graphical_id"+this.m_Idx;var n="theme-id-"+this.m_Idx;if(this.m_App.m_Embedded&&this.m_App.m_Embedded=="minimal"){this.m_View=this.m_App.addView({layout:"hbox",header:false,border:false,align:"stretchmax",items:[{xtype:"buttongroup",cls:"hidden_for_print",columns:1,width:24,frame:false,items:[{iconCls:"xsv-full_view",tooltip:"Open Full View",scope:this,handler:function(i,q){this.openFullView()}},{iconCls:"xsv-flip-strands",id:"flip-button-"+this.m_Idx,tooltip:"Flip Sequence Strands",pressed:this.getFlip(),enableToggle:true,hidden:!this.canFlip(),scope:this,handler:function(){this.flipStrand()}},{iconCls:"xsv-zoom_plus",tooltip:"Zoom In",scope:this,handler:function(){this.m_ZoomOP="button";this.zoomIn()}},{iconCls:"xsv-zoom_minus",tooltip:"Zoom Out",scope:this,handler:function(){this.m_ZoomOP="button";this.zoomOut()}},{iconCls:"xsv-zoom_seq",tooltip:"Zoom To Sequence",scope:this,handler:function(){this.zoomSeq()}},{iconCls:"xsv-goto_position",tooltip:"Go To Position/Range",scope:this,handler:function(){this.gotoPositionDlg()}},{iconCls:"x-tbar-loading",tooltip:"Reload View",scope:this,handler:function(){this.refresh()}},{iconCls:"xsv-configure",tooltip:"Configuration",scope:this,hidden:(this.m_App.m_NoConfDlg===true||this.m_App.m_PermConfId),handler:function(){this.m_App.showTracksConfigDlg(0)}},{iconCls:"xsv-question",tooltip:"Help",scope:this,handler:function(){SeqView.showHelpDlg(true)}}]},{header:false,border:false,view:this,flex:1,autoHeight:true,layout:"fit",html:{tag:"div",id:this.m_DivId,cls:"graphical_div sv-drag sv-highlight sv-dblclick"}}]})}else{var b=[];if(this.m_App.m_Embedded===false){this.m_Spacer=this.m_App.addView({border:false,height:SeqView.View.getSpacerHeight()});b.push(this.createChooseColorBtn())}var f=this.toSeq();var h=this.m_App.posToLocal(f[0]);var o=this.m_App.posToLocal(f[1]);if(this.getFlip()){var p=h;h=o;o=p}if(this.m_App.m_Toolbar.history==true){b.push({iconCls:"back",tooltip:"Go back",itemId:"histPrev"+this.m_Idx,scope:this,handler:function(){this.stepHistory()}})}if(this.m_App.m_Toolbar.name==true){var c="<b>";c+=this.m_App.m_ViewParams.id;c+=": "+this.m_App.m_Config.SeqInfo.title;c+="</b><br/><br/>";c+=h.commify()+"&nbsp;-&nbsp;"+o.commify();c+="&nbsp;("+(f[1]-f[0]+1).commify()+"&nbsp;";c+=(this.m_App.m_ViewParams.acc_type=="protein"?"residues":"bases");c+="&nbsp;shown";if(this.canFlip()){if(this.getFlip()){c+=",&nbsp;negative strand"}else{c+=",&nbsp;positive strand"}}c+=")";b.push({text:"title",itemId:"tbtitle"+this.m_Idx,tooltip:c,width:200,handler:this.openFullView,scope:this})}if(this.m_App.m_Toolbar.search==true){var d=new Ext.Button({renderTo:Ext.getBody(),text:"Search & Go:",id:"sv-goto-btn_"+this.m_Idx,handler:this.gotoAndSearch,scope:this,tooltip:"<b>Go to position/range:</b><br/>Range formats are 10k-20k, -20--10, -10k:-5, 5 to 515, -1m..1m <br/><br/><b>Search:</b><br/>Feature name, component name, or sequence"});b.push(this.m_App.m_ViewParams.acc_type!="DNA"?{hidden:true}:"-",d,{xtype:"textfield",fieldLabel:"Go To:",id:"sv-goto-box_"+this.m_Idx,width:150,tooltip:"Go To Position/Range",listeners:{specialkey:function(i,q){if(q.getKey()==q.ENTER){this.gotoAndSearch()}}.createDelegate(this)}},"-")}if(this.m_App.m_Toolbar.panning==true){b.push({iconCls:"pan-left",tooltip:"Pan left",scope:this,handler:function(){this.scrollViewTo(this.m_ScrollPix+100,SeqView.PAN_LEFT)}},{iconCls:"pan-right",tooltip:"Pan right",scope:this,handler:function(){this.scrollViewTo(this.m_ScrollPix-100,SeqView.PAN_RIGHT)}},"-")}if(this.m_App.m_Toolbar.zoom==true){b.push({iconCls:"xsv-zoom_minus",tooltip:"Zoom Out",scope:this,handler:function(){this.m_ZoomOP="button";this.zoomOut()}});this.m_TbSlider=new Ext.Slider({name:"zoom",width:100,minValue:0,maxValue:100,value:0,increment:5,topThumbZIndex:100,tipText:function(i){return String(i.value)+"%"},listeners:{changecomplete:function(s,t){var z=100;var D=100-t;var r=this.toSeq();var u=r[0]+r[2]/2;var q=this.m_App.m_SeqLength;var i=this.getMostRightPix()/10;var A=Math.log(q/i);var D=Math.min(z,Math.max(0,D));var B=i*Math.exp(A*D/z);var C=u-B/2;B=Math.min(this.m_App.m_SeqLength,Math.round(B));C=Math.round(Math.max(0,C));if(C+B>this.m_App.m_SeqLength){var w=C+B-this.m_App.m_SeqLength;C-=w}this.m_ZoomOP="slider";this.startImageLoading(C,B)}.createDelegate(this)}});b.push(this.m_TbSlider);b.push({iconCls:"xsv-zoom_plus",tooltip:"Zoom In",scope:this,handler:function(){this.m_ZoomOP="button";this.zoomIn()}},{iconCls:"xsv-zoom_seq",tooltip:"Zoom To Sequence",scope:this,handler:function(){this.zoomSeq()}})}b.push("->");b.push({id:"seq-view-sync"+this.m_Idx,hidden:this.m_App.m_NeedAlignmentView==false,text:"Sync Alignment View",scope:this,handler:function(){this.m_App.onSyncAlignView(this)}},{iconCls:"xsv-full_view",tooltip:"Open Full View",scope:this,hidden:(this.m_App.m_Embedded===true||this.m_App.m_NoViewHeader!==true),handler:function(i,q){this.openFullView()}});if(this.m_App.m_Embedded===false&&this.m_App.m_Toolbar.tools==true){b.push({text:"Tools",iconCls:"xsv-views_tools",tooltip:"Tools",menu:new Ext.menu.Menu({items:[{text:"Go To",iconCls:"xsv-goto_position",tooltip:"Go To Position/Range",scope:this,handler:function(){this.gotoPositionDlg()}},{text:"Search",iconCls:"search",tooltip:"Search features, components or sequences",scope:this,handler:function(){this.m_App.showPreSearchDlg()}},{text:"Flip Strands",id:"flip-menu-"+this.m_Idx,tooltip:"Flip Sequence Strands",iconCls:"xsv-flip-strands",pressed:this.getFlip(),enableToggle:true,hidden:!this.canFlip(),scope:this,handler:function(){this.flipStrand()}},{text:"Markers",iconCls:"xsv-markers",scope:this,handler:function(){this.m_App.showMarkersDlg()}},{text:"Set Origin",iconCls:"xsv-origin",scope:this,handler:function(){this.m_App.showOriginDlg(null)}},{text:"Sequence Text View",iconCls:"xsv-new_fasta",tooltip:"Create New Sequence Text View",scope:this,handler:function(){this.m_App.createTextView(this)}},"-",{text:"Add new Panel",iconCls:"xsv-new_view",tooltip:"Create New Graphical Panel",scope:this,handler:function(){var i=new SeqView.Graphic(this.m_App);this.m_App.registerView(i)}},{text:"Add new Panel on Range",iconCls:"xsv-new_view",tooltip:"Create New Graphical Panel on Selected Range",scope:this,handler:function(){var i=new SeqView.Graphic(this.m_App);this.m_App.registerView(i);var s=-1,r=-1;var q=this.totalSelectedRange();if(q[0]!==-1&&q[1]!==-1){s=q[0];r=q[1];this.removeRangeSelection(true)}else{if(this.m_UrlFrom){s=this.m_UrlFrom;r=this.m_UrlTo}else{s=this.m_VisFromSeq+1;r=this.m_VisFromSeq+this.m_VisLenSeq}}if(s!==-1&&r!==-1){i.startImageLoading(s,r-s+1)}}},"-",{text:"BLAST Search (Visible Range)",iconCls:"xsv-blast",scope:this,handler:function(){var i=this.m_App.getBlastSearchURL();i+="&QUERY_FROM="+(this.m_VisFromSeq+1);i+="&QUERY_TO="+(this.m_VisFromSeq+this.m_VisLenSeq);window.open(i)}},{text:"Primer BLAST (Visible Range)",iconCls:"xsv-primer",scope:this,handler:function(){this.primerBlast(false,[[this.m_VisFromSeq,this.m_VisFromSeq+this.m_VisLenSeq-1]])}},{text:"BLAST Search (Selection)",iconCls:"xsv-blast",scope:this,handler:function(){this.blastSelection()}},{text:"Primer BLAST (Selection)",iconCls:"xsv-primer",scope:this,handler:function(){this.primerBlast()}},"-",{text:"Feedback",scope:this,handler:function(){this.m_App.showFeedbackDlg(this.m_Idx)}}]})})}if(this.m_App.m_NoConfDlg!==true&&!this.m_App.m_PermConfId&&this.m_App.m_Toolbar.config==true){b.push("-",{iconCls:"xsv-configure",text:"Configure",tooltip:"Configuration",scope:this,handler:function(){this.m_App.showTracksConfigDlg(0)}})}if(this.m_App.m_Toolbar.reload==true){b.push({iconCls:"x-tbar-loading",id:"seq-view-loading-"+this.m_Idx,tooltip:"Reload View",scope:this,handler:function(){this.refresh()}})}var l=true;for(var e=0;e<this.m_App.m_Views.length;e++){var k=this.m_App.m_Views[e];if(k&&k!=this&&k.isGraphic()){l=false;break}}if(l){if(this.m_App.m_Toolbar.help==true){b.push({iconCls:"xsv-question",tooltip:"Help",scope:this,handler:function(){SeqView.showHelpDlg(true)}})}}else{b.push({iconCls:"tb-close",tooltip:"Close",scope:this,handler:function(){this.remove()}})}var g=[];if(this.m_App.m_Embedded===false){g.push(this.createCloseTBar())}else{g.push({id:"help",qtip:"Help",handler:function(){SeqView.showHelpDlg()}})}this.m_View=this.m_App.addView({collapsible:true,title:"Loading...",header:false,tools:g,view:this,tbar:b,html:{tag:"div",id:this.m_DivId,cls:"graphical_div sv-drag sv-highlight sv-dblclick"}})}if(this.m_App.m_NoSlider!==true){this.m_Slider=new SeqView.Slider(this);this.m_Slider.hide()}Ext.get(this.m_DivId).on({mousedown:this.onMouseDown,dblclick:this.onDblClick,mousemove:this.onMouseMove,contextmenu:this.onContextMenu,scope:this});if(this.m_App.m_Embedded===false){this.m_Locator=new SeqView.Locator(this,this.m_Color,true)}this.startImageLoading(this.m_FromSeq,this.m_LenSeq,{fire_event:false})},clear:function(){this.m_History=[];this.m_HistIx=0;this.mf_HistoricalBack=false;this.m_Selection=null;this.m_RangeSelectionSet=[];this.m_Reflections=null;this.m_SelectedSig=null;this.m_SelectedRangeSet=[];this.m_ScrollPixBeforeLoad=null;this.m_Slider=null;this.m_Loading=false;if(this.ToolTipsMgr){this.ToolTipsMgr.clear();this.ToolTipsMgr=null}if(this.SelectedRangeToolTipsMgr){this.SelectedRangeToolTipsMgr.clear();this.SelectedRangeToolTipsMgr=null}SeqView.Graphic.superclass.clear.call(this)},refresh:function(b){if(this.m_VisLenSeq==0){return}this.startImageLoading(this.m_VisFromSeq,this.m_VisLenSeq,b)},startImageLoading_ext:function(c){var e=c.from||this.m_VisFromSeq;var b=c.len||this.m_VisLenSeq;delete c.len;delete c.from;if(typeof c.flip!="undefined"){this.setFlipNoReload(c.flip)}var d=c.sel;if(d){if(d.range){this.m_SelectedSig=null;this.m_SelectedRangeSet=[d.range]}else{if(d.sig){this.removeRangeSelection(true);this.m_SelectedSig=d.sig}}}this.startImageLoading(e,b,c)},startImageLoading:function(d,b,c){this.m_Loading=true;this.clearCache();this.loadImage(d,b,c)},removeFloatingSelection:function(){if(this.m_Selection){this.m_Selection.remove();this.m_Selection=null}},selectRange:function(b){this.removeRangeSelection(true);this.m_SelectedRangeSet=[b];this.m_RangeSelectionSet=[new SeqView.RangeSelection(this,b)]},selectRangeSet:function(d){if(!d||!d.length){return}this.removeSelectionsWithNoPinnedToolTips();this.m_SelectedRangeSet=d;this.m_RangeSelectionSet=[];var c=d.length;for(var b=0;b<c;b++){this.m_RangeSelectionSet.push(new SeqView.RangeSelection(this,d[b]))}},removeSelectionsWithNoPinnedToolTips:function(){var d=[];var e=[];var c=this.m_RangeSelectionSet.length;for(x=0;x<c;x++){if(this.m_RangeSelectionSet[x].m_ToolTip.isPinned()){d.push(this.m_RangeSelectionSet[x]);var f=this.m_SelectedRangeSet.length;for(y=0;y<f;y++){var b=this.m_SelectedRangeSet[y];if(b[0]==this.m_RangeSelectionSet[x].range[0]&&b[1]==this.m_RangeSelectionSet[x].range[1]){e.push(this.m_SelectedRangeSet[y])}}}else{if(!this.m_RangeSelectionSet[x].m_ToolTip.isPinned()){this.m_RangeSelectionSet[x].remove();var f=this.m_SelectedRangeSet.length;for(y=0;y<f;y++){var b=this.m_SelectedRangeSet[y];if(b[0]==this.m_RangeSelectionSet[x].range[0]&&b[1]==this.m_RangeSelectionSet[x].range[1]){this.m_SelectedRangeSet[y].remove()}}}}}this.m_RangeSelectionSet=[];this.m_RangeSelectionSet=this.m_RangeSelectionSet.concat(d);this.m_SelectedRangeSet=[];this.m_SelectedRangeSet=this.m_SelectedRangeSet.concat(e)},removeRangeSelection:function(f,d){var e=this.m_RangeSelectionSet;if(!e||!e.length){return}var c=e.length;if(typeof(d)!=="undefined"){this.popRangeElement(d,f);d.remove()}else{for(var b=0;b<c;b++){if(e[b].m_ToolTip&&e[b].m_ToolTip.isPinned()){this.m_OrphanRangeToolTips.push(e[b].m_ToolTip)}e[b].remove()}this.m_RangeSelectionSet=[];if(f){this.m_SelectedRangeSet=[]}}},removeFeatMarks:function(){if(this.m_HighLightedFeature){Ext.each(this.m_HighLightedFeature,function(b){b.remove()})}delete this.m_HighLightedFeature},popRangeElement:function(d,f){var e=this.m_RangeSelectionSet;var c=e.length;var b;for(b=0;b<c;b++){if(e[b]==d){this.m_RangeSelectionSet.splice(b,1);if(f){this.m_SelectedRangeSet.splice(b,1)}return d}}},startRangeSelection:function(c,b){this.m_InDragAction=true;new SeqView.RangeSelection(this,[c],true,b)},addRangeSelection:function(d,b,c){this.m_InDragAction=false;if(c<5){d.remove()}else{d.updateCoords();this.m_RangeSelectionSet.push(d);this.m_SelectedRangeSet.push(b)}},subRangeSelection:function(b){},totalSelectedRange:function(){var e=-1;var f=-1;for(var d=0,b=this.m_SelectedRangeSet.length;d<b;d++){var c=this.m_SelectedRangeSet[d];f=Math.max(f,c[0],c[1]);if(e<0){e=Math.min(c[0],c[1])}else{e=Math.min(e,c[0],c[1])}}return[e,f]},loadImage:function(o,h,r){o=Math.max(0,o);h=Math.min(h,(this.m_App.m_SeqLength-o));var e=this.getScreenWidth();if((this.m_App.m_Embedded&&e==-2)||e==0||!this.m_View.isVisible()){this.m_VisFromSeq=o;this.m_VisLenSeq=h;return}var g=o;var n=h;if(n<e*SeqView.MinBpp){var s=Math.floor(e*SeqView.MinBpp);if(s>this.m_App.m_SeqLength){s=this.m_App.m_SeqLength}g=Math.floor(g-(s-n)/2);if(g<0){g=0}n=s}var p;if(n>2000000){p=3*e}else{if(n>1000000){p=5*e}else{p=8*e}}p=Math.min(SeqView.ChunkWidth,p);var c=e/n;if(c>4){c=Math.floor(c);var s=Math.floor(e/c);if(s>this.m_App.m_SeqLength){s=this.m_App.m_SeqLength;c=e/s}g=Math.floor(g-(s-n)/2);if(g<0){g=0}n=s}var d=Math.round(p/e*n);o=Math.floor(g-(d-n)/2);h=d;if(o<0){o=0}if(o+h>this.m_App.m_SeqLength){var i=o+h-this.m_App.m_SeqLength;o-=i;if(o<0){o=0;h=this.m_App.m_SeqLength;p=Math.round(h/n*e)}}if(isNaN(o)||isNaN(h)||isNaN(p)||p>16384){return}this.m_ReqFrom=g;h=Math.max(h,Math.min(this.m_App.m_SeqLength,250));var f={id:this.m_App.GI,minheight:220,client:"seqviewer",width:p,from:o,len:h};if(this.m_App.m_AppName&&this.m_App.m_AppName.length>0){f.appname=this.m_App.m_AppName}var b=this.m_App.m_CGIs.Graphic;if(this.m_SelectedSig){f.select=this.m_SelectedSig}if(this.getFlip()){f.flip="true"}if(r&&r.data_changed===true){f.data_changed="true"}if(this.m_ZoomOP){f._zo=this.m_ZoomOP;this.m_ZoomOP=null}Ext.apply(f,this.addURLParams());var l=Ext.getCmp("seq-view-loading-"+this.m_Idx);if(l){l.disable()}var k=this.m_ReqNum+1;this.m_ReqNum=k;var q=this.showLoadingImage.defer(3*1000,this);this.removeFloatingSelection();this.removeRangeSelection();this.removeFeatMarks();this.m_App.AjaxRequest({url:b,scope:this,params:f,method:"POST",opts:{opts:r,req_num:k,deferred:q},success:this.checkJobStatus,failure:this.loadFailure})},checkJobStatus:function(l,b){if(!this.m_Loading||this.m_ReqNum>b.opts.req_num){return}var i=Ext.decode(l.responseText);if(i.job_status){if(i.job_status=="failed"){this.loadFailure(i.error_message)}else{if(i.job_status=="canceled"){this.loadFailure("Job canceled")}else{var e=this.m_App.m_CGIs.Graphic+"?job_key="+i.job_id;this.m_App.AjaxRequest.defer(2000,this,[{url:e,scope:this,opts:b.opts,success:this.checkJobStatus,failure:this.loadFailure}])}}}else{if(b.opts.deferred){clearTimeout(b.opts.deferred)}var n=Ext.getCmp("seq-view-loading-"+this.m_Idx);if(n){n.enable()}if(this.m_Slider){this.m_Slider.show()}if(i.success===false){this.loadFailure(i.msg)}else{this.applyResults(i,b.opts.opts);if(this.m_SelectedRangeSet){this.selectRangeSet(this.m_SelectedRangeSet)}this.m_App.fireEvent("graphical_image_loaded",this);if(this.m_Slider){this.m_Slider.updateZoomIndicator()}if(this.m_TbSlider){var g=100;var k=this.toSeq();var d=k[2];var f=this.m_App.m_SeqLength;var c=this.getMostRightPix()/10;var h=Math.log(f/c);var o=g*Math.log(d/c)/h;this.m_TbSlider.setValue(100-o)}}}},loadFailure:function(b,d){if(typeof b=="string"){this.m_View.setTitle("Image loading error: "+b)}else{var c=Ext.decode(b.responseText)}this.mf_HistoricalBack=false},showLoadingImage:function(){if(this.m_Loading===true){if(this.m_Slider){this.m_Slider.hide()}var b=Ext.get(this.m_DivId);b.mask();b.setStyle("background-image","url("+this.m_App.m_CGIs.prefix+"images/img-loading.gif)");b.setStyle("background-position","50% 50%");var c=b.first("img");if(c){c.hide()}this.m_LoadingImageShown=true}},applyResults:function(e,n){this.m_Loading=false;this.m_FromCgi=e;this.m_FromSeq=e.from;this.m_LenSeq=e.len;this.m_Width=e.img_width;this.m_Height=e.img_height;this.m_LoadingImageShown=false;this.m_App.updateMarkersSize(this);var b=this.getScreenWidth();var f=0;if(this.getFlip()){f=Math.max(0,this.seq2Pix(this.m_ReqFrom-0.5)-b)}else{f=Math.min(Math.max(0,this.m_Width-b),this.seq2Pix(this.m_ReqFrom-0.5))}if(this.m_ScrollPixBeforeLoad){var l=this.m_ScrollPixBeforeLoad-this.m_ScrollPix;this.m_ScrollPixBeforeLoad=null;this.m_ScrollPix=-f;this.m_ScrollPix=this.m_ScrollPix-l}else{this.m_ScrollPix=-f}var c=Ext.get(this.m_DivId);var g=c.first("img");var h=new Ext.Template('<img class="sv-drag sv-highlight sv-dblclick" style="position:absolute;top:0px;left:0px;visibility:hidden;" src="{img_url}">');var k=h.append(c,e,true);c.setHeight(this.m_Height);k.move("right",this.m_ScrollPix);k.show();if(g){g.remove()}if(this.m_FromCgi.areas&&this.m_FromCgi.areas.length>0){this.m_App.addCustomFeatureFlags({view:this,areas:this.m_FromCgi.areas,callback:this.highligjtFlagedFeatures})}c.unmask();this.m_View.doLayout();var i=this.updateTitle(n);var d=this.toSeq();this.pushToHistory(d[0],d[2],i);this.updateStickyToolTip();this.updateSelectedRangeToolTip(this);this.m_App.updateMarkersPos(this);this.m_App.updateReflections();this.m_App.notifyViewLoaded(this)},highligjtFlagedFeatures:function(){if(this.m_FromCgi.areas){this.removeFeatMarks();Ext.each(this.m_FromCgi.areas,function(b){if((b.type&SeqView.AreaFlags.Dirty)!==0){var c=new SeqView.SelectionHighlighter(this,b,true);if(!this.m_HighLightedFeature){this.m_HighLightedFeature=[]}this.m_HighLightedFeature.push(c)}},this)}},updateStickyToolTip:function(){if(this.ToolTipsMgr){this.ToolTipsMgr.each(function(b){b.areaVisible(false);Ext.each(this.m_FromCgi.areas,function(c){if(c.signature==b.area.signature){if(b.area.qtip){c.qtip=b.area.qtip;delete b.area.qtip}b.area=c;b.areaVisible(true);if(b.delayedHighlight){b.highlightFeat();delete b.delayedHighlight}return false}})},this)}},updateSelectedRangeToolTip:function(){if(this.SelectedRangeToolTipsMgr){this.SelectedRangeToolTipsMgr.each(function(b){},this)}},clearCache:function(){this.m_PrevCgi=null;this.m_NextCgi=null;this.m_UrlFrom=null;this.m_UrlTo=null},scrollElements:function(e){this.m_App.scrollReflections(this,e);this.m_App.scrollMarkers(this,e);if(this.m_HighLightedFeature){Ext.each(this.m_HighLightedFeature,function(f){f.movePix(e)})}if(this.m_Selection){this.m_Selection.movePix(e)}var d=this.m_RangeSelectionSet;if(d&&d.length){var c=d.length;for(var b=0;b<c;++b){d[b].movePix(e)}}},updateImagePosition:function(b){var e=this.m_ScrollPix-b;this.m_ScrollPix=b;this.scrollElements(e);if(!this.m_LoadingImageShown){var c=Ext.get(this.m_DivId);var d=c.first("img");if(d){d.setX(this.m_ScrollPix+c.getX())}}},scrollViewTo:function(d,e){this.m_UrlFrom=null;this.m_UrlTo=null;var f=this.getScreenWidth();d=Math.min(0,d);d=Math.max(d,f-this.m_Width);this.updateImagePosition(d);var h=this.updateTitle();var c=this.toSeq();var k=Math.min(SeqView.ChunkWidth,this.m_FromCgi.img_width/10);if((d<f-this.m_Width+k&&!this.m_Loading&&e==SeqView.PAN_RIGHT)||(d>-k&&!this.m_Loading&&e==SeqView.PAN_LEFT)){var b,l;var i=Math.max(SeqView.MinBpp,this.m_LenSeq/this.m_Width);var g=true;if(e==SeqView.PAN_RIGHT){if(this.getFlip()&&this.m_FromSeq==0){g=false}if(c[1]>=Math.floor(this.m_App.m_SeqLength-k*i)){g=false}}else{if(e==SeqView.PAN_LEFT){if(!this.getFlip()&&this.m_FromSeq==0){g=false}if(this.getFlip()&&c[1]>=Math.floor(this.m_App.m_SeqLength-k*i)){g=false}}}if(g){b=c[0];l=c[2];this.m_Loading=true;this.m_ScrollPixBeforeLoad=this.m_ScrollPix;this.loadImage(b,l)}else{this.pushToHistory(c[0],c[2],h)}}else{this.pushToHistory(c[0],c[2],h)}},updateTitle:function(n){var i=this.toSeq();var k=this.m_App.posToLocal(i[0]);var s=this.m_App.posToLocal(i[1]);if(this.getFlip()){var u=k;k=s;s=u}var o=(this.m_App.m_ViewParams.acc_type=="protein"?"residues":"bases");var q="";var l=this.m_App.m_ViewParams.id+"&nbsp;("+this.m_App.m_SeqLength.shorten()+"&nbsp;"+o;if(this.m_App.m_Origin!=0){var c=this.m_App.m_Origin+1;l+=",&nbsp;sequence origin:&nbsp;"+c.commify()}l+=")";this.m_App.m_Panel.setTitle(l);q+=this.m_App.m_ViewParams.id+":&nbsp;";q+=k.shorten()+"-"+s.shorten();q+="&nbsp;("+(i[1]-i[0]+1).shorten();q+=(this.m_App.m_ViewParams.acc_type=="protein"?"rs":"bs");if(this.canFlip()){if(this.getFlip()){q+="-"}else{q+="+"}}q+=")";this.m_View.setTitle("<b>"+q+"</b>");var e=this.m_View.getTopToolbar();if(e){var r=e.getComponent("tbtitle"+this.m_Idx);if(r){var g="<b>";g+=this.m_App.m_ViewParams.id;g+=": "+this.m_App.m_Config.SeqInfo.title;g+="</b><br/><br/>";g+=k.commify()+"&nbsp;-&nbsp;"+s.commify();g+="<br/>";g+=(i[1]-i[0]+1).commify()+"&nbsp;";g+=(this.m_App.m_ViewParams.acc_type=="protein"?"residues":"bases");g+="&nbsp;shown";if(this.canFlip()){if(this.getFlip()){g+=",&nbsp;negative strand"}else{g+=",&nbsp;positive strand"}}r.setText("<b>"+q+"</b>");r.setTooltip(g)}var f=e.getComponent("sv-goto-box_"+this.m_Idx);var d=e.getComponent("sv-goto-btn_"+this.m_Idx);if(f){if(f.isVisible()&&this.getScreenWidth()<900){f.hide();if(d){d.hide()}}if(!f.isVisible()&&this.getScreenWidth()>900){f.show();if(d){d.show()}}}}var h="";h+=k.commify()+"&nbsp;-&nbsp;"+s.commify();h+="&nbsp;("+(i[1]-i[0]+1).commify()+"&nbsp;";h+=(this.m_App.m_ViewParams.acc_type=="protein"?"residues":"bases");if(this.canFlip()){if(this.getFlip()){h+=",&nbsp;negative"}else{h+=",&nbsp;positive"}}h+=")";var p=true;this.m_VisFromSeq=i[0];this.m_VisLenSeq=i[2];var b=Ext.get("new_view_link"+this.m_App.m_Idx);if(b){b.on({click:this.openFullView,scope:this})}if(!n||n.update_locator!==false){this.m_App.updateLocator(this)}if(p&&(!n||n.fire_event!==false)){this.m_App.fireEvent("visible_range_changed",this)}return h},pushToHistory:function(g,d,f){if(this.m_HistIx<0){this.m_HistIx=0}var e={from:g,len:d,title:f};if(this.m_HistIx<this.m_History.length){if(this.mf_HistoricalBack||(Math.abs(e.from-this.m_History[this.m_HistIx].from)<=1&&e.len==this.m_History[this.m_HistIx].len)){this.mf_HistoricalBack=false;return}if(this.m_HistIx>0){this.m_History=this.m_History.slice(this.m_HistIx);this.m_HistIx=0}this.m_History.unshift(e)}else{this.m_History.push(e);this.m_HistIx=this.m_History.length-1}this.mf_HistoricalBack=false;var b=10;var c=b;if(this.m_History.length>c){if(this.m_HistIx<c){this.m_History=this.m_History.slice(0,c)}else{this.m_History=this.m_History.slice(this.m_HistIx-c+1,c);this.m_HistIx=this.m_History.length-1}}this.updateHistoryButtons()},stepHistory:function(b){if(b){if(this.m_HistIx>0){this.m_HistIx--;this.mf_HistoricalBack=true;this.startImageLoading(this.m_History[this.m_HistIx].from,this.m_History[this.m_HistIx].len)}}else{if(this.m_HistIx<this.m_History.length-1){this.m_HistIx++;this.mf_HistoricalBack=true;this.startImageLoading(this.m_History[this.m_HistIx].from,this.m_History[this.m_HistIx].len)}}this.updateHistoryButtons()},updateHistoryButtons:function(){var f=this.m_View.getTopToolbar();if(f){var e=f.getComponent("histPrev"+this.m_Idx);if(e){var c="";if(this.m_HistIx>=this.m_History.length-1){e.disable();c="Back"}else{e.enable();if(this.m_HistIx+1<this.m_History.length){c+="Back to "+this.m_History[this.m_HistIx+1].title}}e.setTooltip(c)}var d=f.getComponent("histNext");if(d){var c="";if(this.m_HistIx<=0){d.disable();c="Forward"}else{d.enable();for(var b=this.m_HistIx-1;b>=0;b--){c+=this.m_History[b].title+"<br/>"}}d.setTooltip(c)}}},moveTo:function(e,g,d){if(g==this.m_VisLenSeq){var b=Math.round(this.seq2Pix(this.m_VisFromSeq));var f=Math.round(this.seq2Pix(e));var i=b-f;if(i==0){return}var h=Math.round(this.m_ScrollPix);h=h+i;var c=this.m_Width+this.m_ScrollPix-this.getScreenWidth();if(h>0||(i<0&&-i>c)){this.m_ZoomOP="locator";this.startImageLoading(e,g,d)}else{this.updateImagePosition(h);this.updateTitle(d)}}else{this.m_ZoomOP="locator";this.startImageLoading(e,g,d)}},syncToLocator:function(){if(!this.m_Locator){return}var c,d;if(this.m_Locator.m_ResizeRight){c=this.m_VisFromSeq}else{c=this.m_App.m_Panorama.toSeq(this.m_Locator.getLeft(true))}if(this.m_Locator.m_Scroll){d=c+this.m_VisLenSeq-1}else{d=this.m_App.m_Panorama.toSeq(this.m_Locator.getLeft(true)+this.m_Locator.getWidth()+3)}var b=d-c+1;this.moveTo(c,b,{update_locator:false})},checkLocatorWidth:function(c){var b=this.m_App.m_Panorama.toSeq(c+3);return SeqView.MinBpp<b/this.getScreenWidth()},hitTest:function(g){if(this.m_Loading){return null}var c=null;var f=Ext.get(this.m_DivId).getXY();var d=g[0]-f[0]-this.m_ScrollPix;var e=g[1]-f[1]+3;var b=function(k){var i=k.bounds;var l=this.getFlip()?i.r:i.l;var h=this.getFlip()?i.l:i.r;if(d>=l-1&&d<=h+1&&e>=i.t&&e<i.b){if(!c){c=[]}c.push(k)}};Ext.each(this.m_FromCgi.areas,b.createInterceptor(function(h){var i=h.signature;if(!i||i.length==0){return false}},this),this);return c},highlightElement:function(c){var b=this.hitTest(c);if(b&&!this.m_Selection){this.m_Selection=new SeqView.Selection(this,b)}else{if(!this.m_Selection||!b||b[0].signature!=this.m_Selection.areas[0].signature){this.removeFloatingSelection()}}},onMouseDown:function(d){if(d.button!==0||this.m_Loading){return}var g=d.getXY();var c;var f=Ext.fly(d.getTarget()).findParent("div.graphical_div",10,true);if(f){c=f.getXY()}if((c&&g[1]-c[1]<20)){d.stopEvent();if(!d.ctrlKey){this.removeSelectionsWithNoPinnedToolTips()}this.startRangeSelection(g[0],d.ctrlKey);return}this.m_PrevXY=g;if(Ext.fly(d.getTarget()).hasClass("sv-drag")){this.m_InDragAction=true;d.stopEvent();Ext.fly(this.m_DivId).setStyle("cursor","move");Ext.fly(d.getTarget()).setStyle("cursor","move");var b=this;this.m_DocMouseMove=document.onmousemove;document.onmousemove=function(h){if(!h){h=window.event}h=Ext.EventObject.setEvent(h);b.onMouseMove(h)};this.m_DocMouseUp=document.onmouseup;document.onmouseup=function(h){if(!h){h=window.event}h=Ext.EventObject.setEvent(h);b.onMouseUp(h)};this.m_DocMouseSaved=true}},onMouseUp:function(b){if(!this.m_PrevXY){return}if(this.m_InDragAction){Ext.fly(this.m_DivId).setStyle("cursor","default");try{Ext.fly(b.getTarget()).setStyle("cursor","default")}catch(b){}}this.m_InDragAction=false;this.m_PrevXY=null;if(this.m_DocMouseSaved){document.onmousemove=this.m_DocMouseMove;document.onmouseup=this.m_DocMouseUp;this.m_DocMouseMove=null;this.m_DocMouseUp=null;this.m_DocMouseSaved=false}},onMouseMove:function(h){SeqView.ClearBrowserSelection();if(this.m_InDragAction){if(!this.m_PrevXY){return}SeqView.ClearBrowserSelection();if(h.button!=0){this.onMouseUp(h);return}var g=h.getXY();var k=this.m_PrevXY[0]-g[0];if(k==0){return}var i=this.m_ScrollPix;i=i-k;this.m_PrevXY=g;this.scrollViewTo(i,k>0?SeqView.PAN_RIGHT:SeqView.PAN_LEFT);h.stopEvent()}else{if(Ext.fly(h.getTarget()).hasClass("sv-highlight")){this.highlightElement(h.getXY())}}var c=this.m_RangeSelectionSet.length;for(var b=0;b<c;b++){var f=this.m_RangeSelectionSet[b].m_ToolTip;var d=Ext.get(f.id);if(d){if(f.isInsideTootTip(h)||f.isInsideSelectedTopRectangle(h)){if(!f.isPinned()){f.show()}}else{if(!f.isPinned()){f.hide();f.removehighlightSelectedTopRectangle();f.highlightSelectedTopRectangle()}}}}var c=this.m_OrphanRangeToolTips.length;for(var b=0;b<c;b++){if(!this.m_OrphanRangeToolTips[b].isPinned()){console.log("there is unpinned orphan tooltip")}}},onMouseOut:function(b){},onContextMenu:function(b){b.stopEvent();if(this.m_Loading){return}this.showContextMenu(b)},showContextMenu:function(f,h){var g=new Ext.menu.Menu();var d=f.getPageX()-Ext.get(this.m_DivId).getX();var c=this.pix2Seq(d-this.m_ScrollPix);g.add({text:"Set New Marker At Position",iconCls:"xsv-markers",scope:this,handler:function(){this.m_App.newMarkerDlg(this,d)}});if(this.m_SelectedRangeSet&&this.m_SelectedRangeSet.length===1){g.add({text:"Set New Marker For Selection",iconCls:"xsv-markers",scope:this,handler:function(){this.m_App.addMarker(this.m_SelectedRangeSet[0]);this.removeRangeSelection(true)}})}g.add("-");if(this.m_App.m_Origin){g.add({text:"Reset Sequence Origin",iconCls:"xsv-origin",scope:this,handler:function(){this.m_App.clearOrigin()}})}else{g.add({text:"Set Sequence Origin At Position",iconCls:"xsv-origin",scope:this,handler:function(){this.m_App.setOrigin(this,d)}})}g.add({iconCls:"xsv-zoom_plus",text:"Zoom In",scope:this,handler:function(){this.zoomIn(c)}});g.add({iconCls:"xsv-zoom_minus",text:"Zoom Out",scope:this,handler:function(){this.zoomOut(c)}});g.add({iconCls:"xsv-zoom_seq",text:"Zoom To Sequence",scope:this,handler:function(){this.zoomSeq(c)}});g.add({iconCls:"xsv-zoom_range",text:"Zoom On Range",scope:this,handler:function(){this.zoomRange()}});g.add({iconCls:"xsv-new_view",text:"Add New Panel on Range",tooltip:"Create New Graphical Panel on Selected Range",scope:this,handler:function(){var e=new SeqView.Graphic(this.m_App);this.m_App.registerView(e);var l=-1,k=-1;var i=this.totalSelectedRange();if(i[0]!==-1&&i[1]!==-1){l=i[0];k=i[1];this.removeRangeSelection(true)}else{if(this.m_UrlFrom){l=this.m_UrlFrom;k=this.m_UrlTo}else{l=this.m_VisFromSeq+1;k=this.m_VisFromSeq+this.m_VisLenSeq}}if(l!==-1&&k!==-1){e.startImageLoading(l,k-l+1)}}});g.add("-");var b=new Ext.menu.Menu();if(this.m_SelectedRangeSet&&this.m_SelectedRangeSet.length>0&&this.m_SelectedRangeSet.length<=2){b.add({iconCls:"xsv-blast",text:"BLAST Search (Selection)",scope:this,handler:function(){this.blastSelection()}});b.add({iconCls:"xsv-primer",text:"Primer BLAST (Selection)",scope:this,handler:function(){this.primerBlast()}})}b.add({text:"BLAST Search (Visible Range)",iconCls:"xsv-blast",scope:this,handler:function(){var e=this.m_App.getBlastSearchURL();e+="&QUERY_FROM="+(this.m_VisFromSeq+1);e+="&QUERY_TO="+(this.m_VisFromSeq+this.m_VisLenSeq);window.open(e)}});b.add({text:"Primer BLAST (Visible Range)",iconCls:"xsv-primer",scope:this,handler:function(){this.primerBlast(false,[[this.m_VisFromSeq,this.m_VisFromSeq+this.m_VisLenSeq-1]])}});g.add({text:"Tools",tooltip:"Tools",iconCls:"xsv-views_tools",menu:b});if(this.m_App.m_NoConfDlg!==true&&!this.m_App.m_PermConfId){g.add("-");g.add({iconCls:"xsv-configure",text:"Configure",hidden:this.m_App.countActiveSeqPanels()!=1,scope:this,handler:function(){this.m_App.showTracksConfigDlg(0)}})}if(h){h(g)}if(g.items.length>0){g.showAt(f.getXY())}},onDblClick:function(f){if(!Ext.fly(f.getTarget()).hasClass("sv-dblclick")){return}if(this.m_Loading){return}var c=Ext.get(this.m_DivId).getXY();var g=f.getXY()[0]-c[0]-this.m_ScrollPix;var d=Math.abs(g);var b=this.pix2Seq(d);this.zoomIn(b)},createMarkerElem:function(b){var c=Ext.get(this.m_DivId);var d=b.getCreateParams(false,this.m_Idx);return d.template.append(c,d.options,true)},changeSelectedSig:function(e,d){if(e.type===undefined||(e.type&SeqView.AreaFlags.NoSelection)!==0){return}var c=this.m_SelectedSig?this.m_SelectedSig.split(";"):[];var b=e.signature;if(d){var f=c.indexOf(b);if(f!=-1){c.splice(f,1)}else{c.push(b)}b=c.join(";")}else{this.removeSelectionsWithNoPinnedToolTips()}if(this.setSelectedSig(b)){this.m_App.fireEvent("feature_clicked",this,e)}},setSelectedSig:function(b){if((!this.m_SelectedSig&&!b)||this.m_SelectedSig===b){return false}this.m_SelectedSig=b;this.refresh();return true},clearSelectedSig:function(){return this.setSelectedSig("")},zoomRange:function(){var d,c;var b=this.totalSelectedRange();if(this.m_UrlFrom){d=this.m_UrlFrom;c=this.m_UrlTo}else{if(b[0]!==-1&&b[1]!==-1){d=b[0];c=b[1];this.removeRangeSelection(true);this.startImageLoading(d,c-d+1);return}else{d=this.m_VisFromSeq+1;c=this.m_VisFromSeq+this.m_VisLenSeq}}this.gotoPositionDlg(true)},zoomRange4RangeToolTip:function(b){from=b[0];to=b[1];this.removeSelectionsWithNoPinnedToolTips();this.startImageLoading(from,to-from+1)},zoomIn:function(c){var d=this.m_VisLenSeq/2;var b=c?c:this.m_VisFromSeq+d;var e=Math.max(0,b-d/2);if(e+d>this.m_App.m_SeqLength){d=this.m_App.m_SeqLength-e}this.startImageLoading(e,d)},zoomSeq:function(c){var d=Math.floor(this.getScreenWidth()*SeqView.MinBpp);var b=c?c:this.m_VisFromSeq+d;var e=Math.max(0,b-d/2);if(e+d>this.m_App.m_SeqLength){d=this.m_App.m_SeqLength-e}this.startImageLoading(e,d)},zoomOut:function(c){var d=this.m_VisLenSeq*2;var b=c?c:this.m_VisFromSeq+this.m_VisLenSeq/2;var e=Math.max(0,b-d/2);if(e+d>this.m_App.m_SeqLength){d=this.m_App.m_SeqLength-e}this.startImageLoading(e,d)},flipStrand:function(){this.setFlip(!this.getFlip())},gotoPosition:function(c,k,i){k=k.replace(/[, ]/g,"");if(c!=="ok"||k.length===0){return}var g=this.m_App.parsePosOrRange(k);if(!g||(i&&g.length!==2)){Ext.MessageBox.alert(title,"Invalid "+(i?"":"position/")+"range.");return}var b=g[0];var h=this.m_VisLenSeq;if(g.length===2){var f=g[1];h=f-b+1}else{if(h>=this.m_App.m_SeqLength*0.8){var d=b;if(d-500000<0&&d+500000>this.m_App.m_SeqLength){if(d-500<0&&d+500>this.m_App.m_SeqLength){var e=this.getScreenWidth();b=d-e/8/2;h=e/8}else{b=d-500;h=1000}}else{b=d-500000;h=1000000}}if(b<0){b=0}if(b+h>this.m_App.m_SeqLength){b-=b+h-this.m_App.m_SeqLength;if(b<0){new_form=0;h=this.m_App.m_SeqLength}}}this.startImageLoading(b,h)},gotoAndSearch:function(){var b=Ext.getCmp("sv-goto-box_"+this.m_Idx).getValue();if(b!=null&&b.length>0){if(b.charAt(0)=="-"||b.charAt(0)=="+"||b.charAt(0)=="0"||b.charAt(0)=="1"||b.charAt(0)=="2"||b.charAt(0)=="3"||b.charAt(0)=="4"||b.charAt(0)=="5"||b.charAt(0)=="6"||b.charAt(0)=="7"||b.charAt(0)=="8"||b.charAt(0)=="9"){this.gotoPosition("ok",b)}else{this.m_App.openSearchDlg("ok",b)}}},gotoPositionDlg:function(b){var c=b?"Zoom to range":"Go to position/range";Ext.MessageBox.prompt(c,"Enter sequence "+(b?"":"position or")+" range<br />(possible range formats are 10k-20k, -20--10, -10k:-5, 5 to 515, -1m..1m):",function(d,e){this.gotoPosition(d,e,b)},this,false)},primerBlastRangeToolTip:function(b){var c=this.m_App.m_ViewParams;if(c.acc_type!=="DNA"){return}this.m_App.primerBlast(false,b)},primerBlast:function(b,c){var d=this.m_App.m_ViewParams;if(d.acc_type!=="DNA"){return}if(!c){c=this.m_SelectedRangeSet}if(!b&&(!c||c.length<1||c.length>2)){return}if(b){c=[[0,this.m_App.m_SeqLength-1]]}this.m_App.primerBlast(b,c)},blastSelection:function(){if(!this.m_SelectedRangeSet||this.m_SelectedRangeSet.length<1){return}var b=this.totalSelectedRange();var c=this.m_App.getBlastSearchURL();c+="&QUERY_FROM="+(b[0]+1);c+="&QUERY_TO="+(b[1]+1);window.open(c)},blastSelectionRangeToolTip:function(b){var c=this.m_App.getBlastSearchURL();c+="&QUERY_FROM="+(b[0]+1);c+="&QUERY_TO="+(b[1]+1);window.open(c)},openFullView:function(){var f=this.m_App.m_Config.SeqInfo;var e="http://www.ncbi.nlm.nih.gov/";if(f.gi){var c=f.acc_type=="DNA"?"nuccore":"protein";e+=c+"/"+f.gi+"?report=graph"}else{e+="projects/sviewer/?id="+this.m_App.GI}if(this.m_App.m_Origin!=0){e+="&origin="+this.m_App.m_Origin}if(this.m_UrlFrom&&this.m_UrlTo){e+="&v="+v.m_UrlFrom+":"+v.m_UrlTo}else{e+="&v="+(this.m_VisFromSeq+1)+":"+(this.m_VisFromSeq+this.m_VisLenSeq)}e+="&flip="+this.getFlip();e+="&select="+(this.m_SelectedSig?this.m_SelectedSig:"null");var d=this.m_App.m_Config.Options;Ext.each(["color","label","decor","spacing"],function(g){e+="&"+g+"=";idx=d.controls[g].indexOf(d["curr_"+g]);e+=(idx==-1?0:idx)});e+="&content="+d.curr_content;if(this.m_App.m_MarkersInfo){e+=this.m_App.m_MarkersInfo.getMarkersURL()}if(this.m_App.m_Key){e+="&key="+this.m_App.m_Key}if(this.m_App.m_SRZ){e+="&srz="+this.m_App.m_SRZ}if(this.m_App.m_BamPath){e+="&bam_path="+this.m_App.m_BamPath}if(this.m_App.m_DepthLimit){e+="&depthlimit="+this.m_App.m_DepthLimit}var b=this.m_App.m_Tracks||this.m_App.m_TracksFromURL;if(b){e+="&tracks="+b}if(this.m_App.m_ViewerContext){e+="&viewer_context="+this.m_App.m_ViewerContext}if(this.m_App.m_AppName){e+="&appname="+this.m_App.m_AppName}SeqView.ping({jsevent:"sv-openFullView"});window.open(e)}})})();Ext.namespace("SeqView.TM");SeqView.TM.CGIprefix="";SeqView.TM.ConfigName="ISCA";SeqView.TM.SEQID="nc_000001.9";SeqView.TM.TrackDetail=Ext.extend(Ext.Panel,{initComponent:function(){Ext.apply(this,{bodyStyle:{background:"#F0F0F0",padding:"5px","overflow-y":"auto","overflow-x":"hidden"},title:"Track Settings",layout:"form",labelWidth:130});SeqView.TM.TrackDetail.superclass.initComponent.call(this)},updateDetail:function(g,h){var b=this;this.items.each(function(i){b.remove(i)});var f=g.display_name||g.name;b.setTitle("Track Settings: "+f);if(g.help){b.add({xtype:"fieldset",style:"padding: 5px;",items:{xtype:"displayfield",hideLabel:true,value:g.help}})}if(g.choice_list.length==0&&g.check_boxes.length==0){b.add({xtype:"displayfield",hideLabel:true,value:"<i>No settings available</i>"})}if(g.choice_list.length>0){Ext.each(g.choice_list,function(l){var o=[];var n="";var k=null;Ext.each(l.values,function(p){o.push(p.display_name);if(l.curr_value==p.name){n=p.display_name;k=g.help}});var i=new Ext.form.ComboBox({disabled:!g.shown,plugins:new Ext.ux.plugin.triggerfieldTooltip(),tooltip:{text:l.help},getItemToolTip:function(p){var q=this.choiceLst.values[p].help;return{text:q}},fieldLabel:l.display_name,mode:"local",store:o,width:400,triggerAction:"all",value:n,editable:false,allowBlank:false,choiceLst:l,listeners:{select:function(s,q,p){var t=s.choiceLst.curr_value;if(t!=s.choiceLst.values[p].name){s.choiceLst.curr_value=s.choiceLst.values[p].name}}}});b.add(i)})}if(g.check_boxes.length>0){for(var c=0;c<g.check_boxes.length;++c){var e=g.check_boxes[c];var d=new Ext.form.Checkbox({disabled:!g.shown,width:400,boxLabel:e.display_name,checked:e.value,tooltip:e.help,rcbox:e,listeners:{check:function(i,k){i.rcbox.value=k}}});if(c==0){d.fieldLabel="Other Settings"}else{d.fieldLabel="&nbsp;";d.labelSeparator=""}b.add(d)}}b.doLayout()}});SeqView.TM.collectAcitveTracks=function(b){var c=[];Ext.each(b,function(d){Ext.each(d.subcategories,function(e){Ext.each(e.tracks,function(f){if(f.shown){if(d.name&&d.name!="other"){f.cat_name=d.name}else{delete f.cat_name}if(e.name&&e.name!="other"){f.subcat_name=e.name}else{delete f.subcat_name}c.push(f)}})})});c.sort(function(e,d){return e.order-d.order});return c};SeqView.TM.Category=Ext.extend(Ext.Panel,{initComponent:function(){this.title=this.category.display_name;this.layout="fit",this.items=new SeqView.TM.TracksPanel({subcategories:this.category.subcategories});SeqView.TM.Category.superclass.initComponent.call(this)},reloadTracks:function(){this.items.each(function(b){b.reloadTracks()})}});SeqView.TM.TracksPanel=Ext.extend(Ext.Panel,{initComponent:function(){if(this.subcategories){this.gridPanel=this.subcategories.length!=1?new SeqView.TM.GroupGrid({subcategories:this.subcategories}):new SeqView.TM.Grid({tracks:this.subcategories[0].tracks})}else{if(this.tracks){this.gridPanel=this.activeTracks?new SeqView.TM.ActiveTracksGrid({tracks:this.tracks}):new SeqView.TM.Grid({tracks:this.tracks})}}Ext.apply(this.gridPanel,{region:"center"});this.detailPanel=new SeqView.TM.TrackDetail({region:"south",split:true,height:200,minSize:100,collapsible:true});var b=[this.gridPanel,this.detailPanel];if(this.activeTracks){var c={region:"north",border:false,bodyStyle:{padding:"5px 0px 5px 5px","font-size":"14px"},html:"Click on track to display settings. To re-order tracks, drag and drop track names."};b.push(c)}Ext.apply(this,{border:false,layout:"border",items:b});SeqView.TM.TracksPanel.superclass.initComponent.call(this)},initEvents:function(){SeqView.TM.TracksPanel.superclass.initEvents.call(this);var b=this.gridPanel.getSelectionModel();b.on("rowselect",this.onRowSelect,this);this.gridPanel.on("viewready",function(c){c.getSelectionModel().selectRow(0)})},onRowSelect:function(e,c,b){var d=this.gridPanel.getView().getRow(c);this.detailPanel.updateDetail(b.data,Ext.get(d).getY())},reloadTracks:function(){this.gridPanel.reloadTracks()},setTracks:function(b){this.gridPanel.setTracks(b)}});SeqView.TM.MainPanel=Ext.extend(Ext.Panel,{initComponent:function(){Ext.apply(this,{title:"Tracks",layout:"fit",itemId:"trackpanel",dirty:false,items:this.createPanel(),listeners:{show:function(b){b.doLayout()}}});SeqView.TM.MainPanel.superclass.initComponent.call(this)},reload:function(c){this.removeAll();this.categories=c;this.dirty=false;var b=this.createPanel();this.add(b);if(this.isVisible()){this.doLayout()}},createPanel:function(){var c=this.categories;var d=[new SeqView.TM.TracksPanel({title:"Active Tracks",activeTracks:true,tracks:[],listeners:{activate:function(f){var e=SeqView.TM.collectAcitveTracks(c);f.setTracks(e)}}})];Ext.each(c,function(e){d.push(new SeqView.TM.Category({category:e,listeners:{activate:function(f){f.reloadTracks()}}}))});var b=new Ext.ux.tot2ivn.VrTabPanel({activeTab:0,plain:true,tabWidth:150,items:d});return b},setDirty:function(b){this.dirty=(b===true)}});Ext.override(Ext.form.BasicForm,{beforeAction:function(b){this.items.each(function(d){if(d.isFormField&&d.syncValue){d.syncValue()}});var c=b.options;if(c.waitMsg){if(this.waitMsgTarget===true){this.el.mask(c.waitMsg,"x-mask-loading")}else{if(this.waitMsgTarget){this.waitMsgTarget=Ext.get(this.waitMsgTarget);this.waitMsgTarget.mask(c.waitMsg,"x-mask-loading")}else{Ext.MessageBox.show({wait:true,msg:c.waitMsg,title:(c.waitTitle||this.waitTitle),icon:(c.waitIcon||"ext-mb-download")})}}}}});SeqView.TM.UploadPanel=Ext.extend(Ext.Panel,{initComponent:function(){var b=this.uploadURL||SeqView.TM.CGIprefix+"sv_data.cgi";var c=this.accession||"";Ext.apply(this,{title:"Custom Data",layout:"border",itemId:"uploadpanel",items:[{region:"west",split:true,layout:"fit",width:160,title:"Data Source",items:[{loader:new Ext.tree.TreeLoader(),rootVisible:false,enableDD:false,lines:false,xtype:"treepanel",autoScroll:true,listeners:{click:function(h,p){var q=h.attributes.type;var f=this.createPanels(h.attributes.type);var d=Ext.getCmp("loaddatapanel");var k=d.getComponent("diff_part");var g=d.getForm();for(var n=0,o=k.items.getCount();n<o;n++){var l=k.get(n);g.remove(l)}d.remove(k);d.insert(0,f);d.setTitle(h.text);g.fileUpload=(q=="file");d.doLayout()},scope:this},root:new Ext.tree.AsyncTreeNode({children:[{text:"BLAST Results",type:"rid",iconCls:"xsv-ext_data",leaf:true},{text:"Data File",type:"file",iconCls:"xsv-ext_data",leaf:true},{text:"URL",type:"url",iconCls:"xsv-ext_data",leaf:true},{text:"Text",type:"text",iconCls:"xsv-ext_data",leaf:true}]})}]},{frame:true,xtype:"form",region:"center",title:"BLAST Results",bodyStyle:"padding:5px;",url:b,hidden:false,id:"loaddatapanel",items:[this.createPanels("rid"),{xtype:"panel",layout:"form",bodyStyle:{"padding-top":"10px"},items:[{xtype:"checkbox",name:"overwrite",hideLabel:true,height:25,boxLabel:"Overwrite Previously loaded data",checked:true},{xtype:"textfield",fieldLabel:"Track Name",id:"track_name",name:"track_name",width:"95%"},{xtype:"hidden",name:"data_action",value:"uploading"},{xtype:"hidden",name:"key",value:"",id:"ext_data_key"},{xtype:"hidden",name:"accession",value:c}]}]}],listeners:{deactivateww:function(e){console.log("deactivate");console.log(e);var d=this.get(1).getForm();if(d.isValid()){Ext.each(["blast_rid","data_file_name","data_url","data_text"],function(h){var k=null;if((d.items.keys.indexOf(h)!=-1)&&(k=d.items.get(h))){var n=k.getValue();if(n.length>0){var l=Ext.MessageBox.show({title:"External Data Upload",msg:"Upload external data?",buttons:Ext.MessageBox.YESNO,icon:Ext.MessageBox.QUESTION,fn:function(f){if(f=="yes"){this.submitForm(d)}},scope:this});var g=0;g++}}})}}},buttons:[{text:"Upload",scope:this,handler:function(){var d=this.get(1).getForm();if(d.isValid()&&d.isDirty()){this.submitForm(d)}}}]});SeqView.TM.UploadPanel.superclass.initComponent.call(this)},isDirty:function(){var e=this.get(1).getForm();var d=["blast_rid","data_file_name","data_url","data_text"];for(var c=0,b=d.length,g=null;c<b;++c){if(e.items.keys.indexOf(d[c])&&(g=e.items.get(d[c]))){var h=g.getValue();if(h&&h.length>0){return true}}}return false},reset:function(){var e=this.get(1).getForm();var d=["blast_rid","data_file_name","data_url","data_text"];for(var c=0,b=d.length,g=null;c<b;++c){if(e.items.keys.indexOf(d[c])&&(g=e.items.get(d[c]))){g.setValue("")}}},uploadData:function(e,c,b){var d=this.get(1).getForm();if(d.isValid()&&this.isDirty()){e.msgBox=Ext.MessageBox.show({title:"External Data Upload",msg:"Upload external data?",buttons:Ext.MessageBox.YESNO,icon:Ext.MessageBox.QUESTION,fn:function(f){delete e.msgBox;if(f=="yes"){this.submitForm(d,function(){c.suspendEvents();if(b.dirty){e._loadTracks(false)}c.setActiveTab(b);c.resumeEvents()})}else{c.suspendEvents();c.setActiveTab(b);c.resumeEvents()}},scope:this});return false}return true},submitForm:function(c,d,b){c=c||this.get(1).getForm();if(!c.findField("overwrite").getValue()){if(this.userData){Ext.getCmp("ext_data_key").setValue(this.userData)}}else{Ext.getCmp("ext_data_key").setValue("")}c.submit({waitMsg:"Uploading your data, please wait...",waitTitle:"Uploading...",scope:this,success:function(e,g){this.userData=g.result.key;var f=this.ownerCt.getComponent("trackpanel");f.setDirty(true);this.reset();if(d){d.call(b||this)}},failure:function(e,f){var g=f.result?f.result.msg:f.response.statusText;Ext.MessageBox.show({title:"External Data",msg:g,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}})},createPanels:function(b){switch(b){case"rid":return new Ext.Panel({id:"diff_part",items:rid_items=[{xtype:"displayfield",name:"help",value:"Please enter NCBI BLAST request ticket (RID) then press Upload to add new alignment track.",width:"95%",style:{paddingBottom:"10px",fontSize:"122%"}},{xtype:"hidden",name:"format",value:b,id:"data_format"},{xtype:"textfield",id:"blast_rid",hideLabel:true,emptyText:"Please enter Blast RID",name:"rid",width:"95%"},{xtype:"checkbox",id:"find_comp",height:25,boxLabel:"Link related hits together",checked:true},{xtype:"displayfield",name:"help",value:"BLAST returns separate alignments for each query, and these separate alignments can further be ordered into sets offering consistent non-overlapping query and subject coverage.  The sequence viewer offers the ability to evaluate the original BLAST hits on-the-fly and link together alignments that meet a strict definition of non-overlapping query and subject coverage.",width:"95%"}]});case"file":return new Ext.Panel({id:"diff_part",items:[{xtype:"displayfield",name:"help",value:"Please specify the input file then press Upload to add new track(s).",width:"95%",style:{paddingBottom:"10px",fontSize:"122%"}},{xtype:"hidden",name:"format",value:b,id:"data_format"},{xtype:"panel",id:"browsebutton",layout:"form",items:[{xtype:"textfield",id:"data_file_name",autoHeight:true,inputType:"file",fieldLabel:"File to upload",name:"itemFile"},{xtype:"combo",triggerAction:"all",width:120,id:"sv-file_format",fieldLabel:"File format",mode:"local",store:["auto detect","asn binary","asn text","bed","bed 15","gtf/gff","wiggle","xml"],allowBlank:false,editable:false,value:"auto detect"}]}]});case"url":return new Ext.Panel({id:"diff_part",items:[{xtype:"displayfield",name:"help",value:"Please specify the WEB URL to download the input file then press Upload to add new track(s).",width:"95%",style:{paddingBottom:"10px",fontSize:"122%"}},{xtype:"hidden",name:"format",value:b,id:"data_format"},{xtype:"textfield",id:"data_url",hideLabel:true,emptyText:"Please enter URL",name:"url",width:"95%"}]});case"text":return new Ext.Panel({id:"diff_part",items:[{xtype:"displayfield",name:"help",value:"Please paste you text annotations then press Upload to add new track.",width:"95%",style:{paddingBottom:"10px",fontSize:"122%"}},{xtype:"hidden",name:"format",value:b,id:"data_format"},{xtype:"textarea",id:"data_text",hideLabel:true,emptyText:"Please paste your text here",name:"text",width:"95%",height:135}]});default:return null}return null}});SeqView.TM.OptionsPanel=Ext.extend(Ext.Panel,{initComponent:function(){Ext.apply(this,{title:"Options",layout:"fit",frame:true,itemId:"optionspanel",items:this.createItems(),listeners:{show:function(b){b.doLayout()}}});SeqView.TM.OptionsPanel.superclass.initComponent.call(this)},createItems:function(){var b=[["color","Coloration"],["label","Label Placement"],["decor","Shapes"],["spacing","Spacing"]];var d=[];Ext.each(b,function(e){d.push({xtype:"combo",triggerAction:"all",fieldLabel:e[1],mode:"local",name:"curr_"+e[0],store:this.options.controls[e[0]],allowBlank:false,editable:false,value:this.options["curr_"+e[0]]})},this);var c=new Ext.form.FormPanel({labelWidth:100,bodyStyle:{"padding-top":"10px"},items:d});return c},getValues:function(){var b=this.items.get(0).getForm();return this.rendered&&b.el&&b.el.dom?b.getValues():null},reload:function(c){this.removeAll();this.options=c;var b=this.createItems();this.add(b);if(this.isVisible()){this.doLayout()}}});SeqView.TM.processTracksInfo=function(b){var c=[];var e=function(g,h){var i=null;Ext.each(g,function(k){if(k.name==h){i=k;return false}});return i};var f=0;var d=function(){return f++};Ext.each(b,function(h){var g=null;h.uuid=d();if(!h.display_name){h.display_name=h.name}if(!h.order&&h.order!==0){h.order=100}if(h.category){g=e(c,h.category.name);if(!g){g=Ext.ux.clone(h.category);g.subcategories=[];c.push(g)}}else{g=e(c,"other");if(!g){g={name:"other",display_name:"Other",help:"Other tracks"};g.subcategories=[];c.push(g)}}var i=null;if(h.subcategory){i=e(g.subcategories,h.subcategory.name);if(!i){i=Ext.ux.clone(h.subcategory);i.tracks=[];g.subcategories.push(i)}}else{i=e(g.subcategories,"other");if(!i){i={name:"other",display_name:"Other",help:"Other tracks"};i.tracks=[];g.subcategories.push(i)}}i.tracks.push(h)});return c};SeqView.TM.generateTracksString=function(b){b=b||SeqView.TM.categories;if(!b){return null}var c=SeqView.TM.collectAcitveTracks(b);var d="";Ext.each(c,function(e){d+="[";d+="key:"+e.key;if(e.name&&e.name.length>0){d+=",name:"+SeqView.escapeName(e.name)}if(e.display_name&&e.display_name.length>0){d+=",display_name:"+SeqView.escapeName(e.display_name)}if(e.subkey&&e.subkey.length>0){d+=",subkey:"+e.subkey}if(e.cat_name&&e.cat_name.length>0){d+=",category:"+e.cat_name}if(e.subcat_name&&e.subcat_name.length){d+=",subcategory:"+e.subcat_name}Ext.each(e.annots,function(g,f){d+=f==0?",annots:":"|";d+=SeqView.escapeName(g)});Ext.each(e.comments,function(g,f){d+=f==0?",comments:":"|";d+=SeqView.escapeName(g.label)+"|"+g.pos_str});Ext.each(e.highlights,function(g,f){d+=f==0?",highlights:":"|";d+=SeqView.escapeName(g)});if(e.filter&&e.filter.length>0){d+=",filter:"+SeqView.escapeName(e.filter)}Ext.each(e.choice_list,function(f){d+=","+f.name+":"+f.curr_value});Ext.each(e.check_boxes,function(f){d+=","+f.name+":"+(f.value?"true":"false")});Ext.each(e.hidden_settings,function(f){d+=","+f.name+":"+f.value});d+="]"});return d};SeqView.TM.generateTracksStringForConfig=function(b){b=b||SeqView.TM.categories;if(!b){return null}var c="";Ext.each(b,function(d){Ext.each(d.subcategories,function(e){Ext.each(e.tracks,function(f){c+="[";c+="key:"+f.key;if(f.name&&f.name.length>0){c+=",name:"+SeqView.escapeName(f.name)}if(f.display_name&&f.display_name.length>0){c+=",display_name:"+SeqView.escapeName(f.display_name)}if(f.subkey&&f.subkey.length>0){c+=",subkey:"+f.subkey}if(d.name!="other"){c+=",category:"+d.name}if(e.name!="other"){c+=",subcategory:"+e.name}Ext.each(f.annots,function(h,g){c+=g==0?",annots:":"|";c+=SeqView.escapeName(h)});Ext.each(f.comments,function(h,g){c+=g==0?",comments:":"|";c+=SeqView.escapeName(h.label)+"|"+h.pos_str});Ext.each(f.highlights,function(h,g){c+=g==0?",highlights:":"|";c+=SeqView.escapeName(h)});if(f.filter&&f.filter.length>0){c+=",filter:"+SeqView.escapeName(f.filter)}Ext.each(f.choice_list,function(g){c+=","+g.name+":"+g.curr_value});Ext.each(f.check_boxes,function(g){c+=","+g.name+":"+(g.value?"true":"false")});Ext.each(f.hidden_settings,function(g){c+=","+g.name+":"+g.value});c+=",order:"+f.order;c+=",shown:"+(f.shown?"true":"false");c+="]"})})});return c};SeqView.TM.ConfigDialog=Ext.extend(Ext.Window,{toFront:function(b){if(!this.msgBox){SeqView.TM.ConfigDialog.superclass.toFront.call(this,b)}},initComponent:function(){var b=SeqView.TM.processTracksInfo(this.seqConfig.TrackConfig);Ext.apply(this,{modal:true,title:"Configure Page",width:780,height:550,layout:"fit",items:this.createMainPanel(b),buttons:[{text:"Configure",scope:this,handler:function(c){if(this.sviewApp){if(this.uploadPanel.isDirty()){this.uploadPanel.submitForm(null,this.finishDialog,this)}else{this.finishDialog()}}else{this.close()}}},{text:"Load Defaults",scope:this,handler:function(c){this._loadTracks(true)}},{text:"Cancel",scope:this,handler:function(){this.close()}}]});SeqView.TM.ConfigDialog.superclass.initComponent.call(this)},finishDialog:function(){var b=this.uploadPanel.userData;if(this.tracksPanel.dirty){this.getEl().mask("Loading...","x-mask-loading");this.seqConfig.load({user_data:b,callback:{success:function(d){var c=SeqView.TM.processTracksInfo(d.TrackConfig);this.updateSeqViewApp(b,c);this.close()},failure:function(c){var e=Ext.decode(c.responseText);var d=e.success===false?e.msg:c.responseText;Ext.MessageBox.show({title:"Configuration loading error",msg:d,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})},scope:this},forcereload:true})}else{this.updateSeqViewApp(b,this.categories);this.close()}}});SeqView.TM.Common={updateSeqViewApp:function(c,d){var b=this.optionsPanel.getValues();if(b){Ext.apply(this.seqConfig.Options,b)}var e=SeqView.TM.generateTracksStringForConfig(d);this.seqConfig.save({tracks:e,callback:{success:function(g){if(!c||c.length==0){c=null}var f=SeqView.TM.generateTracksString(d);if(!f||f.length==0){f=null}this.sviewApp.updateConfig(this.seqConfig,c,f)},failure:function(f){var h=Ext.decode(f.responseText);var g=h.success===false?h.msg:f.responseText;Ext.MessageBox.show({title:"Configuration saving error",msg:g,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})},scope:this}})},createMainPanel:function(d){this.categories=d;this.tracksPanel=new SeqView.TM.MainPanel({categories:this.categories});this.uploadPanel=new SeqView.TM.UploadPanel({uploadURL:this.svDataCgi,userData:this.userData,accession:this.accession});this.optionsPanel=new SeqView.TM.OptionsPanel({options:this.seqConfig.Options});var b=this.activeTab||0;var c=new Ext.TabPanel({activeTab:b,items:[this.tracksPanel,this.uploadPanel,this.optionsPanel],listeners:{beforetabchange:function(g,e,f){if(f===this.uploadPanel){if(this.uploadPanel.uploadData(this,g,e)===false){return false}}if(e===this.tracksPanel){if(e.dirty){this._loadTracks(false)}}},scope:this}});return c},_loadTracks:function(c){this.getEl().mask("Loading...","x-mask-loading");if(c){this.uploadPanel.userData=null}var b=this.uploadPanel.userData;this.seqConfig.load({defaultcfg:c,user_data:b,callback:{success:function(d){this.categories=SeqView.TM.processTracksInfo(d.TrackConfig);this.tracksPanel.reload(this.categories);if(c){this.optionsPanel.reload(d.Options)}this.getEl().unmask()},failure:function(d){var f=Ext.decode(d.responseText);var e=f.success===false?f.msg:d.responseText;Ext.MessageBox.show({title:"Configuration loading error",msg:e,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});this.getEl().unmask()},scope:this},forcereload:true})}};SeqView.TM.ShowConfigDialog=function(d,b){var e=new SeqView.Config(d);e.TrackConfig=Ext.ux.clone(d.m_Config.TrackConfig);e.Options=Ext.ux.clone(d.m_Config.Options);var c=new SeqView.TM.ConfigDialog({accession:d.m_Config.SeqInfo.id,svDataCgi:d.m_CGIs.SvData,userData:d.m_Key,seqConfig:e,sviewApp:d,renderTo:d.m_PermConfId,activeTab:b||0});c.show()};Ext.apply(SeqView.TM.ConfigDialog.prototype,SeqView.TM.Common);SeqView.TM.ConfigPanel=Ext.extend(Ext.Panel,{initComponent:function(){var b=SeqView.TM.processTracksInfo(this.seqConfig.TrackConfig);Ext.apply(this,{title:"Configure Page",height:550,border:false,layout:"fit",items:this.createMainPanel(b),fbar:[{text:"Configure",scope:this,handler:function(c){if(this.sviewApp){if(this.uploadPanel.isDirty()){this.uploadPanel.submitForm(null,this.finishDialog,this)}else{this.finishDialog()}}}},{text:"Load Defaults",scope:this,handler:function(c){this._loadTracks(true)}},{text:"Cancel",scope:this,handler:function(){this.seqConfig.TrackConfig=Ext.ux.clone(this.sviewApp.m_Config.TrackConfig);this.seqConfig.Options=Ext.ux.clone(this.sviewApp.m_Config.Options);this.categories=SeqView.TM.processTracksInfo(this.seqConfig.TrackConfig);this.tracksPanel.reload(this.categories);this.optionsPanel.reload(this.seqConfig.Options)}}]});SeqView.TM.ConfigPanel.superclass.initComponent.call(this)},finishDialog:function(){var b=this.uploadPanel.userData;if(this.tracksPanel.dirty){this.getEl().mask("Loading...","x-mask-loading");this.seqConfig.load({user_data:b,callback:{success:function(d){var c=SeqView.TM.processTracksInfo(d.TrackConfig);this.updateSeqViewApp(b,c)},failure:function(c){var e=Ext.decode(c.responseText);var d=e.success===false?e.msg:c.responseText;Ext.MessageBox.show({title:"Configuration loading error",msg:d,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})},scope:this},forcereload:true})}else{this.updateSeqViewApp(b,this.categories)}}});Ext.apply(SeqView.TM.ConfigPanel.prototype,SeqView.TM.Common);SeqView.TM.ShowConfigPanel=function(d,b){var e=new SeqView.Config(d);e.TrackConfig=Ext.ux.clone(d.m_Config.TrackConfig);e.Options=Ext.ux.clone(d.m_Config.Options);var c=new Ext.Panel({layout:"fit",border:false,monitorResize:true,renderTo:d.m_PermConfId,items:new SeqView.TM.ConfigPanel({accession:d.m_Config.SeqInfo.id,svDataCgi:d.m_CGIs.SvData,userData:d.m_Key,seqConfig:e,sviewApp:d})});c.show()};Ext.namespace("SeqView.TM");SeqView.TM.GridToolTip=Ext.extend(Ext.ToolTip,{onTargetOver:function(b){this.baseTarget=b.getTarget();SeqView.TM.GridToolTip.superclass.onTargetOver.call(this,b)},onMouseMove:function(b){if(!b.within(this.baseTarget)){this.onTargetOver(b);return false}SeqView.TM.GridToolTip.superclass.onMouseMove.call(this,b)}});SeqView.TM.GridBase=Ext.extend(Ext.grid.GridPanel,{initComponent:function(){var b=this.getCfgObj();Ext.apply(this,{hideHeaders:true,border:false,enableHdMenu:false,enableColumnMove:false,colModel:new Ext.grid.ColumnModel(b.columns),plugins:b.plugins,selModel:new Ext.grid.RowSelectionModel({singleSelect:true})});SeqView.TM.GridBase.superclass.initComponent.call(this);this.addClass("sv-tmgr-grid")},reloadTracks:function(){var d=this.getSelectionModel();var c=d.getSelected();var b=c?this.getStore().indexOf(c):null;this.getStore().loadData(this.tracks);if(b!==null){d.selectRow(b)}},updateRealRecord:function(b,c){Ext.each(this.tracks,function(d){if(d.uuid==b.uuid){d.shown=!d.shown;return false}})},getCfgObj:function(){var b=new Ext.ux.grid.ShowColumn({header:"Active",dataIndex:"shown",width:25,fixed:true});return{columns:[b,{id:"name",header:"Name",dataIndex:"display_name",sortable:false}],plugins:[b]}},onRender:function(){SeqView.TM.GridBase.superclass.onRender.apply(this,arguments);this.tooltip=new SeqView.TM.GridToolTip({renderTo:Ext.getBody(),target:this.view.mainBody,listeners:{beforeshow:function(g){if(this.inDragNDrop){this.tooltip.hide();return false}var c=this.getView();var f=c.findRowIndex(g.baseTarget);var b=c.findCellIndex(g.baseTarget);if(f!==false&&b!==false&&(b===0||b===1)){var e=this.getStore().getAt(f);var d=e.data.help?e.data.help:"";this.tooltip.body.update(d)}else{this.tooltip.hide();return false}},scope:this}})}});SeqView.TM.Grid=Ext.extend(SeqView.TM.GridBase,{initComponent:function(){Ext.apply(this,{store:new Ext.data.JsonStore({fields:["uuid","shown","name","display_name","key","subkey","annots","choice_list","check_boxes","help","legend_text"],data:this.tracks}),viewConfig:{scrollOffset:2,forceFit:true}});SeqView.TM.Grid.superclass.initComponent.call(this)}});SeqView.TM.GroupGrid=Ext.extend(SeqView.TM.GridBase,{initComponent:function(){var d=[];Ext.each(this.subcategories,function(e){Ext.each(e.tracks,function(f){f.subcat=e.display_name;d.push(f)})});this.tracks=d;var b=new Ext.data.JsonReader({fields:["uuid","shown","name","display_name","key","subkey","annots","choice_list","check_boxes","help","legend_text","subcat"]});var c=new Ext.data.GroupingStore({reader:b,data:this.tracks,sortInfo:{field:"subcat",direction:"ASC"},groupField:"subcat"});Ext.apply(this,{store:c,view:new Ext.grid.GroupingView({scrollOffset:2,forceFit:true,hideGroupedColumn:true,groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "Items" : "Item"]})'})});SeqView.TM.GroupGrid.superclass.initComponent.call(this)},getCfgObj:function(){var b=SeqView.TM.GroupGrid.superclass.getCfgObj.call(this);b.columns.push({id:"subcat",header:"Category",dataIndex:"subcat",sortable:false});return b},updateRealRecord:function(b,c){Ext.each(this.tracks,function(d){if(d.uuid==b.uuid){d.shown=!d.shown;return false}})}});SeqView.TM.ActiveTracksGrid=Ext.extend(SeqView.TM.Grid,{getCfgObj:function(){var c=new Ext.ux.dd.GridDragDropRowOrder({scrollable:true,targetCfg:{},listeners:{beforerowmove:function(f,g,e,d){},afterrowmove:function(h,i,g,e){var f=h.grid.tracks;var e=h.grid.getStore().data;var d=0;e.each(function(k){Ext.each(f,function(l){if(l.uuid==k.data.uuid){l.order=d++;return false}})})},startDrag:function(d){d.grid.inDragNDrop=true},endDrag:function(d){delete d.grid.inDragNDrop}}});var b=SeqView.TM.ActiveTracksGrid.superclass.getCfgObj.call(this);b.plugins.push(c);return b},setTracks:function(b){this.tracks=b;this.reloadTracks()}});SeqView.Config=(function(){function b(c){this.m_App=c}return b})();SeqView.Config.prototype={save:function(h){var g=h&&h.callback&&h.callback.success?h.callback.success:function(l){};var c=h&&h.callback&&h.callback.failure?h.callback.failure:function(){};var k=h&&h.callback&&h.callback.scope?h.callback.scope:this;var b=h.config_url||this.m_App.m_CGIs.Config;var f=SeqView.Cookies.UserTracksCookieName;if(this.m_App.m_AppName&&this.m_App.m_AppName.length>0){f+="-"+this.m_App.m_AppName}var d=h.user_config_key||SeqView.UserTracks.get(f,null);if(!h.tracks){g.call(k,this);return}var e={saveconfig:true,tracks:h.tracks,userconfigkey:d};Ext.apply(e,this.visualOptinsUrl());var i=this.m_ReqNum||0;this.m_ReqNum=++i;this.m_App.AjaxRequest({url:b,scope:this,method:"POST",params:e,success:function(l){if(this.m_ReqNum>i){return}var n=Ext.decode(l.responseText);if(n.success===false){c.apply(k,arguments)}else{delete this.m_App.m_TracksFromURL;if(!h.user_config_key){SeqView.UserTracks.set(f,n.userconfigkey)}else{this.userconfigkey=n.userconfigkey}g.call(k,this)}},failure:function(){if(this.m_ReqNum>i){return}c.apply(k,arguments)}})},load:function(k){var h=k&&k.callback&&k.callback.success?k.callback.success:function(r){};var d=k&&k.callback&&k.callback.failure?k.callback.failure:function(){};var p=k&&k.callback&&k.callback.scope?k.callback.scope:this;var c=k.config_url||this.m_App.m_CGIs.Config;var i=k&&k.seqid?k.seqid:this.m_App.GI;var g={id:i};Ext.each([["m_TracksFromURL","tracks"],["m_ViewTheme","theme"],["m_ViewContent","content"],["m_ItemID","itemID"]],function(r){if(this.m_App[r[0]]){g[r[1]]=this.m_App[r[0]]}},this);delete this.m_App.m_ViewContent;var l=k.viewer_context||this.m_App.m_ViewerContext;if(l&&l.length>0){g.viewer_context=l}if(this.TrackConfig&&!k.forcereload){g.notrackconfig=1}if(this.m_App.m_AppName&&this.m_App.m_AppName.length>0){g.appname=this.m_App.m_AppName}if(this.m_App.m_SRZ){g.srz=this.m_App.m_SRZ}if(this.m_App.m_BamPath){g.bam_path=this.m_App.m_BamPath}if(this.m_App.m_DepthLimit){g.depthlimit=this.m_App.m_DepthLimit}if(k.defaultcfg!==true){Ext.apply(g,this.visualOptinsUrl());var f=SeqView.Cookies.UserTracksCookieName;if(this.m_App.m_AppName&&this.m_App.m_AppName.length>0){f+="-"+this.m_App.m_AppName}var e=k.user_config_key||SeqView.UserTracks.get(f,null);if(e){g.userconfigkey=e}var q=k.user_data||this.m_App.m_Key;if(q){g.key=q}}else{var o=SeqView.SessionData.get(SeqView.Cookies.AppDataCookieName,null);g.nocache=1;if(o){g.key=o}if(this.Options&&this.Options.curr_content){g.content=this.Options.curr_content}}var n=this.m_ReqNum||0;this.m_ReqNum=++n;var b=g.key;this.m_App.AjaxRequest({url:c,scope:this,method:"POST",params:g,success:function(r){if(this.m_ReqNum>n){return}var s=Ext.decode(r.responseText);if(s.success===false){if(!this.m_App.m_NoDataCookie&&b){SeqView.SessionData.set(SeqView.Cookies.UserDataCookieName,b)}d.apply(p,arguments)}else{Ext.apply(this,s);h.call(p,this)}},failure:function(){if(this.m_ReqNum>n){return}d.apply(p,arguments)}})},visualOptinsUrl:function(){var b={};if(this.Options){Ext.each(["label","color","decor","spacing","content"],function(d){var c="curr_"+d;if(this.Options[c]&&this.Options[c].length>0){b[d]=this.Options[c]}},this)}return b}};SeqView.App=(function(){var b=[];var e=null;var d=0;function g(k,n){for(var l=0;l<b.length;l++){b[l].doWindowResize(k,n)}}function f(i,l){var n=i;var k=l;if(e){clearTimeout(e);e=null}e=g.defer(100,this,[n,k])}Ext.EventManager.onWindowResize(f);function c(i){if(!i){throw"There should be a div element containing SeqViewer"}var h=Ext.get(i);if(h&&h.dom){h.addClass("SeqViewerApp")}else{throw"A div element containing SeqViewer should have an id attribute"}this.m_DivId=i||"SeqViewer";this.m_DivCtrlId=this.m_DivId+"Controls";this.m_DivJSId=this.m_DivId+"JS";this.m_DivTitle=this.m_DivId+"Title";this.m_DivTitleID=this.m_DivId+"TitleID";this.m_Views=[];this.m_Reflections=null;this.m_MarkersInfo=null;this.m_TextView=null;this.m_Idx=d++;this.m_InitialLoading=false;b.push(this);this.addEvents({panorama_image_loaded:true,graphical_image_loaded:true,marker_created:true,marker_deleted:true,feature_clicked:true,beforeunload:true,origin_changed:true,strand_changed:true,visible_range_changed:true})}c.getApps=function(){return b};c.findAppByIndex=function(h){for(var k=0;k<b.length;++k){if(b[k].m_Idx==h){return b[k]}}return null};c.findAppByDivId=function(k){for(var h=0;h<b.length;++h){if(b[h].m_DivId==k){return b[h]}}return null};c.showLinkURLDlg=function(h){var i=this.findAppByIndex(h);if(i){i.showLinkURLDlg()}};c.showFeedbackDlg=function(h){var i=this.findAppByIndex(h);if(i){i.showFeedbackDlg()}};c.showPrintPageDlg=function(h){var i=this.findAppByIndex(h);if(i){i.showPrintPageDlg()}};return c})();Ext.extend(SeqView.App,Ext.util.Observable,{doWindowResize:function(b,c){if(this.m_BrowWidth!=b){this.loadPanoramaImage();this.forEachView(function(d){d.refresh()});this.m_BrowWidth=b}this.doLayout()},reload:function(c,d){if(this.m_AjaxTrans){Ext.each(this.m_AjaxTrans,function(g){Ext.Ajax.abort(g)});delete this.m_AjaxTrans;this.forEachView(function(g){g.destroy()});this.m_Views=[]}this.forEachView(function(g){g.destroy()});var b=Ext.get(this.m_DivJSId);if(b){b.remove();delete b}b=Ext.get(this.m_DivCtrlId);if(b){b.remove();delete b}if(d!==true){delete this.m_Config}if(this.m_PermConfId){var f=Ext.get(this.m_PermConfId);if(f){var e=f.first();if(e){e.remove()}}}this.load(c)},initLinks:function(){var b="/projects/sviewer/";var c="/projects/sviewer/";if(window.sv_base_url!==undefined){b=sv_base_url}if(window.sv_base_html!==undefined){c=sv_base_html}if(this.m_CGI_URL){b=this.m_CGI_URL}if(b.length>0&&b.charAt(b.length-1)!=="/"){b+="/"}if(c.length>0&&c.charAt(c.length-1)!=="/"){c+="/"}if(this.m_Test){b=""}this.m_CGIs={prefix:b,html_prefix:c,SeqSearch:b+"sv_seqsearch.cgi",FeatSearch:b+"featsearch.cgi",ObjInfo:b+"objinfo.cgi",SvData:b+"sv_data.cgi",Feedback:b+"feedback.cgi",TinyURL:b+"tinyURL.cgi",Config:b+"seqconfig.cgi",Panorama:b+"seqgraphic.cgi",Graphic:b+"seqgraphic.cgi",Alignment:b+"alnmulti.cgi",ObjCoords:b+"objcoords.cgi",Sequenc:b+"seqfeat.cgi",Link:b+"link.cgi"}},preload:function(d){if(d&&d.length>0){if(d[0]!="?"){d="?"+d}var b=Ext.get(this.m_DivId);if(b&&b.dom){var c=b.first();if(c&&c.dom&&c.dom.tagName=="A"){c.dom.search=d}else{el=Ext.DomHelper.createDom({tag:"A",href:d});b.insertFirst(el)}}}this.parseParams();this.initLinks()},finishload:function(){if(!this.m_Config){this.m_Config=new SeqView.Config(this)}this.loadExtraData({scope:this,success:function(){if(this.GI){this.createAndLoadMainPanel()}else{this.requestGI()}}})},load:function(b){this.preload(b);this.finishload()},clearParams:function(){this.GI=null;this.m_From=null;this.m_To=null;this.m_Test=false;this.m_CGI_URL=null;this.m_ViewSearch=null;this.m_Markers=[];this.m_Views=[];this.m_Reflections=null;this.m_MarkersInfo=null;this.m_TextView=null;this.m_ViewMarkers=false;this.m_Key=null;this.m_NAA=null;this.m_BamPath=null;this.m_SRZ=null;this.m_Tracks=null;this.m_DataRID=null;this.m_FindCompartments=true;this.m_DataURL=null;this.m_DataText=[];this.m_NeedAlignmentView=false;this.m_OnlyAlignmentView=false;this.m_DepthLimit=null;this.m_Origin=0;this.m_Flip=false;this.m_ViewLabels=null;this.m_Embedded=false;this.m_SnpFilter=null;this.m_ViewSeq=null;this.m_ViewOptions={};this.m_ViewRanges=[];this.m_ViewColors=[];this.m_ViewsSelect=[];delete this.m_ViewTheme;delete this.m_ViewContent;delete this.m_AppName;delete this.m_Panel;this.m_Panel=null;this.m_ViewParams=null;this.m_ItemID=null;this.m_LocalPrimerTool=false;this.m_LocalBlast=false;this.m_ShowQuery=false;this.m_QueryRange=null;this.m_NoDataCookie=false;this.m_TestRangeSelNoRemove=false;this.m_Toolbar={history:true,name:true,search:true,panning:true,zoom:true,tools:true,config:true,reload:true,help:true}},parseParams:function(){this.clearParams();var b=document.location.href;this.m_AllViewParams=b.split("?")[1];if(this.m_AllViewParams){this.m_AllViewParams=this.m_AllViewParams.replace(/#/,"")}var r=null;var w=Ext.get(this.m_DivId);if(w&&w.dom){var u=w.first();if(u&&u.dom&&u.dom.tagName=="A"){r=u.dom.search.replace(/\?/,"");u.remove()}else{r=w.dom.getAttribute("rel")}}if(r!=null){this.m_AllViewParams=(this.m_AllViewParams===undefined||/embedded=/.test(r))?r:this.m_AllViewParams+"&"+r}this.m_MarkersInfo=new SeqView.MarkersInfo(this);var f=[];var t=[];if(this.m_AllViewParams){var o=this.m_AllViewParams.split("&");for(var n=0;n<o.length;n++){var k=o[n];var c=k.split("=");var d=c[0].toLowerCase();var e=unescape(c[1]);if(d!="key"&&d!="naa"&&d!="tracks"&&d!="mn"&&d!="mk"&&d!="url"&&d!="rid"&&d!="data"&&d!="id"&&d!="content"&&d!="viewer_context"&&d!="snp_filter"&&d!="bam_path"&&d!="theme"){e=e.toLowerCase()}if(d=="id"){this.GI=e}if(d=="f"){this.m_From=e}if(d=="t"){this.m_To=e}if(d=="from"){this.m_From=e}if(d=="to"){this.m_To=e}if(d=="test"&&(e=="1"||e=="true")){this.m_Test=true}if(d=="cgi_url"){this.m_CGI_URL=e}if(d=="_gene"||d=="gene"){this.m_ViewSearch=e}if(d=="m"){f=e.split(",")}if(d=="mn"){t=e.split(",")}if(d=="mk"){this.m_MarkersInfo.parseMarkersURL(this.m_Markers,e)}if(d=="search"){this.m_ViewSearch=e}if(d=="vm"){this.m_ViewMarkers=true}if(d=="key"){this.m_Key=e}if(d=="naa"){this.m_NAA=e}if(d=="bam_path"){this.m_BamPath=e}if(d=="srz"){this.m_SRZ=e}if(d=="depth_limit"){this.m_DepthLimit=e}if(d=="tracks"){this.m_TracksFromURL=e}if(d=="rid"){this.m_DataRID=e}if(d=="find_comp"){this.m_FindCompartments=e=="true"||e=="1"||e=="on"}if(d=="url"){this.m_DataURL=e}if(d=="data"){this.m_DataText.push(decodeURIComponent(e))}if(d=="align"){this.m_NeedAlignmentView=true}if(d=="onlyalign"){this.m_OnlyAlignmentView=true}if(d=="labels"){this.m_ViewLabels=e}if(d=="embedded"){this.m_Embedded=e}if(d=="snp_filter"){this.m_SnpFilter=e}if(d=="origin"){this.m_Origin=parseInt(e)}if(d=="seq"){this.m_ViewSeq=e.split(":")}if(d=="color"){this.m_ViewOptions.color=e.split(",")[0]}if(d=="label"){this.m_ViewOptions.label=e.split(",")[0]}if(d=="decor"){this.m_ViewOptions.decor=e.split(",")[0]}if(d=="spacing"){this.m_ViewOptions.spacing=e.split(",")[0]}if(d=="theme"){this.m_ViewTheme=e.split(",")[0]}if(d=="content"){this.m_ViewContent=e.split(",")[0]}if(d=="v"){this.m_ViewRanges=e.split(",")}if(d=="c"){this.m_ViewColors=e.split(",")}if(d=="gflip"){this.m_Flip=e=="true"||e=="1"}if(d=="flip"||d=="strand"){var h=e.split(",");if(h&&h.length>0){this.m_Flip=h[0]=="true"||h[0]=="1"}}if(d=="select"){this.m_ViewsSelect=e.split(",")}if(d=="itemid"){this.m_ItemID=e}this.m_NoSlider=true;if(d=="noviewheader"){this.m_NoViewHeader=e=="true"||e=="1"}if(d=="viewer_context"){this.m_ViewerContext=e}if(d=="nodatacookie"){this.m_NoDataCookie=e=="true"||e=="1"}if(d=="showquery"){this.m_ShowQuery=e=="true"||e=="1"}if(d=="queryrange"){var h=e.split(":");if(h&&h.length>1){this.m_ShowQuery=true;this.m_QueryRange=[parseInt(h[0]),parseInt(h[1])]}}if(d=="primer"&&location.pathname.indexOf("staff")!=-1){this.m_LocalPrimerTool=e=="true"||e=="1"}if(d=="blast"){this.m_LocalBlast=e=="true"||e=="1"}if(d=="tkey"){this.m_TKey=e}if(d=="appname"&&e&&e.length>0){this.m_AppName=e}if(d=="noconfdlg"){this.m_NoConfDlg=e=="true"||e=="1"}if(d=="toolbar"&&e){this.m_Toolbar={};for(var g=0;g<e.length;g++){switch(e.charAt(g)){case"b":this.m_Toolbar.history=true;break;case"n":this.m_Toolbar.name=true;break;case"s":this.m_Toolbar.search=true;break;case"p":this.m_Toolbar.panning=true;break;case"z":this.m_Toolbar.zoom=true;break;case"t":this.m_Toolbar.tools=true;break;case"c":this.m_Toolbar.config=true;break;case"r":this.m_Toolbar.reload=true;break;case"h":this.m_Toolbar.help=true;break}}}}if(this.m_Embedded&&!this.m_NoDataCookie){if(!this.m_Key){this.m_Key=SeqView.SessionData.get(SeqView.Cookies.UserDataCookieName,null)}else{SeqView.SessionData.set(SeqView.Cookies.UserDataCookieName,this.m_Key)}}}this.m_MarkersInfo.parseMarkersOldStyle(this.m_Markers,f,t);this.m_Portal=r!=null&&this.m_Embedded===false;var q=[];if(this.m_Embedded){var l=Ext.get(this.m_DivId+"_confdlg");if(l){this.m_PermConfId=this.m_DivId+"_confdlg"}q=[{tag:"div",id:this.m_DivJSId}]}else{var s=new Ext.Template('<a onClick="SeqView.App.showLinkURLDlg('+this.m_Idx+');" href="#">Link To This Page</a> | ','<a onClick="SeqView.showHelpDlg();" href="#">Help</a> | ','<a onClick="SeqView.App.showFeedbackDlg('+this.m_Idx+');" href="#">Feedback</a> | ','<a onClick="SeqView.App.showPrintPageDlg('+this.m_Idx+');" href="#">Printer-Friendly Page</a>');q=[{tag:"div",cls:"SeqViewerControls hidden_for_print",id:this.m_DivCtrlId,html:s.apply()},{tag:"br"},{tag:"div",cls:"SeqViewerJS",id:this.m_DivJSId}]}Ext.DomHelper.append(this.m_DivId,q)},getBlastSearchURL:function(){var b=this.m_LocalBlast?"":Ext.ux.NCBI+"/blast/";b+="Blast.cgi?QUERY="+this.GI+"&SV_SHOW=TRUE";if(this.m_Key){b+="&SV_KEY="+this.m_Key}if(this.m_ViewParams.acc_type=="protein"){return b+"&PROGRAM=blastp&BLAST_PROGRAMS=blastp&PAGE_TYPE=BlastSearch&SHOW_DEFAULTS=on"}else{return b+"&PAGE=Nucleotides&PROGRAM=blastn&MEGABLAST=on&BLAST_PROGRAMS=megaBlast&PAGE_TYPE=BlastSearch&SHOW_DEFAULTS=on"}},primerBlast:function(f,g){var h=this.m_ViewParams;if(h.acc_type!=="DNA"){return}if(!f&&(!g||g.length<1||g.length>2)){return}var e=this.m_LocalPrimerTool?"primer-blast/index.cgi?":Ext.ux.NCBI+"/tools/primer-blast/index.cgi?";e+="ORGANISM="+encodeURI(h.organism);e+="&INPUT_SEQUENCE="+encodeURI(h.id);var d;if(f){d=[0,this.m_SeqLength-1]}else{d=g[0]}if(!f&&g.length===2){var c,b;if(g[0][1]<g[1][0]){var c=g[0];var b=g[1]}else{var c=g[1];var b=g[0]}e+="&PRIMER5_END="+(c[1]+1);e+="&PRIMER3_START="+(b[0]+1);d=[c[0],b[1]]}e+="&PRIMER5_START="+(d[0]+1);e+="&PRIMER3_END="+(d[1]+1);e+="&PRIMER_PRODUCT_MAX="+(d[1]-d[0]);e+="&SHOW_SVIEWER=true";if(this.m_Key){e+="&SVIEWER_DATA_KEY="+this.m_Key}window.open(e)},createAndLoadMainPanel:function(){this.createMainPanel();this.loadAccession()},createMainPanel:function(){var e=[{text:"BLAST Search (Whole Sequence)",iconCls:"xsv-blast",scope:this,handler:function(){window.open(this.getBlastSearchURL())}},{text:"Primer BLAST (Whole Sequence)",iconCls:"xsv-primer",scope:this,handler:function(){this.primerBlast(true)}},"-",{text:"GenBank view",scope:this,handler:function(){window.open(Ext.ux.NCBI+"/nuccore/"+this.GI+"?report=genbank")}},{text:"FASTA View",scope:this,handler:function(){window.open(Ext.ux.NCBI+"/nuccore/"+this.GI+"?report=fasta")}}];if(!this.m_PermConfId){e.push("-",{text:"External Data",iconCls:"xsv-ext_data_load",scope:this,handler:function(){this.showTracksConfigDlg(1)}},"-",{text:"Configure",iconCls:"xsv-configure",scope:this,hidden:this.m_NoConfDlg===true,handler:function(){this.showTracksConfigDlg(0)}})}var b=new Ext.menu.Menu({items:e});var d;if(this.m_Embedded===false){var c=[{iconCls:"xsv-new_view",tooltip:"Create New Graphical View",scope:this,handler:function(){var f=new SeqView.Graphic(this);this.registerView(f)}},"-",{iconCls:"xsv-new_fasta",text:"Sequence",tooltip:"Create New Sequence Text View",scope:this,handler:function(){this.createTextView(this.m_Panorama)}},"-",{text:"Load Accession",hidden:this.m_Portal,scope:this,iconCls:"xsv-load-accession",handler:function(){this.loadAccessionDlg()}},{text:"Set Origin",iconCls:"xsv-origin",scope:this,handler:function(){this.showOriginDlg(null)}},"-",{text:"Views & Tools",tooltip:"Views and Tools",iconCls:"xsv-views_tools",menu:b},"->",{text:"Markers",iconCls:"xsv-markers",scope:this,handler:function(){this.showMarkersDlg()}},"-",{xtype:"textfield",id:"sv-goto-box_"+this.m_Idx,emptyText:"Search...",listeners:{specialkey:function(g,h){if(h.getKey()==Ext.EventObject.ENTER){this.showSearchDlg();h.stopEvent()}},scope:this},width:250}];d={title:"Loading...",collapsible:true,renderTo:this.m_DivJSId,bodyStyle:"padding:3px;",html:'<span id="string_ruler_unit"></span>',header:false}}else{d={renderTo:this.m_DivJSId,header:false,border:false,html:'<span id="string_ruler_unit"></span>'}}this.m_BrowWidth=Ext.lib.Dom.getViewWidth();this.m_Panel=new Ext.Panel(d);Ext.fly(this.m_DivId).on({contextmenu:this.onContextMenu,scope:this})},onContextMenu:function(b){b.preventDefault();b.stopPropagation()},requestGI:function(){Ext.get("app-frontpage").setStyle("display","block");var b=Ext.get("mainshow-btn");b.on("click",function(){this.loadAccessionDlg()},this)},loadAccessionDlg:function(){Ext.MessageBox.prompt("Load Accession","Please enter accession or GI:",function(b,c){if(b!="ok"||c.length==0){return}this.redirectWithGi(c)},this,false,this.GI)},redirectWithGi:function(b){var c=this.m_CGIs.prefix+"seqconfig.cgi?id="+(b);this.AjaxRequest({url:c,scope:this,success:function(i){var k=Ext.decode(i.responseText);if(k.error){Ext.MessageBox.show({title:"Sequence Viewer",msg:k.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}else{if(k.success===false){Ext.MessageBox.show({title:"Sequence Viewer",msg:k.msg,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}else{var f=document.location.href.replace(/#/,"");var h=f.split("?");var g=h[1]?h[1].split("&"):[];var d=Ext.each(g,function(l){if(l.substr(0,3)=="id="){return false}});if(d!=undefined){g.remove(g[d])}var e=h[0];e+="?id="+b;if(g.length>0){e+="&"+g.join("&")}document.location.href=e}}}})},showTracksConfigDlg:function(b){SeqView.TM.ShowConfigDialog(this,b)},showTracksConfigPanel:function(b){SeqView.TM.ShowConfigPanel(this,b)},updateConfig:function(d,b,c){this.m_Config.TrackConfig=d.TrackConfig;Ext.apply(this.m_Config.Options,d.Options);this.m_Key=b;this.m_Tracks=c;this.reloadAllViews()},loadAccession:function(){if(!this.GI){return}if(this.m_MarkersInfo){this.m_MarkersInfo.reset()}if(this.m_Reflections){this.m_Reflections.deleteAll()}this.forEachView(function(c){c.remove()});this.m_Views=[];this.m_InitialLoading=true;if(this.m_TKey&&this.m_TKey.length>0){var b={data_action:"downloading",format:"tracks",key:this.m_TKey.toUpperCase()};this.AjaxRequest({url:this.m_CGIs.SvData,params:b,scope:this,success:function(c){var d=Ext.decode(c.responseText);if(d.success===true){this.m_TracksFromURL=d.tracks}delete this.m_TKey;this.m_Config.load({callback:{success:this.infoLoaded,failure:this.infoFailed,scope:this}})},failure:function(c){delete this.m_TKey;this.m_Config.load({callback:{success:this.infoLoaded,failure:this.infoFailed,scope:this}})}})}else{this.m_Config.load({callback:{success:this.infoLoaded,failure:this.infoFailed,scope:this}})}},addURLParams:function(b){var c={};if(this.m_NAA){c.naa=this.m_NAA}if(this.m_BamPath){c.bam_path=this.m_BamPath}if(this.m_SRZ){c.srz=this.m_SRZ}if(this.m_Key){c.key=this.m_Key}if(this.m_Origin!=0){c.origin=this.m_Origin}if(this.m_DepthLimit){c.depthlimit=this.m_DepthLimit}if(this.m_Config){Ext.apply(c,this.m_Config.visualOptinsUrl())}if(b&&b.isGraphic()){if(this.m_Tracks){c.tracks=this.m_Tracks}if(this.m_ViewLabels){c.markers=this.m_ViewLabels}if(this.m_SnpFilter){c.snp_filter=this.m_SnpFilter}}return c},infoFailed:function(b){var c=Ext.decode(b.responseText);if(typeof c=="undefined"||typeof c.success=="undefined"||c.success===false){this.m_Panel.setTitle("Error");this.m_Panel.getEl().insertHtml("afterBegin",c.msg||"seqconfig error")}},infoLoaded:function(d){if(this.m_PermConfId){this.showTracksConfigPanel(0)}this.m_ViewParams=this.m_Config.SeqInfo;this.m_Tracks=SeqView.TM.generateTracksString(SeqView.TM.processTracksInfo(this.m_Config.TrackConfig));if(this.m_Embedded===false){document.title=this.m_ViewParams.id+": "+this.m_ViewParams.title}var q=Ext.get(this.m_DivTitle);if(q){q.update(this.m_ViewParams.title)}var r=Ext.get(this.m_DivTitleID);if(r){r.update(this.m_ViewParams.id_full)}this.m_Panel.setTitle(this.m_ViewParams.id);this.m_SeqLength=this.m_ViewParams.length;var s=this.m_ViewParams.views;var o=[];for(var f=0;f!=s.length;f++){var c=s[f].split(":");if(c[0]=="multialign"){this.m_NeedAlignmentView=true}if(c[0]=="graphical"&&c[1]){o=c[1].split("-")}s[f]=c[0]}Ext.each(["label","color","decor","spacing"],function(i){if(this.m_ViewOptions[i]&&this.m_ViewOptions[i]>0){pidx=this.m_ViewOptions[i];if(pidx>=0&&pidx<this.m_Config.Options.controls[i].length){this.m_Config.Options["curr_"+i]=this.m_Config.Options.controls[i][pidx]}}},this);if(this.m_Embedded===false||this.m_Embedded=="panorama"){this.createPanorama()}var p,n;if(this.m_From&&(this.m_From=="begin"||this.m_From=="begining")){this.m_From=null}if(this.m_To&&this.m_To=="end"){this.m_To=null}if(!this.m_From&&!this.m_To){if(o[0]){p=SeqView.stringToNum(o[0]);n=SeqView.stringToNum(o[1]);m_From=(p+1)+"";m_To=(n+1)+""}else{p=0;n=this.m_SeqLength<10000?this.m_SeqLength-1:this.m_SeqLength>500000?75000:this.m_SeqLength/10}}else{p=this.m_From?SeqView.stringToNum(this.m_From)-1:0;n=this.m_To?SeqView.stringToNum(this.m_To)-1:(this.m_SeqLength<10000?this.m_SeqLength-1:this.m_SeqLength>500000?75000:this.m_SeqLength/10)}if(this.m_QueryRange){var e=Math.round(0.15*(this.m_QueryRange[1]-this.m_QueryRange[0]));this.m_ViewRanges=[Math.max(0,this.m_QueryRange[0]-e)+":"+Math.min(this.m_SeqLength-1,this.m_QueryRange[1]+e)]}if(this.m_ViewRanges.length==1&&this.m_ViewRanges[0].indexOf("begin")!=-1){this.m_ViewRanges=[]}if(this.m_ViewRanges.length==0&&this.m_Embedded!="panorama"){this.m_ViewRanges[0]=(p+1)+":"+(n+1)}if((this.m_OnlyAlignmentView===true&&this.m_Embedded===false)||(this.m_Embedded&&this.m_NeedAlignmentView===true)){var b=new SeqView.Alignment(this);var l=this.m_ViewRanges[0];var g;if(l.indexOf(":")!=-1){g=l.split(":")}if(l.indexOf("..")!=-1){g=l.split("..")}if(l.indexOf("-")!=-1){g=l.split("-")}var h=g[1]=="zs";g=this.decodeRange(g);b.m_FromSeq=g[0];b.m_LenSeq=g[1]-g[0]+1;if(h){b.m_LenSeq-=Math.floor(415*SeqView.MinBpp)}this.registerView(b)}else{for(var f=0;f<this.m_ViewRanges.length;++f){var k=new SeqView.Graphic(this);var l=this.m_ViewRanges[f];var g;if(l.indexOf(":")!=-1){g=l.split(":")}if(l.indexOf("..")!=-1){g=l.split("..")}if(l.indexOf("-")!=-1){g=l.split("-")}var h=g[1]=="zs";g=this.decodeRange(g);k.m_FromSeq=g[0];k.m_LenSeq=g[1]-g[0]+1;k.m_UrlFrom=g[0]?g[0]+1:null;k.m_UrlTo=g[1]?g[1]+1:null;if(this.m_ViewColors.length>f){k.m_Color=this.m_ViewColors[f]}k.setFlipNoReload(this.m_Flip,true);if(this.m_ViewsSelect.length>f&&this.m_ViewsSelect[f]!="null"){k.m_SelectedSig=this.m_ViewsSelect[f]}this.registerView(k);if(f==0&&this.m_NeedAlignmentView&&this.m_Embedded===false){var b=new SeqView.Alignment(this);b.m_FromSeq=g[0];b.m_LenSeq=g[1]-g[0]+1;if(h){b.m_LenSeq-=Math.floor(415*SeqView.MinBpp)}this.registerView(b)}}}if(this.m_ViewSeq&&this.m_ViewSeq.length>0){var p=SeqView.stringToNum(this.m_ViewSeq[0])-1;var n=SeqView.stringToNum(this.m_ViewSeq[1])-1;this.createTextView([p,n,this.m_Flip])}},getToolTipForTrack:function(c){var d=c;if(this.m_Config&&this.m_Config.TrackConfig){var b=this.m_Config.TrackConfig;Ext.each(b,function(e){if(e.Name==c){if(e.Help){d=e.Help}return false}})}return d},notifyViewLoaded:function(c){if(c!=this.m_Panorama){this.fireEvent("graphical_image_loaded",c)}else{this.fireEvent("panorama_image_loaded",c)}if(this.m_InitialLoading){var d=true;this.forEachView(function(f){d=d&&!f.isLoading()});if(d){this.m_InitialLoading=false;if(!this.hasMarkers()){for(var b=0;b!=this.m_Markers.length;b++){this.addMarkerByData(this.m_Markers[b])}}if(this.m_ViewMarkers){this.m_ViewMarkers=false;this.showMarkersDlg()}if(this.m_ViewSearch&&this.m_ViewSearch.length>0){var e=this.m_ViewSearch;this.forEachView(function(f){var g=Ext.getCmp("sv-goto-box_"+f.m_Idx);if(g){g.setValue(e)}});this.openSearchDlg("ok",this.m_ViewSearch)}}if(this.m_Panorama&&this.m_Panorama.getWidth()!=this.m_Panorama.getScreenWidth()){this.m_Panorama.loadImage()}}},moveTo:function(c,b){this.forEachView(function(d){d.moveTo(c,b,{fire_event:false})})},addView:function(c){var b=this.m_Panel.add(c);this.m_Panel.doLayout();return b},doLayout:function(){if(this.m_Panel){this.m_Panel.doLayout()}},viewIsClosing:function(b){},countActiveSeqPanels:function(){var c=0;for(var b=0;b<this.m_Views.length;b++){if(this.m_Views[b]&&this.m_Views[b].m_Type=="graphical"){c++}}return c},removeView:function(b){for(var d=0;d<this.m_Views.length;d++){var c=this.m_Views[d];if(c&&c.m_Idx==b.m_Idx){this.m_Views[d]=null}}this.reCreateReflections()},createPanorama:function(){this.m_Panorama=new SeqView.Panorama(this);this.m_Views.push(this.m_Panorama);this.m_Panorama.loadImage()},loadPanoramaImage:function(){if(this.m_Panel&&this.m_Panorama){this.m_Panorama.loadImage()}},registerView:function(b){this.m_Views.push(b);b.createPanel();this.reCreateReflections()},createTextView:function(b){if(!this.m_TextView){this.m_TextView=new SeqView.TextView(this)}this.m_TextView.openDlg(b)},getPanoramaHeight:function(){return this.m_Panorama?this.m_Panorama.getHeight():0},getPanoramaWidth:function(){return this.m_Panorama?this.m_Panorama.getWidth():0},updateLocator:function(c){if(c.isPanorama()||c.isLoading()){return}var b=c.m_Locator;if(b&&this.m_Panorama){if(!this.m_Panorama.isLoading()){var d=c.toSeq();b.setLeft(this.m_Panorama.toPix(d[0]));b.setWidth(this.m_Panorama.toPix(d[2])-2);b.setHeight(this.getPanoramaHeight()-2)}else{this.updateLocator.defer(50,this,[c])}}},updateViewTitles:function(){this.forEachView(function(b){b.updateTitle()})},findView:function(b){for(var d=0;d<this.m_Views.length;d++){var c=this.m_Views[d];if(c&&c.m_Idx==b){return c}}return null},forEachView:function(f,e){var g=this.m_Views;for(var d=0,b=g.length;d<b;d++){var c=g[d];if(c){if(f.call(e||c,c,d,g)===false){return(d+1)}}}},getFlip:function(){return this.m_Flip},getOrigin:function(){return this.m_Origin},setFlip:function(c,b){this.m_Flip=c;var d=-1;if(typeof b!="undefined"){d=b.m_Idx}this.forEachView(function(e){if(e.isGraphic()&&e.m_Idx!=d){e.setFlipLocal(c)}});this.fireEvent("strand_changed",this,b)},decodeRange:function(c){var e=SeqView.stringToNum(c[0])-1;var d=0;if(!e){e=0}if(e>=this.m_SeqLength){e=0}if(c[1]=="zs"){var b=Math.floor((this.m_Panel.getInnerWidth()-10)*SeqView.MinBpp);d=e+b-1}else{d=SeqView.stringToNum(c[1])-1}if(!d){d=this.m_SeqLength}d=Math.min(d,this.m_SeqLength-1);return[e,d]},parsePosOrRange:function(e,d){var h=e.match(/(-?\d+(?:\.\d+)?[km]?)(?:(?:-|to|\.\.+|:)(-?\d+(?:\.\d+)?[km]?))?/i);if(h==null){return}var g=h.slice(1);if(h[2]==undefined||h[2]==""){g=g.splice(0,1)}var b=this.convertRelativePosition(g[0]);if(g.length==2){var f=this.convertRelativePosition(g[1]);if(this.getFlip()){var c=b;b=f;f=c}if(isNaN(b)||isNaN(f)||b<0||f<0||(d?b>f:b>=f)||b>=this.m_SeqLength||f>=this.m_SeqLength){return}return[b,f]}else{if(isNaN(b)||b<0||b>=this.m_SeqLength){return}return[b]}},convertRelativePosition:function(b){var c=SeqView.stringToNum(b);if(!isNaN(c)){return this.posToGlobal(c)}return c},posToLocal:function(c,b){if(typeof b=="undefined"){b=this.m_Flip}c-=this.m_Origin;if(c>=0){c+=1}if(b){c=-c}return c},posToGlobal:function(b){if(this.m_Flip){b=-b}if(b>0){b-=1}return b+this.m_Origin},newMarkerDlg:function(b,c){if(!this.m_MarkersInfo){this.m_MarkersInfo=new SeqView.MarkersInfo(this)}this.m_MarkersInfo.newMarkerDlg(b,c)},showMarkersDlg:function(){if(!this.m_MarkersInfo){this.m_MarkersInfo=new SeqView.MarkersInfo(this)}this.m_MarkersInfo.showDlg()},updateMarkersSize:function(b){if(this.m_MarkersInfo){this.m_MarkersInfo.updateMarkersSize(b)}},hasMarkers:function(){return this.m_MarkersInfo&&this.m_MarkersInfo.hasMarkers()},updateMarkersPos:function(b){if(this.m_MarkersInfo){this.m_MarkersInfo.updateMarkersPos(b)}},forEachMarker:function(c,b){if(this.m_MarkersInfo){this.m_MarkersInfo.forEachMarker(c,b)}},findMarker:function(b){if(this.m_MarkersInfo){return this.m_MarkersInfo.findMarker(b)}return null},addMarker:function(b){if(!this.m_MarkersInfo){this.m_MarkersInfo=new SeqView.MarkersInfo(this)}this.m_MarkersInfo.addMarker(b)},addMarkerByData:function(b){if(!this.m_MarkersInfo){this.m_MarkersInfo=new SeqView.MarkersInfo(this)}this.m_MarkersInfo.addMarkerByData(b)},scrollMarkers:function(b,c){if(this.m_MarkersInfo){this.m_MarkersInfo.scrollMarkers(b,c)}},updateReflections:function(){if(this.m_Reflections){this.m_Reflections.updateAll()}},scrollReflections:function(b,c){if(this.m_Reflections){this.m_Reflections.scrollPix(b,c)}},reCreateReflections:function(){if(!this.m_Reflections){this.m_Reflections=new SeqView.ReflectionCont(this)}this.m_Reflections.reCreate()},reloadAllViews:function(b){this.forEachView(function(c){c.refresh(b)})},showOriginDlg:function(b){Ext.MessageBox.prompt("Set Origin","Please enter new origin:",function(e,f){if(e!="ok"||f.length==0){return}var d=0;var c=!SeqView.IsNumeric(f);if(!c){d=SeqView.stringToNum(f);if(d>this.m_SeqLength){c=true}}if(c){Ext.MessageBox.show({title:"Set Origin",msg:"Invalid sequence origin.",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});return}d-=1;if(this.m_Origin==d){return}this.m_Origin=d;if(this.m_Origin<0){this.m_Origin=0}this.reloadAllViews();this.fireEvent("origin_changed",this)},this,false,b?b+1:this.m_Origin+1)},setOrigin:function(c,e){var d=e-c.m_ScrollPix;var b=c.pix2Seq(d);this.showOriginDlg(b)},clearOrigin:function(){Ext.MessageBox.confirm("Confirm","Reset Sequence Origin?",function(b){if(b!="yes"||this.m_Origin==0){return}this.m_Origin=0;this.reloadAllViews();this.fireEvent("origin_changed",this)},this)},loadExtraData:function(c){if(!this.m_DataRID&&!this.m_DataURL&&!this.m_DataText.length){if(c&&c.success){c.success.apply(c.scope||this,c.arguments||[])}return}var b={data_action:"uploading"};if(this.GI){b.accession=this.GI}if(this.m_Key){b.key=this.m_Key}if(this.m_BamPath){b.bam_path=this.m_BamPath}if(this.m_SRZ){b.srz=this.m_SRZ}if(this.m_DataRID){b.format="rid";b.rid=this.m_DataRID;if(this.m_FindCompartments){b.find_comp="on"}this.m_DataRID=null}else{if(this.m_DataURL){b.format="url";b.url=this.m_DataURL;this.m_DataURL=null}else{if(this.m_DataText){b.format="text";b["sv-file_format"]="asn text";b.text=this.m_DataText.pop()}}}Ext.MessageBox.show({msg:"Uploading your data, please wait...",title:"Uploading...",width:300,wait:true,waitConfig:{interval:200},icon:"ext-mb-download"});this.AjaxRequest({url:this.m_CGIs.SvData,params:b,scope:this,success:function(f){var h=Ext.decode(f.responseText);this.m_Key=h.key;SeqView.SessionData.set(SeqView.Cookies.UserDataCookieName,this.m_Key);if(b.format=="rid"&&!this.GI){this.GI=h.id;if(!this.m_QueryRange){var e=h.beg;var d=h.end;var k=h.querybeg;var g=h.queryend;if(k!==undefined&&g!==undefined){e=e!==undefined?Math.min(e,k):k;d=d!==undefined?Math.min(d,g):g;if(this.m_ShowQuery){this.m_Markers.push([[k,g],"Query",SeqView.MarkerFlags.SystemLock|SeqView.MarkerFlags.Hollow,"red"])}}if(e!==undefined&&d!==undefined){var i=0.15*(d-e);e=Math.max(0,e-i);d+=i;e=Math.round(e);d=Math.round(d);this.m_ViewRanges=[e+":"+d]}}}Ext.MessageBox.hide();this.loadExtraData(c)},failure:function(d){Ext.MessageBox.hide();if(c&&c.failure){c.failure.apply(c.scope||this,c.arguments||[])}}})},onSyncAlignView:function(b){for(var c=0;c<this.m_Views.length;++c){aview=this.m_Views[c];if(aview&&aview.isAlignment()){aview.loadImage(b.m_VisFromSeq,b.m_VisLenSeq);break}}},getGraphicView:function(){var b=[];this.forEachView(function(c){if(c.isGraphic()){b.push(c)}});return b},AjaxRequest:function(c){if(!this.m_AjaxTrans){this.m_AjaxTrans=[]}c.success=c.success||function(f){};c.failure=c.failure||function(f){};c.params=c.params||{};var d=this.m_AjaxTrans;var b=function(f,g){if(g.params.transId){d.remove(g.params.transId);delete g.params.transId}};c.success=c.success.createInterceptor(b);var e=Ext.Ajax.request(c);if(e){c.params.transId=e;d.push(e)}},getCustomToolTipTools:function(b){if(this.m_CustomSelectionHandler){return this.m_CustomSelectionHandler.getToolTipTools(b)}return null},setCustomSelectionHandler:function(b){this.m_CustomSelectionHandler=b},addCustomFeatureFlags:function(b){if(this.m_CustomSelectionHandler){this.m_CustomSelectionHandler.addCustomFeatureFlags(b)}}});SeqView.PortalSeqGraphicsInfo=function(){var f="from=&to=&itemid=&strand=";if(SeqView.App){var d=SeqView.App.getApps();if(d&&d.length==1){var e=d[0];var c=e.getGraphicView();if(c&&c.length==1){var b=c[0];if(b.m_VisFromSeq>=0&&b.m_VisLenSeq&&b.m_VisLenSeq>0){f="from="+(b.m_VisFromSeq+1)+"&to="+(b.m_VisFromSeq+b.m_VisLenSeq)}else{f="from=&to="}f+="&itemid=";if(e.m_ItemID){f+=e.m_ItemID}if(b.canFlip()){if(b.getFlip()){f+="&strand=true"}else{f+="&strand=false"}}else{f+="&strand="}}}}return f};Ext.apply(SeqView.App.prototype,{showLinkURLDlg:function(){this.getLinkToThisPageURL(function(d,b){var c=new Ext.Window({layout:"form",modal:true,title:"Link To This Page",width:700,autoHeight:true,constrain:true,listeners:{beforeshow:function(e){this.AjaxRequest({url:this.m_CGIs.TinyURL+"?url="+encodeURIComponent(d),success:function(f){var g=Ext.getCmp("the_tinyURL_link");g.setValue(f.responseText)}})},show:function(){if(this.m_Key&&this.m_Key.length>0){Ext.Msg.show({title:"Warning",msg:"This page contains a link to the user loaded data which is kept <br/>inside a temporary storage and will not be available in 1 hour.",icon:Ext.Msg.WARNING,buttons:Ext.Msg.OK})}if(b&&b.length>0){Ext.Msg.show({title:"Warning",msg:"The tracks configuration string for this link is too long and it has been saved<br/>into a temporary storage. It will be kept there for 3 months.",icon:Ext.Msg.WARNING,buttons:Ext.Msg.OK})}},scope:this},resizable:true,resizeHandles:"ew",closeAction:"close",plain:true,items:[{layout:"form",bodyStyle:"padding:5px;",labelWidth:140,frame:true,labelAlign:"right",items:[{xtype:"textarea",height:115,fieldLabel:"Paste link in email or IM",allowBlank:true,width:"97%",value:d,name:"the_link"},{xtype:"textfield",fieldLabel:"Tiny URL",id:"the_tinyURL_link",allowBlank:true,width:"97%",emptyText:"Loading...",value:"",name:"the_tinyURL"}]}],buttons:[{text:"Close",handler:function(){c.close()}}]});c.show()})},getLinkToThisPageURL:function(c){if(!this.m_Tracks||this.m_Tracks.length<1500){this._getLinkToThisPageURL(c)}else{var b={data_action:"uploading",format:"tracks",tracks:this.m_Tracks};this.AjaxRequest({url:this.m_CGIs.SvData,params:b,scope:this,success:function(d){var e=Ext.decode(d.responseText);var f=e.success===true?e.key:null;this._getLinkToThisPageURL(c,f)},failure:function(d){this._getLinkToThisPageURL(c)}})}},_getLinkToThisPageURL:function(n,c){var b=document.location.href.split("?")[0];if(this.m_Portal){b+="?report=graph"}else{b+=("?id="+this.GI);if(this.m_Test){b+="&test=1"}}if(this.m_NoSlider===true){b+="&noslider=1"}if(this.m_Origin!=0){b+="&origin="+this.m_Origin}if(this.m_NAA){b+="&naa="+this.m_NAA}if(this.m_SRZ){b+="&srz="+this.m_SRZ}if(this.m_BamPath){b+="&bam_path="+this.m_BamPath}if(this.m_DepthLimit){b+="&depthlimit="+this.m_DepthLimit}if(this.m_SnpFilter){b+="&snp_filter="+this.m_SnpFilter}if(!c&&this.m_Tracks){b+="&tracks="+this.m_Tracks}if(c){b+="&tkey="+c}if(this.m_Key){b+="&key="+this.m_Key}if(this.m_AppName){b+="&appname="+this.m_AppName}if(this.m_MarkersInfo){b+=this.m_MarkersInfo.getMarkersURL()}if(this.m_ViewerContext){b+="&viewer_context="+this.m_ViewerContext}var h="&v=";var d="&c=";var k="&theme=";var f="&flip=";var l="&select=";var e=0;this.forEachView(function(i){if(!i||!i.isGraphic()){return}if(e!=0){h+=",";d+=",";f+=",";l+=","}if(i.m_UrlFrom&&i.m_UrlTo){h+=i.m_UrlFrom+":"+i.m_UrlTo}else{h+=(i.m_VisFromSeq+1)+":"+(i.m_VisFromSeq+i.m_VisLenSeq)}d+=i.m_Color;f+=i.getFlip();l+=(i.m_SelectedSig?i.m_SelectedSig:"null");e++});var o=this.m_Config.Options;if(o){Ext.each(["color","label","decor","spacing"],function(i){b+="&"+i+"=";idx=o.controls[i].indexOf(o["curr_"+i]);b+=(idx==-1?0:idx)})}var g="&gflip="+this.m_Flip;b+=(h+d+g+l);if(this.m_TextView){b+=this.m_TextView.getURL()}if(this.m_SearchDlg&&this.m_SearchDlg.isVisible()){b+="&search="+Ext.getCmp("sv-goto-box_"+this.m_Idx).getValue().replace(/&/g,"%26")}n.call(this,b,c)},showPreSearchDlg:function(){Ext.MessageBox.prompt("Search","Enter feature name, component name or sequence to search for:",this.openSearchDlg,this,false)},showSearchDlg:function(){var b=Ext.getCmp("sv-goto-box_"+this.m_Idx).getValue();openSearchDlg("ok",b)},openSearchDlg:function(d,c){if(d=="no"||d=="cancel"||d==false){return}var g=c;if(g.length==0){g="*"}if(this.m_SearchDlg){this.m_SearchDlg.close();this.m_SearchDlg=null}var f=function(q,i,p,n){var o="feature";var l=i.m_App.m_CGIs.FeatSearch;switch(q){case"Components":o="component";break;case"Sequence":if(i.m_App.m_ViewParams.acc_type=="protein"){o="protein"}else{o="nucleotide"}l=i.m_App.m_CGIs.SeqSearch;break}this.m_View=i;var k=new Ext.data.Store({url:l,baseParams:{term:p,id:this.m_View.m_App.GI,from:this.m_View.m_FromSeq,to:(this.m_FromSeq+this.m_LenSeq-1),limit:50,whole:1,type:o},autoLoad:true,remoteSort:true,loading:false,reader:new Ext.data.JsonReader({root:"features",totalProperty:"total"},[{name:"label"},{name:"object_id"},{name:"gi"},{name:"from"},{name:"to"},{name:"strand"}]),sortInfo:{field:"label",direction:"asc"},listeners:{beforeload:function(r,s){r.loading=true},load:function(s,r,t){s.loading=false;var w=s.panel.iconCls;var z;if(r.length){z="xsv-search-results"}var u=n.getTabEl(s.panel);if(u){var A=Ext.fly(u);A.child("span.x-tab-strip-text").replaceClass(w,z);A[z?"addClass":"removeClass"]("x-tab-with-icon")}}}});var h=new Ext.grid.GridPanel({title:q,iconCls:"xsv-search-loading",border:false,loadMask:true,stripeRows:true,store:k,first_click:false,cm:new Ext.grid.ColumnModel([{header:"Label",width:110,sortable:true,dataIndex:"label"},{header:"From",width:70,sortable:true,dataIndex:"from",renderer:function(t,s,r){return t+1}},{header:"To",width:70,sortable:true,dataIndex:"to",renderer:function(t,s,r){return t+1}},{header:"Strand",width:70,sortable:true,dataIndex:"strand",renderer:function(t,s,r){return t=="-"?"Negative":"Positive"}}]),viewConfig:{forceFit:true,deferEmptyText:false,emptyText:'<div align="center">No Search Results To Display</div>',templates:{cell:new Ext.Template('<td class="x-grid3-col x-grid3-cell x-grid3-td-{id} x-selectable {css}" style="{style}" tabIndex="0" {cellAttr}>','<div class="x-grid3-cell-inner x-grid3-col-{id}" {attr}>{value}</div>',"</td>")}},autoExpandColumn:"label",listeners:{rowclick:function(r,A,z){if(r.first_click){return false}r.first_click=true;rec=r.getStore().getAt(A);var B=rec.get("from");var C=rec.get("to");var u=C-B+1;var s=B-u*0.15;u*=1.3;if(k.baseParams.type=="component"){if(this.m_View.m_App.m_Tracks&&this.m_View.m_App.m_Tracks.length>0){this.m_View.m_App.m_Tracks+="[key:segment_map_track,name:Contigs][key:segment_map_track,name:Components/Tiling Path]"}else{this.m_View.m_App.m_Tracks="[amend][key:segment_map_track,name:Contigs][key:segment_map_track,name:Components/Tiling Path]"}}var D=rec.get("object_id");var t;if(D){t={sig:D}}else{t={range:[B,C]}}var w=rec.get("strand")=="-";this.m_View.startImageLoading_ext({from:s,len:u,flip:w,sel:t});setTimeout(function(){r.first_click=false},700)},scope:this},bbar:new Ext.PagingToolbar({pageSize:50,store:k,displayInfo:true,displayMsg:"Displaying Search Results {0} - {1} of {2}",emptyMsg:"No Search Results To Display"})});k.panel=h;return h};var b=null;this.forEachView(function(h){if(!b&&h.isGraphic()){b=h}});if(b){var e=new Ext.TabPanel({activeTab:0,listeners:{tabchange:function(h,i){if(i.store.loading&&i.loadMask){i.loadMask.show()}}},buttons:[{text:"Close",scope:this,handler:function(){this.m_SearchDlg.close();this.m_SearchDlg=null}}]});e.add(new f("Features",b,g,e));e.add(new f("Components",b,g,e));e.add(new f("Sequence",b,g,e));this.m_SearchDlg=new Ext.Window({layout:"fit",title:"Search Results",minWidth:480,width:650,height:350,constrain:true,collapsible:true,closeAction:"close",plain:true,items:[e]});this.m_SearchDlg.show()}},showPrintPageDlg:function(){var c=[{xtype:"fieldset",title:" Include in the printer page ",height:24,collapsed:true},{fieldLabel:"",checked:true,bodyStyle:"padding-left:1px;",height:24,labelSeparator:"",boxLabel:"Sequence Title",name:"title"},{fieldLabel:"",checked:true,height:24,labelSeparator:"",boxLabel:"Overview Panel",name:"overview"}];this.forEachView(function(e){if(e.isPanorama()){return}var f='<span style="height:15px,width:20px;background-color:#'+e.m_Color+';">&nbsp;&nbsp;&nbsp;&nbsp;</span>  ';c.push({labelWidth:140,fieldLabel:"",checked:true,height:24,labelSeparator:"",boxLabel:f+e.m_View.title,name:"view_"+e.m_Idx})});if(this.m_TextView&&Ext.get("seq-dlg_"+this.m_Idx)){var b='<span style="height:15px,width:20px;background-color:black;">&nbsp;&nbsp;&nbsp;&nbsp;</span>  ';c.push({fieldLabel:"",checked:true,height:24,labelSeparator:"",boxLabel:b+"Sequence Panel",name:"sequence"})}c.push({xtype:"panel",height:24},{xtype:"fieldset",title:" Page Orientation ",height:24,collapsed:true},{xtype:"radiogroup",columns:1,labelSeparator:"",items:[{boxLabel:"Portrait",height:24,name:"orientation",inputValue:1,checked:true},{boxLabel:"Landscape",height:24,name:"orientation",inputValue:2}]});var d=new Ext.Window({layout:"form",modal:true,title:"Printer-Friendly Page",width:600,autoHeight:true,iconCls:"printer",constrain:true,resizable:false,closeAction:"close",items:[{xtype:"form",bodyStyle:"padding:5px;",labelWidth:Ext.isIE7?50:100,frame:true,defaultType:"checkbox",labelAlign:"right",items:c}],buttons:[{text:"Printer-Friendly Page",scope:this,handler:function(){SeqView.PrinterFriendlyPage(this,d)}},{text:"Cancel",handler:function(){d.close()}}]});d.show()},showFeedbackDlg:function(){this.getLinkToThisPageURL(function(g,c){var d=["Suggestion","Bug Report","Other"];var b=Ext.isIE7?"IE7":Ext.isIE6?"IE6":Ext.isOpera?"Opera":Ext.isSafari2?"Safari2":Ext.isSafari3?"Safari3":Ext.isGecko2?"Gecko2":Ext.isGecko3?"Gecko3":"Other";var f=Ext.isWindows?"Windows":Ext.isMac?"Mac":Ext.isLinux?"Linux":"Other";var e=new Ext.Window({layout:"fit",modal:true,title:"NCBI Graphical sequence Viewer: tell us what you think",width:600,height:360,minWidth:400,minHeight:260,constrain:true,resizable:true,closeAction:"close",items:[{xtype:"form",bodyStyle:"padding:5px;",labelWidth:140,frame:true,url:this.m_CGIs.Feedback,labelAlign:"right",items:[{xtype:"hidden",name:"feedback-browser",value:b},{xtype:"hidden",name:"feedback-os",value:f},{xtype:"hidden",name:"feedback-url",value:g},{xtype:"combo",triggerAction:"all",fieldLabel:"Feedback Type",mode:"local",name:"feedback-type",store:d,allowBlank:false,editable:false,value:d[0]},{xtype:"textfield",fieldLabel:"EMail (Optional)",vtype:"email",allowBlank:true,anchor:"100%",name:"feedback-email"},{xtype:"textarea",fieldLabel:"*Feedback",allowBlank:false,anchor:"100% -50",name:"feedback-text"}]}],buttons:[{text:"Send",handler:function(){var h=e.items.items[0].getForm();if(h.isValid()){h.submit({success:function(i,k){e.close();Ext.MessageBox.show({title:"Feedback",msg:"Thank you! We appreciate your feedback.",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO})}})}}},{text:"Cancel",handler:function(){e.close()}}]});e.show()})}});SeqView.PrinterFriendlyPage=function(i,f){this.values=f.items.items[0].getForm().getValues();var d=this.values.orientation==2?900:650;var e=0;this.generator=window.open("","name","width="+(d+50)+",height=700,toolbar=0,location=0,status=0,menubar=1,resizable=1,scrollbars=1");this.generator.document.write("<html><head><title>"+i.GI+"</title>");this.generator.document.write('<link rel="stylesheet" href="'+i.m_CGIs.prefix+'css/style.css">');var g=false;if(this.values.sequence&&i.m_TextView){if(i.m_TextView.m_HideTrans){g=true;this.generator.document.write("<script>function fixSeqTrans() {");this.generator.document.write('var arr = document.getElementsByTagName("div");');this.generator.document.write("for (var i = 0; i < arr.length; i++) {");if(i.m_TextView.m_HideTrans==1){this.generator.document.write('if (arr[i].className.indexOf("seqtrans_trans") == 0) {')}else{if(i.m_TextView.m_HideTrans==2){this.generator.document.write('if (arr[i].className.indexOf("seqtrans_prot") == 0) {')}else{if(i.m_TextView.m_HideTrans==3){this.generator.document.write('if (arr[i].className.indexOf("seqtrans") == 0) {')}}}this.generator.document.write('arr[i].style.display = "none";');this.generator.document.write("}}}<\/script>")}}this.generator.document.write('</head><body onLoad="'+(g?"fixSeqTrans();":"")+'window.print()">');if(this.values.title){this.generator.document.write("<p><b>"+i.m_ViewParams.title+"</b></p>");this.generator.document.write("<p>"+i.m_ViewParams.id_full+"</p>")}this.ondataloadcalled=false;this.running_requests=0;this.overview_data=null;if(this.values.overview){var h={theme:"NCBI Overview",id:i.GI,width:d};Ext.apply(h,i.addURLParams());this.running_requests++;i.AjaxRequest({url:i.m_CGIs.Panorama,params:h,scope:this,success:function(k){var l=Ext.decode(k.responseText);this.overview_data=l;this.running_requests--;this.onDataLoaded()}})}var c=0;this.views_data=[];i.forEachView(function(k){if(k.isPanorama()){return}if(!this.values["view_"+k.m_Idx]){return}var l={data_idx:c,id:i.GI,minheight:220,width:d,from:k.m_VisFromSeq,len:k.m_VisLenSeq};Ext.apply(l,k.addURLParams());if(k.isAlignment()){l.view="aln";l.client="assmviewer";b+="&view=aln&client=assmviewer";if(k.m_Expand.length>0){l.expand=k.m_Expand}}else{l.client="seqviewer";if(k.m_SelectedSig){l.select=k.m_SelectedSig}if(k.getFlip()){l.flip="true"}}this.views_data[c]={view:k};this.running_requests++;i.AjaxRequest({url:i.m_CGIs.Graphic,scope:this,params:l,success:function(n,p){var o=Ext.decode(n.responseText);this.views_data[p.params.data_idx].data=o;this.running_requests--;this.onDataLoaded()}});c++},this);this.text_data=null;if(this.values.sequence&&i.m_TextView){this.col_tmp=i.m_TextView.m_SequenceCols;i.m_TextView.m_SequenceCols=this.values.orientation==2?(Ext.isWindows?100:110):(Ext.isWindows?70:80);var b=i.m_TextView.getSeqTextURL();this.running_requests++;i.AjaxRequest({url:b,scope:this,success:function(k){var l=Ext.decode(k.responseText);this.text_data=l;this.running_requests--;this.onDataLoaded()}})}if(this.ondataloadcalled===false&&this.running_requests==0){this.generator.document.write("</body></html>");this.generator.document.close()}this.onDataLoaded=function(){this.ondataloadcalled=true;if(this.running_requests!=0){return}if(this.overview_data){this.generator.document.write('<img style="border:1px solid;" src="'+this.overview_data.img_url+'">')}var l='<div style="position:absolute;top:2px;width:16px;height:16px;left:{left}px;"><div class="marker_label" style="{font_size}border:1px {color} solid;color:black;">{trimmed_label}</div><div class="marker_line" style="border-right:1px solid {color}; height:{height}px;"></div></div>';Ext.each(this.views_data,function(s){var o=s.view;var q=s.data;this.generator.document.write("<br><br>"+o.m_View.title+"<br>");var p='<div style="position:relative;">';var r=0;if(i.m_MarkersInfo){i.m_MarkersInfo.forEachMarker(function(A){if(A.seq_pos>o.m_VisFromSeq&&A.seq_pos<(o.m_VisFromSeq+o.m_VisLenSeq-1)){var z=q.len/d;var B=0;if(o.getFlip()){B=(q.len-(A.seq_pos-q.from)-1+0.5)/z-8}else{B=(A.seq_pos+0.5-q.from)/z-8}var u={color:A.color,left:B,height:q.h+4,num:e,trimmed_label:A.marker_name.trimToPix(100),font_size:"font-size:0.95em;"};e+=1;var t=new Ext.Template(l);var w=t.applyTemplate(u);p+=w}});r=21}p+='<img style="border: 1px solid;margin-top:'+r+'px;" src="'+q.img_url+'"></div>';this.generator.document.write(p)},this);if(this.text_data){this.generator.document.write("<br><br>Sequence View<br>");var k=i.m_TextView.genTopNumbers();var n=SeqView.TextView.getViewTmpl().apply({border:1,width:d,left_nums:this.text_data.starts,top_nums:k,id:i.m_Idx,sequence:this.text_data.sequence});this.generator.document.write(n);i.m_TextView.m_SequenceCols=this.col_tmp}this.generator.document.write("</body></html>");this.generator.document.close()}};Ext.onReady(function(){var b=Ext.query("div[class=SeqViewerApp]");if(b.length==0){console.log("No country for SeqViewerApp - it is not created");return}for(var c=0;c<b.length;c++){var d=new SeqView.App(b[c].id);d.load()}});